<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Physical Process Models | Quantitative Environmental Methods: LRES 546</title>
  <meta name="description" content="Chapter 5 Physical Process Models | Quantitative Environmental Methods: LRES 546" />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Physical Process Models | Quantitative Environmental Methods: LRES 546" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Physical Process Models | Quantitative Environmental Methods: LRES 546" />
  
  
  

<meta name="author" content="Tim Covino &amp; Lauren Kremer" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="model-classification-and-application.html"/>
<link rel="next" href="spatial-models-and-gis-integration.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">lres_546</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Part 1: Foundations of Environmental Modeling</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#course-overview-and-objectives"><i class="fa fa-check"></i><b>1.2</b> Course overview and objectives</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#course-description"><i class="fa fa-check"></i><b>1.3</b> Course Description</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#structure"><i class="fa fa-check"></i><b>1.4</b> Structure</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#philosophical-approach-and-resources"><i class="fa fa-check"></i><b>1.5</b> Philosophical approach and resources</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#tentative-schedule-subject-to-change"><i class="fa fa-check"></i><b>1.6</b> Tentative schedule, subject to change</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><i class="fa fa-check"></i><b>2</b> Fundamentals of Hydrological Analysis - Physical Hydrology and Empirical Methods</a>
<ul>
<li class="chapter" data-level="2.1" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#hydrograph-separation"><i class="fa fa-check"></i><b>2.1</b> Hydrograph separation</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#learning-module-1"><i class="fa fa-check"></i><b>2.1.1</b> Learning Module 1</a></li>
<li class="chapter" data-level="2.1.2" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#labwork-20-pts"><i class="fa fa-check"></i><b>2.1.2</b> Labwork (20 pts)</a></li>
<li class="chapter" data-level="2.1.3" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#repo-link"><i class="fa fa-check"></i><b>2.1.3</b> Repo link</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#return-intervals"><i class="fa fa-check"></i><b>2.2</b> Return Intervals</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#learning-module-2"><i class="fa fa-check"></i><b>2.2.1</b> Learning Module 2</a></li>
<li class="chapter" data-level="2.2.2" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#labwork-20-pts-1"><i class="fa fa-check"></i><b>2.2.2</b> Labwork (20 pts)</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#rational-method-and-nrcs-curve-number-20-pts"><i class="fa fa-check"></i><b>2.3</b> Rational method and NRCS curve number (20 pts)</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#learning-module-3"><i class="fa fa-check"></i><b>2.3.1</b> Learning Module 3</a></li>
<li class="chapter" data-level="2.3.2" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#labwork-20-pts-2"><i class="fa fa-check"></i><b>2.3.2</b> Labwork (20 pts)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="process-based-modeling---probabilistic-and-process-simulation.html"><a href="process-based-modeling---probabilistic-and-process-simulation.html"><i class="fa fa-check"></i><b>3</b> Process-Based Modeling - Probabilistic and Process Simulation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="process-based-modeling---probabilistic-and-process-simulation.html"><a href="process-based-modeling---probabilistic-and-process-simulation.html#transfer-function-rainfall-runoff-models"><i class="fa fa-check"></i><b>3.1</b> Transfer function rainfall-runoff models</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="process-based-modeling---probabilistic-and-process-simulation.html"><a href="process-based-modeling---probabilistic-and-process-simulation.html#learning-module-4"><i class="fa fa-check"></i><b>3.1.1</b> Learning Module 4</a></li>
<li class="chapter" data-level="3.1.2" data-path="process-based-modeling---probabilistic-and-process-simulation.html"><a href="process-based-modeling---probabilistic-and-process-simulation.html#repo-link-1"><i class="fa fa-check"></i><b>3.1.2</b> Repo link</a></li>
<li class="chapter" data-level="3.1.3" data-path="process-based-modeling---probabilistic-and-process-simulation.html"><a href="process-based-modeling---probabilistic-and-process-simulation.html#labwork-20-pts-3"><i class="fa fa-check"></i><b>3.1.3</b> Labwork (20 pts)</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="process-based-modeling---probabilistic-and-process-simulation.html"><a href="process-based-modeling---probabilistic-and-process-simulation.html#monte-carlo-simulation"><i class="fa fa-check"></i><b>3.2</b> Monte Carlo Simulation</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="process-based-modeling---probabilistic-and-process-simulation.html"><a href="process-based-modeling---probabilistic-and-process-simulation.html#learning-module-5"><i class="fa fa-check"></i><b>3.2.1</b> Learning Module 5</a></li>
<li class="chapter" data-level="3.2.2" data-path="process-based-modeling---probabilistic-and-process-simulation.html"><a href="process-based-modeling---probabilistic-and-process-simulation.html#repo-link-2"><i class="fa fa-check"></i><b>3.2.2</b> Repo link</a></li>
<li class="chapter" data-level="3.2.3" data-path="process-based-modeling---probabilistic-and-process-simulation.html"><a href="process-based-modeling---probabilistic-and-process-simulation.html#labwork-20-pnts"><i class="fa fa-check"></i><b>3.2.3</b> Labwork (20 pnts)</a></li>
<li class="chapter" data-level="3.2.4" data-path="process-based-modeling---probabilistic-and-process-simulation.html"><a href="process-based-modeling---probabilistic-and-process-simulation.html#sensitivity-analysis"><i class="fa fa-check"></i><b>3.2.4</b> Sensitivity analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="model-classification-and-application.html"><a href="model-classification-and-application.html"><i class="fa fa-check"></i><b>4</b> Model Classification and Application</a>
<ul>
<li class="chapter" data-level="4.1" data-path="model-classification-and-application.html"><a href="model-classification-and-application.html#classifying-model-structure"><i class="fa fa-check"></i><b>4.1</b> Classifying model structure</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="model-classification-and-application.html"><a href="model-classification-and-application.html#learning-module-6"><i class="fa fa-check"></i><b>4.1.1</b> Learning Module 6</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="model-classification-and-application.html"><a href="model-classification-and-application.html#term-project-assignment-1---10-pnts"><i class="fa fa-check"></i><b>4.2</b> Term Project Assignment 1 - 10 pnts</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="model-classification-and-application.html"><a href="model-classification-and-application.html#brainstorming"><i class="fa fa-check"></i><b>4.2.1</b> Brainstorming</a></li>
<li class="chapter" data-level="4.2.2" data-path="model-classification-and-application.html"><a href="model-classification-and-application.html#data-exploration-and-selection"><i class="fa fa-check"></i><b>4.2.2</b> Data exploration and selection</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="physical-process-models.html"><a href="physical-process-models.html"><i class="fa fa-check"></i><b>5</b> Physical Process Models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="physical-process-models.html"><a href="physical-process-models.html#snowmelt-models"><i class="fa fa-check"></i><b>5.1</b> Snowmelt Models</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="physical-process-models.html"><a href="physical-process-models.html#learning-module-7"><i class="fa fa-check"></i><b>5.1.1</b> Learning Module 7</a></li>
<li class="chapter" data-level="5.1.2" data-path="physical-process-models.html"><a href="physical-process-models.html#labwork-20-pnts-1"><i class="fa fa-check"></i><b>5.1.2</b> Labwork (20 pnts)</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="physical-process-models.html"><a href="physical-process-models.html#evapotranspiration"><i class="fa fa-check"></i><b>5.2</b> Evapotranspiration</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="physical-process-models.html"><a href="physical-process-models.html#repo-here"><i class="fa fa-check"></i><b>5.2.1</b> Repo here</a></li>
<li class="chapter" data-level="5.2.2" data-path="physical-process-models.html"><a href="physical-process-models.html#learning-module-8"><i class="fa fa-check"></i><b>5.2.2</b> Learning Module 8</a></li>
<li class="chapter" data-level="5.2.3" data-path="physical-process-models.html"><a href="physical-process-models.html#labwork-20-pts-4"><i class="fa fa-check"></i><b>5.2.3</b> Labwork (20 pts):</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="physical-process-models.html"><a href="physical-process-models.html#hbv-hydrology-model"><i class="fa fa-check"></i><b>5.3</b> HBV Hydrology Model</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="physical-process-models.html"><a href="physical-process-models.html#learning-module-9"><i class="fa fa-check"></i><b>5.3.1</b> Learning Module 9</a></li>
<li class="chapter" data-level="5.3.2" data-path="physical-process-models.html"><a href="physical-process-models.html#repo-link-3"><i class="fa fa-check"></i><b>5.3.2</b> Repo link</a></li>
<li class="chapter" data-level="5.3.3" data-path="physical-process-models.html"><a href="physical-process-models.html#labwork-20-pnts-2"><i class="fa fa-check"></i><b>5.3.3</b> Labwork (20 pnts)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html"><i class="fa fa-check"></i><b>6</b> Spatial Models and GIS Integration</a>
<ul>
<li class="chapter" data-level="6.1" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#gridded-and-tabular-data-retrieval"><i class="fa fa-check"></i><b>6.1</b> Gridded and tabular data retrieval</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#learning-module-9-1"><i class="fa fa-check"></i><b>6.1.1</b> Learning Module 9</a></li>
<li class="chapter" data-level="6.1.2" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#repo-link-4"><i class="fa fa-check"></i><b>6.1.2</b> Repo link</a></li>
<li class="chapter" data-level="6.1.3" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#labwork-20-pnts-3"><i class="fa fa-check"></i><b>6.1.3</b> Labwork (20 pnts)</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#dem-processing"><i class="fa fa-check"></i><b>6.2</b> DEM processing</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#learning-module-10"><i class="fa fa-check"></i><b>6.2.1</b> Learning Module 10</a></li>
<li class="chapter" data-level="6.2.2" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#the-link-to-the-repo-is-here"><i class="fa fa-check"></i><b>6.2.2</b> THE LINK TO THE REPO IS HERE</a></li>
<li class="chapter" data-level="6.2.3" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#labwork-20-pts-5"><i class="fa fa-check"></i><b>6.2.3</b> Labwork (20 pts)</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Quantitative Environmental Methods: LRES 546</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="physical-process-models" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Chapter 5</span> Physical Process Models<a href="physical-process-models.html#physical-process-models" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="snowmelt-models" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Snowmelt Models<a href="physical-process-models.html#snowmelt-models" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="learning-module-7" class="section level3 hasAnchor" number="5.1.1">
<h3><span class="header-section-number">5.1.1</span> Learning Module 7<a href="physical-process-models.html#learning-module-7" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="background-1" class="section level4 hasAnchor" number="5.1.1.1">
<h4><span class="header-section-number">5.1.1.1</span> Background:<a href="physical-process-models.html#background-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Understanding snowmelt runoff is crucial for managing water resources and assessing flood risks, as it plays a significant role in the hydrologic cycle. Annual runoff and peak flow are influenced by snowmelt, rainfall, or a combination of both. In regions with a snowmelt-driven hydrologic cycle, such as the Rocky Mountains, snowpack acts as a natural reservoir, storing water during the winter months and releasing it gradually during the spring and early summer, thereby playing a vital role in maintaining water availability for various uses downstream. By examining how snowmelt interacts with other factors like precipitation, land cover, and temperature, we can better anticipate water supply fluctuations and design effective flood management strategies.</p>
<p>Learning objectives:</p>
<p>In this module, our primary focus will be modeling snowmelt as runoff, enabling us to predict when it will impact streamflow timing. We will consider some factors that may influence runoff timing. However, the term ‘snowmelt modeling’ is a field in itself and can represent a lifetime worth of work. There are many uses for snowmelt modeling (e.g., climate science and avalanche forecasting). If you are interested in exploring more on this subject, there is an excellent Snow Hydrology: Focus on Modeling series offered by <a href="https://www.cuahsi.org" target="_blank">CUAHSI’s</a> Virtual University on YouTube.</p>
<p>Helpful terms:</p>
<p>The most common way to measure the water content of the snowpack is by the Snow Water Equivalent or <strong>SWE</strong>. The SWE is the water depth resulting from melting a unit column of the snowpack.</p>
</div>
<div id="model-approaches" class="section level4 hasAnchor" number="5.1.1.2">
<h4><span class="header-section-number">5.1.1.2</span> Model Approaches<a href="physical-process-models.html#model-approaches" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Similar to the model development structure we discussed in the last module, snowmelt models are generally classified into three different types of <a href="https://nsidc.org/learn/cryosphere-glossary/ablation#:~:text=Ice%20Data%20Center-,ablation,melting%2C%20evaporation%2C%20wind%20and%20avalanches" target="_blank">abalation</a> algorithms</p>
<p><strong>Empirical and Data-Driven Models:</strong>
These models use historical data and statistical techniques to predict runoff based on the relationship between snow characteristics (like snow area) and runoff. They use past patterns to make predictions about the future. The emergence of data-driven models has benefited from the growth of massive data and the rapid increase in computational power. These models simulate the changes in snowmelt runoff using machine learning algorithms to select appropriate parameters (e.g., daily rainfall, temperature, solar radiation, snow area, and snow water equivalent) from different data sources.</p>
<p><strong>Conceptual Models:</strong>
These models simplify the snowmelt process by establishing a simple, rule-based relationship between snowmelt and temperature. These models use a basic formula based on temperature to estimate how much snow will melt.</p>
<p><strong>Physical Models:</strong>
The physical snowmelt models calculate snowmelt based on the energy balance of snow cover. If all the heat fluxes toward the snowpack are considered positive and those away are considered negative, the sum of these fluxes is equal to the change in heat content of the snowpack for a given time period. Fluxes considered may be</p>
<ul>
<li>net solar radiation (solar incoming minus albedo),</li>
<li>thermal radiation,</li>
<li>sensible heat transfer of air (e.g., when air is a different temperature than snowpack),</li>
<li>latent heat of vaporization from condensation or evaporation/sublimation,
heat conducted from the ground,</li>
<li>advected heat from precipitation</li>
</ul>
<p>examples: layered snow thermal model (SNTHERM) and physical snowpack model (SNOWPACK),</p>
<p>Many effective models may incorporate elements from some or all of these modeling approaches.</p>
</div>
<div id="spatial-complexity-1" class="section level4 hasAnchor" number="5.1.1.3">
<h4><span class="header-section-number">5.1.1.3</span> Spatial complexity<a href="physical-process-models.html#spatial-complexity-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We may also identify models based on the model architecture or spatial complexity. The architecture can be designed based on assumptions about the physical processes that may affect the snowmelt to runoff volume and timing.</p>
<p><strong>Homogenous basin modeling:</strong> You may also hear these types of models referred to as ‘black box’ models. Black-box models do not provide a detailed description of the underlying hydrological processes. Instead, they are typically expressed as empirical models that rely on statistical relationships between input and output variables. While these models can predict specific outcomes effectively, they may not be ideal for understanding the physical mechanisms that drive hydrological processes. In terms of snow cover, this is a simplistic case model where we assume:</p>
<ul>
<li>the snow is consistent from top to bottom of the snow column and across the watershed</li>
<li>melt appears at the top of the snowpack</li>
<li>water immediately flows out the bottom</li>
</ul>
<p>This type of modeling may work well if the snowpack is isothermal, if we are interested in runoff over large timesteps, or if we are modeling annual water budgets in lumped models.</p>
<p><strong>Vertical layered modeling:</strong> Depending on the desired application of the model, snowmelt may be modeled in multiple layers in the snow column (air-snow surface to ground). Climate models, for example, may estimate phase changes or heat flux and consider the snowpack in 5 or more layers. Avalanche forecasters may need to consider grain evolution, density, water content, and more over hundreds of layers! Hydrologists may also choose variable layers, but many will choose single- or two-layer models for basin-wide studies, as simple models can be effective when estimating basin runoff. <a href="https://journals.ametsoc.org/view/journals/hydr/13/2/jhm-d-11-072_1.xml">Here</a> is a study by Dutra et al. (2012) that looked at the effect of the number of snow layers, liquid water representation, snow density, and snow albedo parameterizations within their tested models. Table 1 and figures 1-3 will be sufficient to understand the effects of changes to these parameters on modeled runoff and SWE. In this case, the three-layer model performed best when predicting the timing of the SWE and runoff, but density improved more by changing other parameters rather than layers (Figure 1).</p>
<p><strong>Lateral spatial heterogeneity:</strong>
The spatial extent of the snow cover determines the area contributing to runoff at any given time during the melt period. The more snow there is, the more water there will be when it melts. Therefore, snow cover tells us which areas will contribute water to rivers and streams as the snow melts.
In areas with a lot of accumulated snow, the amount of snow covering the ground gradually decreases as the weather warms up. This melting process can take several months. How quickly the snow disappears depends on the landscape. For example, in mountainous ecosystems, factors like elevation, slope aspect, slope gradient, and <a href="https://repository.library.noaa.gov/view/noaa/45144" target="_blank">forest structure</a> affect how the snow can accumulate, evaporate or sublimate and how quickly the snow melts.</p>
<p>For mountain areas, similar patterns of depletion occur from year to year and can be related to the snow water equivalent (SWE) at a site, accumulated ablation, accumulated degree-days, or to runoff from the watershed using depletion curves from historical data. <a href="https://www.mdpi.com/2076-3263/8/12/484#:~:text=Snow%20depletion%20curves%20(SDC)%20are,snow%20depth%20or%20water%20equivalent" target="_blank">Here</a> is an example of snow depletion curves developed using statistical modeling and remotely sensed data. The use of remotely sensed data can be incredibly helpful to providing estimates in remote areas with infrequent measurements.
Observing depletion patterns may not be effective in ecosystems where patterns are more variable (e.g., prairies). However, stratified sampling with snow surveys, snow telemetry networks (SNOTEL) or continuous precipitation measurements can be used with techniques like <a href="https://hess.copernicus.org/articles/27/3525/2023/" target="&quot;_blank">cluster analyses</a> or interpolation, to determine variables that influence SWE and estimate SWE depth or runoff over heterogeneous systems.</p>
<p>You can further explore all readings linked in the above section. These readings may assist in developing the workflow for your term project, though they are optional for completing this assignment. However, it is recommended that you review the figures to grasp the concepts and retain them for future reference if necessary.</p>
</div>
<div id="model-choices-my-snow-is-different-from-your-snow" class="section level4 hasAnchor" number="5.1.1.4">
<h4><span class="header-section-number">5.1.1.4</span> Model choices: My snow is different from your snow<a href="physical-process-models.html#model-choices-my-snow-is-different-from-your-snow" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>When determining the architecture of your snow model, your model choices will reflect the application of your model and the processes you are trying to represent. Recall that parsimony and simplicity often make for the most effective models. So, how do we know if we have a good model? Here are a few things we can check to validate our model choices:</p>
<p><strong>Model Variability:</strong> A good model should produce consistent results when given the same inputs and conditions. Variability between model runs should be minimal if the watershed or environment is not changing.</p>
<p><strong>Versatility:</strong> Check the model under a range of scenarios different from the conditions under which it was developed. The model should apply to similar systems or scenarios beyond the initial scope of development</p>
<p><strong>Sensitivity Analysis:</strong> We reviewed this a bit in the Monte Carlo module. How do changes in model inputs impact outputs? A good model will show reasonable sensitivity changes in input parameters, with outputs responding as expected.</p>
<p><strong>Validation with empirical data:</strong> Comparison with real-world data checks whether the model accurately represents the actual system</p>
<p><strong>Applicability and simplicity:</strong> A good model should provide valuable insights or aid in decision-making processes relevant to the problem it addresses. It strikes a balance between complexity and simplicity, avoiding unnecessary intricacies that can lead to overfitting or computational inefficiency while sufficiently capturing the system’s complexities.</p>
</div>
</div>
<div id="labwork-20-pnts-1" class="section level3 hasAnchor" number="5.1.2">
<h3><span class="header-section-number">5.1.2</span> Labwork (20 pnts)<a href="physical-process-models.html#labwork-20-pnts-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="download-the-repo-for-this-lab-here" class="section level4 hasAnchor" number="5.1.2.1">
<h4><span class="header-section-number">5.1.2.1</span> <a href="https://github.com/tpcovino/06_snowmelt_models.git" target="_blank">Download the repo for this lab HERE</a><a href="physical-process-models.html#download-the-repo-for-this-lab-here" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>In this module, we will simulate snowmelt in a montane watershed in central Colorado with a simple temperature model. The Fool Creek watershed is located in the Fraser Experimental Forest (FEF), 137 km west of Denver, Colorado. The FEF contains several headwater streams (Strahler order 1-3) within the Colorado Headwaters watershed which supplies much of the water to the populated Colorado Front Range. This Forest has been the site of many studies to evaluate the effects of land cover change on watershed hydrology. The Fool Creek is a small, forested headwater stream, with an approximate watershed area of 2.75 km^2. The watershed elevation ranges from approximately 2,930m (9,600ft) at the USFS monitoring station to 3,475m (11,400ft) at the highest point. There is a SNOTEL station located at 3,400m.</p>
<p>We will refer to data from the SNOTEL station as ‘high elevation’ or ‘upper watershed’ data. Data collected from the outlet may be referred to as ‘low elevation’, ‘lower watershed’ or ‘outlet’ data.</p>
<div class="float">
<img src="images/fool_studyarea.png" alt="Fool Creek delineated watershed" />
<div class="figcaption">Fool Creek delineated watershed</div>
</div>
<p>Let’s look at some data for Fool Creek:</p>
<p>This script collects <a href="https://www.nrcs.usda.gov/wps/portal/wcc/home/aboutUs/monitoringPrograms/automatedSnowMonitoring/" target="_blank">SNOTEL</a> input data using snotelr. The SNOTEL automated collection site in Fool Creek supplies SWE data that can simplify our runoff modeling. Lets explore the sites available through snotelr and select the site of interest.</p>
</div>
<div id="import-data" class="section level4 hasAnchor" number="5.1.2.2">
<h4><span class="header-section-number">5.1.2.2</span> Import data:<a href="physical-process-models.html#import-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>First, we will generate a conceptual runoff model using the date, daily mean temperature, SWE depth in mm, and daily precipitation (mm) data from the SNOTEL station. We will use select() to keep the desired columns only. Then we will use mutate() to add a water year, and group_by() to add a cumulative precipitation column for each water year.</p>
<p>We will also download flow data collected by USFS at the Fool Creek outlet at 2,930m to compare to simulated runoff.</p>
<p>Let’s look at the data for the SNOTEL station at 3400m in elevation.</p>
</div>
<div id="calculate-liquid-input" class="section level4 hasAnchor" number="5.1.2.3">
<h4><span class="header-section-number">5.1.2.3</span> Calculate liquid input<a href="physical-process-models.html#calculate-liquid-input" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>to the ground by analyzing the daily changes in Snow Water Equivalent (SWE) and precipitation. This script incorporates temperature conditions to determine when to add changes to liquid input.</p>
<p>Let’s visualize the timing disparities between precipitation and melt input in relation to discharge.</p>
</div>
<div id="modeling-swe" class="section level4 hasAnchor" number="5.1.2.4">
<h4><span class="header-section-number">5.1.2.4</span> Modeling SWE<a href="physical-process-models.html#modeling-swe" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Now we are going to shift focus. Instead of modeling runoff, let’s assume we have precipitation data from 3400m (SNOTEL, upper watershed) in the Fool Creek watershed, but no SWE data. How could we model SWE using temperature data?</p>
<p>Next, we will create a model to estimate SWE and then compare the results to the actual SWE data from the SNOTEL station in the upper Fool watershed.</p>
<p>The model below is a variation of the <a href="https://www.researchgate.net/publication/229698275_Revisiting_the_Degree-day_Method_for_Snowmelt_Computations" target="_blank">degree-day method</a>.
In this simulation, temperature determines whether precipitation contributes to snowpack or becomes rain. When temperatures fall below a certain threshold and precipitation occurs, that amount is added to the snow water equivalent (SWE) accumulation.</p>
<p>To find the optimal parameters for the upper watershed, we will run 100 Monte Carlo simulations and analyze the results. The key parameters we are testing include: <br>
Pack threshold – The SWE level at which melting begins. <br>
Degree-day factor – The rate at which snow melts per degree above freezing. <br>
Threshold temperature – The temperature that separates snow from rain.<br>
By adjusting these parameters, we aim to refine our model and improve its accuracy in simulating snowpack dynamics.</p>
<p>This simple model seems to simulate SWE well if assessed with the NSE.</p>
<p>Let’s go through the procedure again, but this time we’ll model SWE at the Fool Creek outlet (lower elevation), where we (really) don’t have daily SWE data. First, we’ll import the precipitation data collected from a USFS meteorological station near the Fool Creek outlet.</p>
<p>We also need temperature data. This is also collected at the USFS Lower Fool meteorological station.</p>
<p>Even though this meteorological station is fairly close to the SNOTEL station, the sites differ in elevation. Lets compare the observed cumulative precipitation between the upper watershed and the lower.</p>
<p>Now let’s estimate SWE for the Lower Fool Creek.
Again, we’ll just simulate a single year.</p>
<p>Run another set of simulations and compare the values of the best performing parameters across sites.</p>
<p>Since we don’t have SWE measurement for Lower Fool Creek, let’s see how the simulated values for the lower watershed compare to the observed SWE from the high elevation SNOTEL station.</p>

</div>
</div>
</div>
<div id="evapotranspiration" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Evapotranspiration<a href="physical-process-models.html#evapotranspiration" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="repo-here" class="section level3 hasAnchor" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Repo <a href="https://github.com/tpcovino/09_evapotranspiration" target="blank">here</a><a href="physical-process-models.html#repo-here" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
<div id="learning-module-8" class="section level3 hasAnchor" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> Learning Module 8<a href="physical-process-models.html#learning-module-8" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>20pnts<br></p>
<div id="background-2" class="section level4 hasAnchor" number="5.2.2.1">
<h4><span class="header-section-number">5.2.2.1</span> Background<a href="physical-process-models.html#background-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Suggested reading: <a href="chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://www.srs.fs.usda.gov/pubs/ja/2016/ja_2016_amatya_008.pdf">Forest Evapotranspiration: Measurement and Modeling at Multiple Scales</a></p>
<p>Evapotranspiration (ET) encompasses all processes through which water moves from the Earth’s surface to the atmosphere, comprising both evaporation and transpiration. This includes water vaporizing into the air from soil surfaces, the capillary fringe of groundwater, and water bodies on land.
Much like snowmelt modeling, ET modeling and measurements are critical to many fields and could be a full course on its own. We will be focused on the basics of ET, modeling and data retrieval methods for water balance in hydrological modeling. Evapotranspiration is an important variable in hydrological models, as it accounts for much of the water loss in a system, outside of discharge.
Transpiration, a significant component of ET, involves the movement of water from soil to atmosphere through plants. This occurs as plants absorb liquid water from the soil and release water vapor through their leaves. To gain a deeper understanding of ET, let’s review transpiration.</p>
<div id="transpiration" class="section level5 hasAnchor" number="5.2.2.1.1">
<h5><span class="header-section-number">5.2.2.1.1</span> Transpiration<a href="physical-process-models.html#transpiration" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Plant root systems to absorb water and nutrients from the soil, which they then distribute to their stems and leaves. As part of this process, plants regulate the loss of water vapor into the atmosphere through stomatal apertures, or transpiration. However, the volume of water transpired can vary widely due to factors like weather conditions and plant traits.</p>
<p>Vegetation type: Plants transpire water at different rates. Some plants in arid regions have evolved mechanisms to conserve water by reducing transpiration. One mechanism involves regulating stomatal opening and closure. These plants can minimize water loss, especially during periods of high heat and low humidity. This closure of stomata can lead to diel and seasonal patterns in transpiration rates. Throughout the day, when environmental conditions are favorable for photosynthesis, stomata open to allow gas exchange, leading to increased transpiration. Conversely, during the night or under stressful conditions, stomata may close to conserve water, resulting in reduced transpiration rates.</p>
<p>Humidity: As the relative humidity of the air surrounding the plant rises the transpiration rate falls. It is easier for water to evaporate into dryer air than into more saturated air.</p>
<p>Soil type and saturation: Clay particles, being small, have a high capacity to retain water, while sand particles, being larger, readily release water. During dry periods, transpiration can contribute to the loss of moisture in the upper soil zone.When there is a shortage of moisture in the soil, plants may enter a state of senescence and reduce their rate of transpiration.</p>
<p>Temperature: Transpiration rates go up as the temperature goes up, especially during the growing season, when the air is warmer due to stronger sunlight and warmer air masses. Higher temperatures cause the plant cells to open stomata, allowing for the exchange of CO2 and water with the atmosphere, whereas colder temperatures cause the openings to close.</p>
<p>The availability and intensity of sunlight have a direct impact on transpiration rates. Likewise, the aspect of a location can influence transpiration since sunlight availability often depends on it.</p>
<p>Wind &amp; air movement: Increased movement of the air around a plant will result in a higher transpiration rate. Wind will move the air around, with the result that the more saturated air close to the leaf is replaced by drier air.</p>
</div>
</div>
<div id="measurements" class="section level4 hasAnchor" number="5.2.2.2">
<h4><span class="header-section-number">5.2.2.2</span> Measurements<a href="physical-process-models.html#measurements" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>In the realm of evapotranspiration (ET) modeling and data analysis, you’ll frequently encounter the terms potential ET and actual ET. These terms are important to consider when selecting data, as they offer very different insights into water loss processes from the land surface to the atmosphere.</p>
<p>Potential Evapotranspiration (PET): Potential ET refers to the maximum possible rate at which water could evaporate and transpire under ideal conditions. These conditions typically assume an ample supply of water, unrestricted soil moisture availability, and sufficient energy to drive the evaporative processes. PET is often estimated based on meteorological variables such as temperature, humidity, wind speed, and solar radiation using empirical equations like the Penman-Monteith equation.</p>
<p>Actual Evapotranspiration (AET): Actual ET, on the other hand, represents the observed or estimated rate at which water is actually evaporating and transpiring from the land surface under existing environmental conditions. Unlike PET, AET accounts for factors such as soil moisture availability, vegetation cover, stomatal conductance, and atmospheric demand. It reflects the true water loss from the ecosystem and is often of greater interest in hydrological modeling, as it provides a more realistic depiction of water balance dynamics.</p>
<p>The formula for converting PET to AET is:</p>
<p>AET = PET * Kc</p>
<p>Where:</p>
<p>AET is the actual evapotranspiration,
PET is the potential evapotranspiration, and
Kc is the crop coefficient.
The crop coefficient accounts for factors such as crop type, soil moisture levels, climate conditions, and management practices. It can vary throughout the growing season as well.</p>
<div id="direct-measurements" class="section level5 hasAnchor" number="5.2.2.2.1">
<h5><span class="header-section-number">5.2.2.2.1</span> Direct measurements:<a href="physical-process-models.html#direct-measurements" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>There are several methods to measure ET directly like lysimeters and gravimetric analysis, but this data rarely available to the public. There has been a concerted effort to enhance the accessibility of Eddy Covariance data, so the dataset mentioned in the video below may expand in the years to come.</p>
<p>This video focuses on CO2 as an output of eddy covariance data, but among the ‘other gases’ mentioned, water vapor is included, offering means to estimate actual ET. The video also provides a resource where you might find eddy covariance data for your region of interest.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="physical-process-models.html#cb8-1" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_url</span>(<span class="st">&quot;https://www.youtube.com/embed/CR4Anc8Mkas&quot;</span>)</span></code></pre></div>
<iframe src="https://www.youtube.com/embed/CR4Anc8Mkas" width="672" height="400px" data-external="1">
</iframe>
</div>
<div id="remote-sensing" class="section level5 hasAnchor" number="5.2.2.2.2">
<h5><span class="header-section-number">5.2.2.2.2</span> Remote sensing:<a href="physical-process-models.html#remote-sensing" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Remote sensing of evapotranspiration (ET) involves the use of satellite or airborne sensors to observe and quantify the exchange of water vapor between the Earth’s surface and the atmosphere over large spatial scales. This approach offers several advantages, including the ability to monitor ET across diverse landscapes, regardless of accessibility, and to capture variations in ET over time with high temporal resolution.</p>
<p>Remote sensing data, coupled with energy balance models, can be used to estimate ET by quantifying the energy fluxes at the land surface. These models balance incoming solar radiation with outgoing energy fluxes, including sensible heat flux and latent heat flux (representing ET). Remote sensing-based ET estimates are often validated and calibrated using ground-based measurements, such as eddy covariance towers or lysimeters, to ensure accuracy and reliability. It can be helpful to validate these models yourself if you have a data source available in your ecoregion as a ‘sanity check’. Keep in mind that there are numerous models available, some of which may be tailored for specific ecoregions, resulting in significant variations in estimated evapotranspiration (ET) for your area among these models. If directly measured ET data is not available, you can check model output in a simple water balance. For example, inputs - outputs for your watershed (Ppt - Q - ET) should be <em>approximately</em> 0 (recall from our transfer function module that it is likely not exact). If the ET estimate matches precipitation, it’s likely that the selected model is overestimating ET for your region.</p>
<p>Some resources for finding ET modeled from remote sensing data:</p>
<p><a href="https://app.climateengine.org/climateEngine">ClimateEngine.org</a> - This is a fun resource for all kinds of data. Actual evapotranspiration can be found in the TerraClimate dataset.</p>
<p><a href="https://etdata.org/">OpenET</a> - you need a Google account for this one. This site is great if you need timeseries data. You can select ‘gridded data’ and draw a polygon in your area of interest. You can select the year of interest at the top of the map, and once the timeseries generates, you can view and compare the output of seven different models.</p>
</div>
</div>
<div id="modeling" class="section level4 hasAnchor" number="5.2.2.3">
<h4><span class="header-section-number">5.2.2.3</span> Modeling:<a href="physical-process-models.html#modeling" class="anchor-section" aria-label="Anchor link to header"></a></h4>
</div>
</div>
<div id="labwork-20-pts-4" class="section level3 hasAnchor" number="5.2.3">
<h3><span class="header-section-number">5.2.3</span> Labwork (20 pts):<a href="physical-process-models.html#labwork-20-pts-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For this assignment, we will work again in the Fraser Experimental Forest (same site as snowmelt module). Not only are there meteorological stations in our watershed of interest, but there is a Eddy Covariance tower nearby, in a forest with the same tree community as our watershed of interest. We can use this data to verify our model output for modeled data.</p>
<div id="the-evapotranspiration-package" class="section level4 hasAnchor" number="5.2.3.1">
<h4><span class="header-section-number">5.2.3.1</span> The <a href="https://cran.r-project.org/web/packages/Evapotranspiration/index.html">Evapotranspiration package</a><a href="physical-process-models.html#the-evapotranspiration-package" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We will test a couple of simple methods that require few data inputs. However, it may be helpful to know that this package will allow calculations of PET, AET and Reference Crop Evapotranspiration from many different equations. Your selection of models may depend on the study region and the data available.</p>
</div>
<div id="import-libraries" class="section level4 hasAnchor" number="5.2.3.2">
<h4><span class="header-section-number">5.2.3.2</span> Import libraries<a href="physical-process-models.html#import-libraries" class="anchor-section" aria-label="Anchor link to header"></a></h4>
</div>
<div id="import-data-1" class="section level4 hasAnchor" number="5.2.3.3">
<h4><span class="header-section-number">5.2.3.3</span> Import data<a href="physical-process-models.html#import-data-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="meteorological-data" class="section level5 hasAnchor" number="5.2.3.3.1">
<h5><span class="header-section-number">5.2.3.3.1</span> Meteorological data<a href="physical-process-models.html#meteorological-data" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We’ll import three datasets in this workflow, one containing actual data from the eddy covariance tower that has been converted to AET. This dataset ranges from 2018 to 2023 <br>
Also imported is the discharge (Q) data from our watershed. Note that data is not collected during periods of deep snow. We will use this data to estimate the total discharge for 2022. <br>
Additionally, we’ll import the meteorological data from our watershed. We are going to estimate ET for our watershed during the 2022 water year, though met data is provided in calendar years, so we will need to extract the desired data from the meteorological dataframe.</p>
</div>
</div>
<div id="data-formatting" class="section level4 hasAnchor" number="5.2.3.4">
<h4><span class="header-section-number">5.2.3.4</span> Data formatting<a href="physical-process-models.html#data-formatting" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We will model ET at daily timesteps. Note that all imported data is for different timesteps, units and measurements than what we need for analysis. It is common practice to manipulate the imported data and adjust it to align with our model functions. Ensuring the correct structure of the data can prevent potential issues later in the code</p>
<p>Now we have the RHmax and RHmin values that we will need for our ET models</p>
<div id="precipitation" class="section level5 hasAnchor" number="5.2.3.4.1">
<h5><span class="header-section-number">5.2.3.4.1</span> Precipitation<a href="physical-process-models.html#precipitation" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>To add a layer of checks we will also check precipitation totals from the watershed from meteorological stations. This dataframe provides cumulative precipitation, though the accumulation begins on January 1. Therefore we will need to calculate daily precipitation for each day of the water year and generate a new cumulative value that accumulates from October 1 - Sept 30 (water year cumulative total).</p>
<p>This was a lot of work to save one value.</p>
</div>
</div>
<div id="pseudocode" class="section level4 hasAnchor" number="5.2.3.5">
<h4><span class="header-section-number">5.2.3.5</span> Pseudocode<a href="physical-process-models.html#pseudocode" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Often when writing code, it is necessary to start with pseudocode. Pseudocode allows us to plan and structure the logic of the script before implementing it in a specific programming language. It is typically a mix of natural language and code that serves as a blueprint for the script(e.g., “I’ll used ‘merge’ to combine my data frames by a shared date column”). Once the workflow is outlined, then we can translate it into actual code using appropriate syntax.</p>
<p><strong>Q1. (2 pnts) In you own words, what did we do at each step in the above chunk and what is cumulative_ppt_2022. Why do we want to know this?</strong>
Hint: if the third step in the above chunk is confusing, look at the new daily_ppt_mm column after running the first two steps to see what happens without it.</p>
<p>ANSWER:</p>
<div id="discharge-data" class="section level5 hasAnchor" number="5.2.3.5.1">
<h5><span class="header-section-number">5.2.3.5.1</span> Discharge data<a href="physical-process-models.html#discharge-data" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Our next step will be to import and format discharge data collected from the weir at Fool Creek. Again, data collection starts on April 20th this year. To estimate discharge between Sept 31 of the previous year and April 20th of 2022, we will assume daily discharge between these dates is the mean of the discharge values from each of these dates.</p>
<p><strong>Q2 (3 pnts) Write pseudocode in a stepwise fashion to describe the workflow that will need to happen to estimate the total volume of water in mm/watershed area for 2022 lost to stream discharge. Consider that the units provided by USFS are in cubic feet/second (cfs).</strong></p>
<p>ANSWER:
1. Import dataframe
2. …</p>
</div>
<div id="evapotranspiration-data" class="section level5 hasAnchor" number="5.2.3.5.2">
<h5><span class="header-section-number">5.2.3.5.2</span> Evapotranspiration data<a href="physical-process-models.html#evapotranspiration-data" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Import and transform ET data. <br>
Note that ET data is in mmol/m2/s. We want to convert this to mm/day. <br>
Eddy covariance data collected from towers represents the exchange of gases, including water vapor, between the atmosphere and the land surface within a certain area known as the “footprint.” This footprint area is not fixed; it changes in size and shape depending on factors like wind direction, thermal stability, and measurement height. Typically, it has a gradual border, meaning that the influence of the tower measurements extends beyond its immediate vicinity.</p>
<p>For our specific tower data, we’ve estimated the mean flux area, or footprint area, to be approximately 0.4 square kilometers. However, when estimating the total evapotranspiration (ET) for our entire watershed, we need to extrapolate the ET measured by the tower to cover the entire watershed area. This extrapolation involves scaling up the measurements from the tower footprint to the larger area of the watershed to get a more comprehensive understanding of water vapor exchange over the entire region.</p>
<p>This appears to be a fairly well balanced water budget, especially considering that we have made some estimates along the way. Let’s see how this ET data compares to modeled data.</p>
</div>
</div>
<div id="the-priestly-taylor-method" class="section level4 hasAnchor" number="5.2.3.6">
<h4><span class="header-section-number">5.2.3.6</span> <a href="https://search.r-project.org/CRAN/refmans/Evapotranspiration/html/ET.PriestleyTaylor.html">The Priestly Taylor method</a><a href="physical-process-models.html#the-priestly-taylor-method" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The Priestley-Taylor method is a semi-empirical model that estimates potential evapotranspiration as a function of net radiation. This method requires a list which contains:<br> (climate variables) required by Priestley-Taylor formulation:
Tmax, Tmin (degree Celcius), RHmax, RHmin (percent), Rs (Megajoules per sqm) or n (hour). <br>
We have measurements of relative humidity (RH) data from within our watershed meteorological station. However, RH data can be found through many sources providing local weather data. <br>
n refers to the number of sunshine hours.</p>
<p>Evapotranspiration comes with a list physical ‘constants’, but we want to replace important constants with data specific to our cite.</p>
<p>We can change the function name to specify the desired model. Now we’ll try the<a href="http://data.snap.uaf.edu/data/Base/AK_2km/PET/Hamon_PET_equations.pdf">the Hamon method</a>.</p>
<p>Recall that each of these are estimates of potential ET.
Crop coefficients (Kc values) for specific tree species like those found in the Fraser Experimental Forest (lodgepole pine or Englemann spruce) may not be as readily available as they are for agricultural crops. However, you may be able to find some guidance in scientific literature or forestry publications. From what we have found, Kc estimates for lodgepole pine forests can be between 0.4 and 0.8. These values may vary depending on factors such as climate, soil type, elevation, and other site-specific factors. Our own estimates using water balance data from dates that correspond with the eddy flux tower data suggest seasonal fluctuations, with a mean of 0.55.</p>
<p>AET = PET * Kc</p>
<p>Let’s plot the two modeled ET timeseries with the eddy covaraince tower data.</p>
<p><strong>Q3. (4 pnts) Consider the two evapotranspiration (ET) models we have generated, one consistently underestimates ET, while the other consistently overestimates summer values and underestimates winter values. Consider ecosystem specificity in modeling. Why do you think these two methods generate such different estimates? What ecosystem-specific factors might contribute to the discrepancies between models?</strong></p>
<p>ANSWER:</p>
<p><strong>Q4 (3 pnts) Let’s assume we do not have eddy covariance tower data for this time period, but you have the provided discharge and precipitation measurements. Which model would you choose to estimate an annual ET sum and why?</strong></p>
<p>ANSWER:</p>
<p><strong>Q5 (3 pnts) In our modeling script, while our main objective was to estimate evapotranspiration (ET), which specific aspect required the most labor and attention to detail? Reflect on the tasks involved in data preparation, cleaning, and formatting. How did these preliminary steps impact the overall modeling process? </strong></p>
<p>ANSWER:</p>
<p><strong>Q6 (5 pnts) Review the sub-watershed figure and analyze how vegetation characteristics (e.g., height, age), slope, and aspect vary across high-elevation watersheds in the Fraser Experimental Forest. Utilize Google Maps’ high-resolution imagery as an additional resource to observe these landscape features. How might these factors interact to influence actual evapotranspiration (AET) in this region? Provide a hypothetical comparison of two sub-watersheds, describing how differences in these variables could lead to variations in AET.</strong></p>
<p>ANSWER:</p>
<div class="float">
<img src="images/fool_studyarea.png" alt="Fool Creek delineated watershed" />
<div class="figcaption">Fool Creek delineated watershed</div>
</div>

</div>
</div>
</div>
<div id="hbv-hydrology-model" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> HBV Hydrology Model<a href="physical-process-models.html#hbv-hydrology-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="learning-module-9" class="section level3 hasAnchor" number="5.3.1">
<h3><span class="header-section-number">5.3.1</span> Learning Module 9<a href="physical-process-models.html#learning-module-9" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Adapted from Fabian Nippgen (REWM 4500 5500)</p>
<div id="background-3" class="section level4 hasAnchor" number="5.3.1.1">
<h4><span class="header-section-number">5.3.1.1</span> Background:<a href="physical-process-models.html#background-3" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>In this exercise, we will pull together many aspects of what we have learned so far to calibrate the HBV model to weighted data from the Fraser Experimental Forest in Colorado using precipitation/runoff and potential evapotranspiration (PET) data derived from the methods explored in the snowmelt and evapotranspiration modules.</p>
<p>HBV is:
In the previous labs, we have worked with single-process models. HBV is more complex process-based model using many parameters to describe the physical processes of the hydrologic cycle
<a href="https://rpubs.com/sdhakal/848236" class="uri">https://rpubs.com/sdhakal/848236</a></p>
<p><img src="images/HBV-schem-Shrestha-Solomantine-2008.png" title="HBV Model" /></p>
<p>Reproduced from: Durga Lal Shrestha &amp; Dimitri P. Solomatine (2008) Data‐driven approaches for estimating uncertainty in rainfall‐runoff modelling, International Journal of River Basin Management, 6:2, 109-122, DOI: 10.1080/15715124.2008.9635341</p>
<p>HBV versions with a GUI exists, but the data manipulation is more convenient in a coding environment, and we want you to be able to see ‘under the hood’. Instead of dealing with the inner workings of the model too much, we will put the focus on importing and organizing the data, getting the model running and manual optimization.</p>
<p>The HBV realization we will be using is contained in the R package TUWmodel. Please search that package in your browser and familiarize yourself with it (that will be the first step). TUW simply means “Technische Universitaet Wien”, or Vienna University of Technology. The model is slightly different from the original HBV but still similar enough to call it HBV. We also need to understand the arguments and parameters required for the model.</p>
<p>Type ‘?TUWmodel’ in your console. Note that the package comes with an example dataset, and you can run examples either by copying and pasting the data(), TUWmodel() and plots into your console, or you can find and click ‘Run examples’ under the <strong>Examples</strong> header and view the script and plot outputs in the Help window. The first example shows how the ‘TUWmodel’ can be run given specifications for a long set of parameters (param). You can provide the model with precip, air temperature, area and ET along with the parameter set and it will simulate SWE, snow melt and discharge. We can obtain measurements for each of these variables, so we will import all of this data and test the fit of the simulated data.</p>
<p><a href="https://cran.r-project.org/web/packages/TUWmodel/TUWmodel.pdf" class="uri">https://cran.r-project.org/web/packages/TUWmodel/TUWmodel.pdf</a></p>
</div>
<div id="import-data-2" class="section level4 hasAnchor" number="5.3.1.2">
<h4><span class="header-section-number">5.3.1.2</span> Import data:<a href="physical-process-models.html#import-data-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We will generate a conceptual runoff model starting with: <br></p>
<ul>
<li><p>RainMeltWeighted_mm –&gt; liquid input to the ground, combination of rain and melt <br></p></li>
<li><p>PWeighted_mm –&gt; Precipitation measured at the SNOTEL sites, both liquid and frozen. This is NOT water that went into the ground at that point. This is, however, the P input time series for the HBV model. <br></p></li>
<li><p>SweWeighted_mm –&gt; Snow water equivalent at the SNOTEL sites. We can use this to evaluate our snow routine. <br></p></li>
<li><p>TempWeighted –&gt; Either daily mean, min, or max. We will use the mean. <br></p></li>
<li><p>Discharge_mm –&gt; Q observed at the outlet. <br></p></li>
<li><p>ET –&gt; Potential Evapotranspiration calculated using relative humidity and temperature. <br></p></li>
</ul>
</div>
</div>
<div id="repo-link-3" class="section level3 hasAnchor" number="5.3.2">
<h3><span class="header-section-number">5.3.2</span> Repo link<a href="physical-process-models.html#repo-link-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><a href="https://github.com/tpcovino/08_hbv_models-.git" target="_blank">Download the repo for this lab HERE</a></p>
</div>
<div id="labwork-20-pnts-2" class="section level3 hasAnchor" number="5.3.3">
<h3><span class="header-section-number">5.3.3</span> Labwork (20 pnts)<a href="physical-process-models.html#labwork-20-pnts-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Our first steps will be to import and format the data. As you might recall from the previous modules, this step can require the most script and ‘work’, but is critical to a valid model output. In this assignment, we have simplified much of the data collection for you, as the steps are ones you have already completed in previous modules.</p>
<p>In the .csv imported below, we started by collecting the same SNOTEL data that you used in the snow melt module, but downloaded for a greater date range (water years 2018-2022) (date, SWE depth in mm, and daily precipitation (mm)) However, you will notice that the column names of the provided table contain ‘weighted_’.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="physical-process-models.html#cb9-1" tabindex="-1"></a><span class="co"># Import model data </span></span>
<span id="cb9-2"><a href="physical-process-models.html#cb9-2" tabindex="-1"></a><span class="co"># indata &lt;- read.csv(&quot;weighted_data_fool_HBV.csv&quot;)%&gt;%</span></span>
<span id="cb9-3"><a href="physical-process-models.html#cb9-3" tabindex="-1"></a><span class="co">#   mutate(date = ymd(date)) %&gt;%</span></span>
<span id="cb9-4"><a href="physical-process-models.html#cb9-4" tabindex="-1"></a><span class="co">#   rename(Q_m3_s = m3_s, Q_mm_day = mm_day, runoff_input.mm = input.mm )</span></span>
<span id="cb9-5"><a href="physical-process-models.html#cb9-5" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-6"><a href="physical-process-models.html#cb9-6" tabindex="-1"></a><span class="co"># str(indata)</span></span></code></pre></div>
<p>As we noted in the Snowmelt module, factors such as elevation and vegetation will affect the of snow-to-runoff rate. Similarly, temperature and precipitation differ with elevation, meaning that SNOTEL data from a single location may not fully represent conditions across the entire watershed.</p>
<p>To account for these variations, the “weighted” values for this exercise have been adjusted using linear scaling relationships that estimate average conditions across the watershed. The adjustments use elevation-precipitation and elevation-temperature relationships derived from inverse distance weighting to better approximate spatially distributed hydrological inputs rather than relying on a single point measurement.</p>
<p><img src="images/precip_spatial_interp.png" title="Spatial interpolation" /></p>
<p>If you are interested, you can start exploring spatial interpolation with: <br>
1. Thiessen polygons
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d9/Voronoi_growth_euclidean.gif/440px-Voronoi_growth_euclidean.gif" alt="Thiessen polygons" />
<br>
2. Inverse distance weighting <br>
3. Kringing methods
to determine if any of these are applicable to your study area.</p>
<p>Other columns in our imported data set include:
<strong>Q_m3_s and Q_mm_day</strong> - Discharge (Q) collected at the Fool Creek outlet by USFS, in units of cubic meters per second and mm per day from April until October.
<strong>Tmax_c, Tmin_c and Tmean_c</strong> - Typically, we could find daily mean, max and minimum temperatures in the SNOTEL datasets, however, this particular station is missing temperature data (due to restrictions on technical access in 2020), so we retrieved temperature data from GridMET through <a href="https://app.climateengine.org/climateEngine">Climate Engine</a>. This highlights the importance of evaluating each variable for completeness. It will save you the headache of running the entire workflow, only to find that model outputs cannot be simulated for the later half of 2020 due to missing input data.
<strong>RHmin, RHmax</strong> - Relative humidity daily min and max, also from GridMET, accessed through Climate Engine
<strong>SWEdiff.mm, Pdiff.mm and runoff_input.mm</strong> - all daily outputs of a temperature based snowmelt model (the same as in the snow melt module). runoff_input is the estimated daily input to the stream from melted snow and liquid precipitation combined.</p>
<p>Keep in mind that you can plot more than two variables in a single plot, but they will be most helpful if you group variables with a similar y-scale. For example, cumulative precipitation or SWE values will have a different range than variables that represent daily measurements like ‘input_mm’. Alternatively, you can add a secondary y-axis to your plot.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="physical-process-models.html#cb10-1" tabindex="-1"></a><span class="co"># ggplot(data = indata) +</span></span>
<span id="cb10-2"><a href="physical-process-models.html#cb10-2" tabindex="-1"></a><span class="co">#   geom_point(aes(x = date, y = runoff_input.mm, color = &quot;runoff_input.mm&quot;), size = 0.5) +  # Assign a label for legend</span></span>
<span id="cb10-3"><a href="physical-process-models.html#cb10-3" tabindex="-1"></a><span class="co">#   geom_point(aes(x = date, y = Q_mm_day, color = &quot;mm/day&quot;), size = 0.5) +  # Assign a different label</span></span>
<span id="cb10-4"><a href="physical-process-models.html#cb10-4" tabindex="-1"></a><span class="co">#   geom_point(aes(x = date, y = weighted_precip.mm, color = &quot;weighted_precip.mm&quot;), size = 0.5) +  # Assign a different label</span></span>
<span id="cb10-5"><a href="physical-process-models.html#cb10-5" tabindex="-1"></a><span class="co">#   geom_point(aes(x = date, y = Pdiff.mm, color = &quot;Pdiff.mm&quot;), size = 0.5) +</span></span>
<span id="cb10-6"><a href="physical-process-models.html#cb10-6" tabindex="-1"></a><span class="co">#   scale_color_manual(values = c(&quot;runoff_input.mm&quot; = &quot;blue&quot;, &quot;mm/day&quot; = &quot;red&quot;, &quot;weighted_precip.mm&quot; = &quot;green&quot;, &quot;Pdiff.mm&quot; = &#39;purple&#39;)) +  # Customize colors</span></span>
<span id="cb10-7"><a href="physical-process-models.html#cb10-7" tabindex="-1"></a><span class="co">#   labs(color = &quot;Discharge Units&quot;) +  # Legend title</span></span>
<span id="cb10-8"><a href="physical-process-models.html#cb10-8" tabindex="-1"></a><span class="co">#   theme_minimal()</span></span></code></pre></div>
<p>2,930m.
watershed_area_m2 &lt;- 2640000</p>
<p>Note that while the stream is snow-covered, there are no stage/flow measurements being made at this site. For many of our calculations to work, we will not want NA in our data frames. In this data set, if we view the tabular data, the end discharge reading (Q_mm_day), is very similar to the first in the following calendar year. For this example, we will then fill the NA values with the mean of the final and first readings for each winter (Oct - April) NA string.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="physical-process-models.html#cb11-1" tabindex="-1"></a><span class="co"># Rather than scrolling through a dataframe, this gives us a sum of &#39;NA&#39; ros in this column</span></span>
<span id="cb11-2"><a href="physical-process-models.html#cb11-2" tabindex="-1"></a><span class="co"># sum(is.na(indata$Q_mm_day))</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="physical-process-models.html#cb12-1" tabindex="-1"></a><span class="co"># # Function to fill NA values in Q_mm_day during winter (Oct - Apr)</span></span>
<span id="cb12-2"><a href="physical-process-models.html#cb12-2" tabindex="-1"></a><span class="co"># fill_na_winter &lt;- function(df) {</span></span>
<span id="cb12-3"><a href="physical-process-models.html#cb12-3" tabindex="-1"></a><span class="co">#   df &lt;- df %&gt;%</span></span>
<span id="cb12-4"><a href="physical-process-models.html#cb12-4" tabindex="-1"></a><span class="co">#     arrange(date) %&gt;% # Ensure data is sorted</span></span>
<span id="cb12-5"><a href="physical-process-models.html#cb12-5" tabindex="-1"></a><span class="co">#     mutate(</span></span>
<span id="cb12-6"><a href="physical-process-models.html#cb12-6" tabindex="-1"></a><span class="co">#       month = month(date),</span></span>
<span id="cb12-7"><a href="physical-process-models.html#cb12-7" tabindex="-1"></a><span class="co">#       is_winter = month %in% c(10, 11, 12, 1, 2, 3, 4) # Identify winter months</span></span>
<span id="cb12-8"><a href="physical-process-models.html#cb12-8" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb12-9"><a href="physical-process-models.html#cb12-9" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb12-10"><a href="physical-process-models.html#cb12-10" tabindex="-1"></a><span class="co">#   # Identify NA stretches in winter months</span></span>
<span id="cb12-11"><a href="physical-process-models.html#cb12-11" tabindex="-1"></a><span class="co">#   na_indices &lt;- which(is.na(df$Q_mm_day) &amp; df$is_winter)</span></span>
<span id="cb12-12"><a href="physical-process-models.html#cb12-12" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb12-13"><a href="physical-process-models.html#cb12-13" tabindex="-1"></a><span class="co">#   for (idx in na_indices) {</span></span>
<span id="cb12-14"><a href="physical-process-models.html#cb12-14" tabindex="-1"></a><span class="co">#     # Find the last non-NA before the current NA</span></span>
<span id="cb12-15"><a href="physical-process-models.html#cb12-15" tabindex="-1"></a><span class="co">#     prev_value &lt;- df$Q_mm_day[max(which(!is.na(df$Q_mm_day[1:(idx - 1)])))]</span></span>
<span id="cb12-16"><a href="physical-process-models.html#cb12-16" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb12-17"><a href="physical-process-models.html#cb12-17" tabindex="-1"></a><span class="co">#     # Find the next non-NA after the current NA</span></span>
<span id="cb12-18"><a href="physical-process-models.html#cb12-18" tabindex="-1"></a><span class="co">#     next_value &lt;- df$Q_mm_day[min(which(!is.na(df$Q_mm_day[(idx + 1):nrow(df)])) + idx)]</span></span>
<span id="cb12-19"><a href="physical-process-models.html#cb12-19" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb12-20"><a href="physical-process-models.html#cb12-20" tabindex="-1"></a><span class="co">#     # Replace the NA with the average of prev_value and next_value</span></span>
<span id="cb12-21"><a href="physical-process-models.html#cb12-21" tabindex="-1"></a><span class="co">#     if (!is.na(prev_value) &amp; !is.na(next_value)) {</span></span>
<span id="cb12-22"><a href="physical-process-models.html#cb12-22" tabindex="-1"></a><span class="co">#       df$Q_mm_day[idx] &lt;- (prev_value + next_value) / 2</span></span>
<span id="cb12-23"><a href="physical-process-models.html#cb12-23" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb12-24"><a href="physical-process-models.html#cb12-24" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb12-25"><a href="physical-process-models.html#cb12-25" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb12-26"><a href="physical-process-models.html#cb12-26" tabindex="-1"></a><span class="co">#   return(df)</span></span>
<span id="cb12-27"><a href="physical-process-models.html#cb12-27" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb12-28"><a href="physical-process-models.html#cb12-28" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb12-29"><a href="physical-process-models.html#cb12-29" tabindex="-1"></a><span class="co"># # Apply the function</span></span>
<span id="cb12-30"><a href="physical-process-models.html#cb12-30" tabindex="-1"></a><span class="co"># indata &lt;- fill_na_winter(indata)</span></span></code></pre></div>
<p>Let’s try our quick check again:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="physical-process-models.html#cb13-1" tabindex="-1"></a><span class="co"># Now we should see zero NA in this column</span></span>
<span id="cb13-2"><a href="physical-process-models.html#cb13-2" tabindex="-1"></a><span class="co"># sum(is.na(indata$Q_mm_day))</span></span></code></pre></div>
<p>Next, we need to add daily potential evapotranspiration (PET) to the dataset. The evapotranspiration module covered some of the numerous pre-built functions available in various R packages designed for ET estimation. For instance, the ‘Evapotranspiration’ package provides ET estimates derived from approximately 20 distinct equations or variations. These functions require precise data formatting to ensure compatibility with the function arguments. To help you structure your function inputs similarly, many packages come with example datasets in their documentation. SPEI is another package that offers ET functions. The github repository for this package has been updated fairly recently, which can be important to verify.</p>
<p>We chose to write our own function here so you could ‘see under the hood’.<br />
Not all packages are equally maintained, as they are often developed by researchers or modelers to improve the repeatably of their work, and contribute to the broader scientific community. Once funding ceases, or if the original developer moves on to new projects, a custom package may no longer receive updates or support. As R, RStudio and other supporting packages are updated, a package may become depreciated. If the package still functions correctly in your current R version and dependencies, there’s no immediate reason to stop using it. However, if you are concerned that future versions of R or dependencies might break the packages you use, you can check the development and maintenance history of custom or specialized packages (or write a package or function for yourself as exemplified below!).</p>
<p>Here is our Hargreaves function, adapted from the ‘Evapotranspiration’ package to minimize re-formatting of our dataframe.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="physical-process-models.html#cb14-1" tabindex="-1"></a><span class="co"># # Function to calculate ET</span></span>
<span id="cb14-2"><a href="physical-process-models.html#cb14-2" tabindex="-1"></a><span class="co"># calculate_ET &lt;- function(data, constants, ts = &quot;daily&quot;, message = &quot;yes&quot;, save.csv = &quot;no&quot;, ...) {</span></span>
<span id="cb14-3"><a href="physical-process-models.html#cb14-3" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb14-4"><a href="physical-process-models.html#cb14-4" tabindex="-1"></a><span class="co">#   # Check for required data</span></span>
<span id="cb14-5"><a href="physical-process-models.html#cb14-5" tabindex="-1"></a><span class="co">#   if (is.null(data$Tmax) | is.null(data$Tmin)) {</span></span>
<span id="cb14-6"><a href="physical-process-models.html#cb14-6" tabindex="-1"></a><span class="co">#     stop(&quot;Required data missing for &#39;Tmax&#39; and &#39;Tmin&#39;, or &#39;Temp&#39;&quot;)</span></span>
<span id="cb14-7"><a href="physical-process-models.html#cb14-7" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb14-8"><a href="physical-process-models.html#cb14-8" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb14-9"><a href="physical-process-models.html#cb14-9" tabindex="-1"></a><span class="co">#   # Hargreaves-Samani ET Calculation</span></span>
<span id="cb14-10"><a href="physical-process-models.html#cb14-10" tabindex="-1"></a><span class="co">#   Ta &lt;- (data$Tmax + data$Tmin) / 2</span></span>
<span id="cb14-11"><a href="physical-process-models.html#cb14-11" tabindex="-1"></a><span class="co">#   P &lt;- 101.3 * ((293 - 0.0065 * constants$Elev) / 293) ^ 5.26</span></span>
<span id="cb14-12"><a href="physical-process-models.html#cb14-12" tabindex="-1"></a><span class="co">#   delta &lt;- 4098 * (0.6108 * exp((17.27 * Ta) / (Ta + 237.3))) / ((Ta + 237.3) ^ 2)</span></span>
<span id="cb14-13"><a href="physical-process-models.html#cb14-13" tabindex="-1"></a><span class="co">#   gamma &lt;- 0.00163 * P / constants$lambda</span></span>
<span id="cb14-14"><a href="physical-process-models.html#cb14-14" tabindex="-1"></a><span class="co">#   d_r2 &lt;- 1 + 0.033 * cos(2 * pi / 365 * data$J)</span></span>
<span id="cb14-15"><a href="physical-process-models.html#cb14-15" tabindex="-1"></a><span class="co">#   delta2 &lt;- 0.409 * sin(2 * pi / 365 * data$J - 1.39)</span></span>
<span id="cb14-16"><a href="physical-process-models.html#cb14-16" tabindex="-1"></a><span class="co">#   w_s &lt;- acos(-tan(constants$lat_rad) * tan(delta2))</span></span>
<span id="cb14-17"><a href="physical-process-models.html#cb14-17" tabindex="-1"></a><span class="co">#   N &lt;- 24 / pi * w_s</span></span>
<span id="cb14-18"><a href="physical-process-models.html#cb14-18" tabindex="-1"></a><span class="co">#   R_a &lt;- (1440 / pi) * d_r2 * constants$Gsc * (w_s * sin(constants$lat_rad) * sin(delta2) + </span></span>
<span id="cb14-19"><a href="physical-process-models.html#cb14-19" tabindex="-1"></a><span class="co">#                                                cos(constants$lat_rad) * cos(delta2) * sin(w_s))</span></span>
<span id="cb14-20"><a href="physical-process-models.html#cb14-20" tabindex="-1"></a><span class="co">#   C_HS &lt;- 0.00185 * (data$Tmax - data$Tmin) ^ 2 - 0.0433 * (data$Tmax - data$Tmin) + 0.4023</span></span>
<span id="cb14-21"><a href="physical-process-models.html#cb14-21" tabindex="-1"></a><span class="co">#   ET_HS.Daily &lt;- 0.0135 * C_HS * R_a / constants$lambda * (data$Tmax - </span></span>
<span id="cb14-22"><a href="physical-process-models.html#cb14-22" tabindex="-1"></a><span class="co">#                                                               data$Tmin) ^ 0.5 * (Ta + 17.8)</span></span>
<span id="cb14-23"><a href="physical-process-models.html#cb14-23" tabindex="-1"></a><span class="co">#   ET.Daily &lt;- ET_HS.Daily</span></span>
<span id="cb14-24"><a href="physical-process-models.html#cb14-24" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb14-25"><a href="physical-process-models.html#cb14-25" tabindex="-1"></a><span class="co">#   # Create YearMonth Column</span></span>
<span id="cb14-26"><a href="physical-process-models.html#cb14-26" tabindex="-1"></a><span class="co">#   data$YearMonth &lt;- as.Date(paste(year(data$Date.daily), month(data$Date.daily), &quot;01&quot;, sep = &quot;-&quot;))</span></span>
<span id="cb14-27"><a href="physical-process-models.html#cb14-27" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb14-28"><a href="physical-process-models.html#cb14-28" tabindex="-1"></a><span class="co">#   # Annual and Monthly Aggregations</span></span>
<span id="cb14-29"><a href="physical-process-models.html#cb14-29" tabindex="-1"></a><span class="co">#   ET.Annual &lt;- aggregate(ET.Daily ~ year(YearMonth), data = data, FUN = sum)</span></span>
<span id="cb14-30"><a href="physical-process-models.html#cb14-30" tabindex="-1"></a><span class="co">#   ET.Monthly &lt;- aggregate(ET.Daily ~ YearMonth, data = data, FUN = sum)</span></span>
<span id="cb14-31"><a href="physical-process-models.html#cb14-31" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb14-32"><a href="physical-process-models.html#cb14-32" tabindex="-1"></a><span class="co">#   # ET formulating</span></span>
<span id="cb14-33"><a href="physical-process-models.html#cb14-33" tabindex="-1"></a><span class="co">#   ET_formulation &lt;- &quot;Hargreaves-Samani&quot;</span></span>
<span id="cb14-34"><a href="physical-process-models.html#cb14-34" tabindex="-1"></a><span class="co">#   ET_type &lt;- &quot;Reference Crop ET&quot;</span></span>
<span id="cb14-35"><a href="physical-process-models.html#cb14-35" tabindex="-1"></a><span class="co">#   results &lt;- list(ET.Daily = ET.Daily, ET.Monthly = ET.Monthly, </span></span>
<span id="cb14-36"><a href="physical-process-models.html#cb14-36" tabindex="-1"></a><span class="co">#                   ET.Annual = ET.Annual, ET_formulation = ET_formulation, </span></span>
<span id="cb14-37"><a href="physical-process-models.html#cb14-37" tabindex="-1"></a><span class="co">#                   ET_type = ET_type)</span></span>
<span id="cb14-38"><a href="physical-process-models.html#cb14-38" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb14-39"><a href="physical-process-models.html#cb14-39" tabindex="-1"></a><span class="co">#   # Save to CSV if required</span></span>
<span id="cb14-40"><a href="physical-process-models.html#cb14-40" tabindex="-1"></a><span class="co">#   if (save.csv == &quot;yes&quot;) {</span></span>
<span id="cb14-41"><a href="physical-process-models.html#cb14-41" tabindex="-1"></a><span class="co">#     for (i in 1:length(results)) {</span></span>
<span id="cb14-42"><a href="physical-process-models.html#cb14-42" tabindex="-1"></a><span class="co">#       namer &lt;- names(results[i])</span></span>
<span id="cb14-43"><a href="physical-process-models.html#cb14-43" tabindex="-1"></a><span class="co">#       write.table(as.character(namer), file = &quot;ET_HargreavesSamani.csv&quot;, </span></span>
<span id="cb14-44"><a href="physical-process-models.html#cb14-44" tabindex="-1"></a><span class="co">#                   dec = &quot;.&quot;, quote = FALSE, col.names = FALSE, </span></span>
<span id="cb14-45"><a href="physical-process-models.html#cb14-45" tabindex="-1"></a><span class="co">#                   row.names = F, append = TRUE, sep = &quot;,&quot;)</span></span>
<span id="cb14-46"><a href="physical-process-models.html#cb14-46" tabindex="-1"></a><span class="co">#       write.table(data.frame(get(namer, results)), file = &quot;ET_HargreavesSamani.csv&quot;, </span></span>
<span id="cb14-47"><a href="physical-process-models.html#cb14-47" tabindex="-1"></a><span class="co">#                   col.names = F, append = TRUE, sep = &quot;,&quot;)</span></span>
<span id="cb14-48"><a href="physical-process-models.html#cb14-48" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb14-49"><a href="physical-process-models.html#cb14-49" tabindex="-1"></a><span class="co">#     invisible(results)</span></span>
<span id="cb14-50"><a href="physical-process-models.html#cb14-50" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb14-51"><a href="physical-process-models.html#cb14-51" tabindex="-1"></a><span class="co">#     return(results)</span></span>
<span id="cb14-52"><a href="physical-process-models.html#cb14-52" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb14-53"><a href="physical-process-models.html#cb14-53" tabindex="-1"></a><span class="co"># }</span></span></code></pre></div>
<p>Now we will format the inputs so the data is easily read by the function, and run the function.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="physical-process-models.html#cb15-1" tabindex="-1"></a><span class="co"># # Format our data to fit the function</span></span>
<span id="cb15-2"><a href="physical-process-models.html#cb15-2" tabindex="-1"></a><span class="co"># PET_data &lt;- list(</span></span>
<span id="cb15-3"><a href="physical-process-models.html#cb15-3" tabindex="-1"></a><span class="co">#   Tmax = indata$Tmax,</span></span>
<span id="cb15-4"><a href="physical-process-models.html#cb15-4" tabindex="-1"></a><span class="co">#   Tmin = indata$Tmin,</span></span>
<span id="cb15-5"><a href="physical-process-models.html#cb15-5" tabindex="-1"></a><span class="co">#   J = as.numeric(format(indata$date, &quot;%j&quot;)),</span></span>
<span id="cb15-6"><a href="physical-process-models.html#cb15-6" tabindex="-1"></a><span class="co">#   Date.daily = indata$date</span></span>
<span id="cb15-7"><a href="physical-process-models.html#cb15-7" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb15-8"><a href="physical-process-models.html#cb15-8" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb15-9"><a href="physical-process-models.html#cb15-9" tabindex="-1"></a><span class="co"># # Define constants</span></span>
<span id="cb15-10"><a href="physical-process-models.html#cb15-10" tabindex="-1"></a><span class="co"># constants &lt;- list(</span></span>
<span id="cb15-11"><a href="physical-process-models.html#cb15-11" tabindex="-1"></a><span class="co">#   Elev = 2900,                            # Elevation in meters</span></span>
<span id="cb15-12"><a href="physical-process-models.html#cb15-12" tabindex="-1"></a><span class="co">#   lambda = 2.45,                          # Latent heat of vaporization in MJ.kg^-1</span></span>
<span id="cb15-13"><a href="physical-process-models.html#cb15-13" tabindex="-1"></a><span class="co">#   lat_rad = 39.88 * pi / 180,             # Latitude in radians</span></span>
<span id="cb15-14"><a href="physical-process-models.html#cb15-14" tabindex="-1"></a><span class="co">#   Gsc = 0.0820                            # Solar constant in MJ.m^-2.min^-1</span></span>
<span id="cb15-15"><a href="physical-process-models.html#cb15-15" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb15-16"><a href="physical-process-models.html#cb15-16" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb15-17"><a href="physical-process-models.html#cb15-17" tabindex="-1"></a><span class="co"># PET_Hargreaves &lt;- calculate_ET(</span></span>
<span id="cb15-18"><a href="physical-process-models.html#cb15-18" tabindex="-1"></a><span class="co">#   data = PET_data,</span></span>
<span id="cb15-19"><a href="physical-process-models.html#cb15-19" tabindex="-1"></a><span class="co">#   constants = constants,</span></span>
<span id="cb15-20"><a href="physical-process-models.html#cb15-20" tabindex="-1"></a><span class="co">#   ts = &quot;daily&quot;,        # Optional; defaults to &quot;daily&quot;</span></span>
<span id="cb15-21"><a href="physical-process-models.html#cb15-21" tabindex="-1"></a><span class="co">#   message = &quot;yes&quot;,     # Optional; prints summary </span></span>
<span id="cb15-22"><a href="physical-process-models.html#cb15-22" tabindex="-1"></a><span class="co">#   save.csv = &quot;no&quot;      # Optional; do not save results to a CSV</span></span>
<span id="cb15-23"><a href="physical-process-models.html#cb15-23" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div>
<p>Now we’ll add daily ET into our original dataframe:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="physical-process-models.html#cb16-1" tabindex="-1"></a><span class="co"># PET_mm &lt;- PET_Hargreaves$ET.Daily</span></span>
<span id="cb16-2"><a href="physical-process-models.html#cb16-2" tabindex="-1"></a><span class="co"># # put the approximated PET_mm into the larger indata df</span></span>
<span id="cb16-3"><a href="physical-process-models.html#cb16-3" tabindex="-1"></a><span class="co"># indata &lt;- cbind(indata, PET_mm)  #with cbind</span></span>
<span id="cb16-4"><a href="physical-process-models.html#cb16-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb16-5"><a href="physical-process-models.html#cb16-5" tabindex="-1"></a><span class="co"># head(indata)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="physical-process-models.html#cb17-1" tabindex="-1"></a><span class="co"># # Annual summary stats</span></span>
<span id="cb17-2"><a href="physical-process-models.html#cb17-2" tabindex="-1"></a><span class="co"># indata_analysis &lt;- indata %&gt;%</span></span>
<span id="cb17-3"><a href="physical-process-models.html#cb17-3" tabindex="-1"></a><span class="co">#   select(-date) %&gt;%</span></span>
<span id="cb17-4"><a href="physical-process-models.html#cb17-4" tabindex="-1"></a><span class="co">#   group_by(wtr_yr) %&gt;%</span></span>
<span id="cb17-5"><a href="physical-process-models.html#cb17-5" tabindex="-1"></a><span class="co">#   summarise(</span></span>
<span id="cb17-6"><a href="physical-process-models.html#cb17-6" tabindex="-1"></a><span class="co">#     weighted_precip.mm = sum(weighted_precip.mm, na.rm = TRUE),</span></span>
<span id="cb17-7"><a href="physical-process-models.html#cb17-7" tabindex="-1"></a><span class="co">#     Tmean_c = mean(Tmean_c, na.rm = TRUE),</span></span>
<span id="cb17-8"><a href="physical-process-models.html#cb17-8" tabindex="-1"></a><span class="co">#     swe.mm_max = max(weighted_swe.mm, na.rm = TRUE),</span></span>
<span id="cb17-9"><a href="physical-process-models.html#cb17-9" tabindex="-1"></a><span class="co">#     pcumul.mm_max = max(weighted_pcumul.mm, na.rm = TRUE),</span></span>
<span id="cb17-10"><a href="physical-process-models.html#cb17-10" tabindex="-1"></a><span class="co">#     Tmax = max(Tmax_c, na.rm = TRUE),</span></span>
<span id="cb17-11"><a href="physical-process-models.html#cb17-11" tabindex="-1"></a><span class="co">#     Tmin = min(Tmin_c, na.rm = TRUE),</span></span>
<span id="cb17-12"><a href="physical-process-models.html#cb17-12" tabindex="-1"></a><span class="co">#     Q_mm_sum = sum(Q_mm_day, na.rm = TRUE),</span></span>
<span id="cb17-13"><a href="physical-process-models.html#cb17-13" tabindex="-1"></a><span class="co">#     PET_mm_sum = sum(PET_mm, na.rm = TRUE), </span></span>
<span id="cb17-14"><a href="physical-process-models.html#cb17-14" tabindex="-1"></a><span class="co">#     runoff_input.mm = sum(runoff_input.mm, na.rm = TRUE),</span></span>
<span id="cb17-15"><a href="physical-process-models.html#cb17-15" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb17-16"><a href="physical-process-models.html#cb17-16" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb17-17"><a href="physical-process-models.html#cb17-17" tabindex="-1"></a><span class="co"># indata_analysis</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="physical-process-models.html#cb18-1" tabindex="-1"></a><span class="co"># # Your script below should fit your variables from your summary dataframe above. Here is an example of what a simple water balance might look like if I named my summary dataframe indata_analysis: </span></span>
<span id="cb18-2"><a href="physical-process-models.html#cb18-2" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb18-3"><a href="physical-process-models.html#cb18-3" tabindex="-1"></a><span class="co"># # Calculate the residual water after accounting for PET and discharge</span></span>
<span id="cb18-4"><a href="physical-process-models.html#cb18-4" tabindex="-1"></a><span class="co"># residual_water &lt;- indata_analysis$runoff_input.mm - (indata_analysis$PET_mm_sum + indata_analysis$Q_mm_sum)</span></span>
<span id="cb18-5"><a href="physical-process-models.html#cb18-5" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb18-6"><a href="physical-process-models.html#cb18-6" tabindex="-1"></a><span class="co"># # View the residual for each year</span></span>
<span id="cb18-7"><a href="physical-process-models.html#cb18-7" tabindex="-1"></a><span class="co"># print(residual_water)</span></span></code></pre></div>
<p>By subtracting discharge and PET from runoff_input, we’re essentially examining the residual water. This could represent the amount of water available to the system after accounting for the demand (PET) and the outflow (discharge).</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="physical-process-models.html#cb19-1" tabindex="-1"></a><span class="co"># # make long form with PETsum and Psum as the key-value pairs (exclude wtr_yr from )</span></span>
<span id="cb19-2"><a href="physical-process-models.html#cb19-2" tabindex="-1"></a><span class="co"># dat_sum_plot &lt;- indata_analysis %&gt;%</span></span>
<span id="cb19-3"><a href="physical-process-models.html#cb19-3" tabindex="-1"></a><span class="co">#   pivot_longer(names_to =  &quot;key&quot;, values_to =  &quot;value&quot;, -wtr_yr)</span></span>
<span id="cb19-4"><a href="physical-process-models.html#cb19-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb19-5"><a href="physical-process-models.html#cb19-5" tabindex="-1"></a><span class="co"># # bar plot pf PET and P for each year</span></span>
<span id="cb19-6"><a href="physical-process-models.html#cb19-6" tabindex="-1"></a><span class="co"># ggplot(dat_sum_plot, aes(x = wtr_yr, y = value, fill = key)) +</span></span>
<span id="cb19-7"><a href="physical-process-models.html#cb19-7" tabindex="-1"></a><span class="co">#   geom_bar(stat = &quot;identity&quot;, position = &quot;dodge&quot;) +</span></span>
<span id="cb19-8"><a href="physical-process-models.html#cb19-8" tabindex="-1"></a><span class="co">#   labs(x = &quot;Water Year&quot;, y = &quot;mm/year&quot;, fill = {})</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="physical-process-models.html#cb20-1" tabindex="-1"></a><span class="co"># </span><span class="al">###</span><span class="co"> TIMING</span></span>
<span id="cb20-2"><a href="physical-process-models.html#cb20-2" tabindex="-1"></a><span class="co"># # create weekly means or totals for both time series and plot them together to determine the timing of each </span></span>
<span id="cb20-3"><a href="physical-process-models.html#cb20-3" tabindex="-1"></a><span class="co"># dat_weekly &lt;- indata %&gt;%</span></span>
<span id="cb20-4"><a href="physical-process-models.html#cb20-4" tabindex="-1"></a><span class="co">#   group_by(Week = week(date)) %&gt;%</span></span>
<span id="cb20-5"><a href="physical-process-models.html#cb20-5" tabindex="-1"></a><span class="co">#   summarise(</span></span>
<span id="cb20-6"><a href="physical-process-models.html#cb20-6" tabindex="-1"></a><span class="co">#     PET = sum(PET_mm), </span></span>
<span id="cb20-7"><a href="physical-process-models.html#cb20-7" tabindex="-1"></a><span class="co">#     P = sum(runoff_input.mm)</span></span>
<span id="cb20-8"><a href="physical-process-models.html#cb20-8" tabindex="-1"></a><span class="co">#     ) %&gt;%</span></span>
<span id="cb20-9"><a href="physical-process-models.html#cb20-9" tabindex="-1"></a><span class="co">#     pivot_longer(names_to = &quot;key&quot;, values_to = &quot;value&quot;, -Week)</span></span>
<span id="cb20-10"><a href="physical-process-models.html#cb20-10" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-11"><a href="physical-process-models.html#cb20-11" tabindex="-1"></a><span class="co"># # line plot of P and PET on a weekly basis. Use dat_weekly as the data source.</span></span>
<span id="cb20-12"><a href="physical-process-models.html#cb20-12" tabindex="-1"></a><span class="co"># ggplot(dat_weekly, aes(x = Week, y = value, color = key)) +</span></span>
<span id="cb20-13"><a href="physical-process-models.html#cb20-13" tabindex="-1"></a><span class="co">#   geom_line() + # create line plot</span></span>
<span id="cb20-14"><a href="physical-process-models.html#cb20-14" tabindex="-1"></a><span class="co">#   labs(x = &quot;Week of Year&quot;, y = &quot;mm/year&quot;, color = {})</span></span></code></pre></div>
<div id="single-model-run" class="section level4 hasAnchor" number="5.3.3.1">
<h4><span class="header-section-number">5.3.3.1</span> Single model run<a href="physical-process-models.html#single-model-run" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Look at the parameters to make sure you know what each parameter does. The way the model is set up, is that everything is hidden inside a function. The user (–&gt; you) only formats the input data and passes the parameters to the function. All model output is contained in “modelRun”. If you look at the Environment, you will notice that modelRun is a list. A list is even more flexible in terms of data storage than a dataframe (a dataframe is actually a special type of list…). While lists are super flexible, they can also be more cumbersome to deal with. I included some code that takes the output from the model run and saves all the important bits and pieces in a convenient dataframe called HBVRun. For this part (single model runs), you will really only need the data contained in the HBVRun dataframe.</p>
</div>
<div id="single-model-execution" class="section level4 hasAnchor" number="5.3.3.2">
<h4><span class="header-section-number">5.3.3.2</span> single model execution<a href="physical-process-models.html#single-model-execution" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="physical-process-models.html#cb21-1" tabindex="-1"></a><span class="co"># # set up the parameter vector</span></span>
<span id="cb21-2"><a href="physical-process-models.html#cb21-2" tabindex="-1"></a><span class="co"># model_params &lt;- c(</span></span>
<span id="cb21-3"><a href="physical-process-models.html#cb21-3" tabindex="-1"></a><span class="co">#   1.05, # SCF snow correction factor [-] (e.g., 0.9-1.5);</span></span>
<span id="cb21-4"><a href="physical-process-models.html#cb21-4" tabindex="-1"></a><span class="co">#   1.80, # DDF degree day factor [mm/degC/timestep] (e.g., 0.0-5.0 mm/degC/day);</span></span>
<span id="cb21-5"><a href="physical-process-models.html#cb21-5" tabindex="-1"></a><span class="co">#   2, # Tr threshold temperature above which precipitation is rain [degC] (e.g., 1.0-3.0 degC);</span></span>
<span id="cb21-6"><a href="physical-process-models.html#cb21-6" tabindex="-1"></a><span class="co">#   0, # Ts threshold temperature below which precipitation is snow [degC] (e.g., -3.0-1.0 degC);</span></span>
<span id="cb21-7"><a href="physical-process-models.html#cb21-7" tabindex="-1"></a><span class="co">#   -0.336, # Tm threshold temperature above which melt starts [degC] (e.g., -2.0-2.0 degC);</span></span>
<span id="cb21-8"><a href="physical-process-models.html#cb21-8" tabindex="-1"></a><span class="co">#   0.2, # LPrat parameter related to the limit for potential evaporation [-] (e.g., 0.0-1.0);</span></span>
<span id="cb21-9"><a href="physical-process-models.html#cb21-9" tabindex="-1"></a><span class="co">#   121, # FC field capacity, i.e., max soil moisture storage [mm] (e.g., 0-600 mm);</span></span>
<span id="cb21-10"><a href="physical-process-models.html#cb21-10" tabindex="-1"></a><span class="co">#   2.52, # BETA the non linear parameter for runoff production [-] (e.g., 0.0-20.0);</span></span>
<span id="cb21-11"><a href="physical-process-models.html#cb21-11" tabindex="-1"></a><span class="co">#   0.473, # k0 storage coefficient for very fast response [timestep] (e.g., 0.0-2.0 days);</span></span>
<span id="cb21-12"><a href="physical-process-models.html#cb21-12" tabindex="-1"></a><span class="co">#   9.06, # k1 storage coefficient for fast response [timestep] (e.g., 2.0-30.0 days);</span></span>
<span id="cb21-13"><a href="physical-process-models.html#cb21-13" tabindex="-1"></a><span class="co">#   142, # k2 storage coefficient for slow response [timestep] (e.g., 30.0-250.0 days);</span></span>
<span id="cb21-14"><a href="physical-process-models.html#cb21-14" tabindex="-1"></a><span class="co">#   50.1, # lsuz threshold storage state, i.e., the very fast response start if exceeded [mm] (e.g., 1.0-100.0 mm);</span></span>
<span id="cb21-15"><a href="physical-process-models.html#cb21-15" tabindex="-1"></a><span class="co">#   2.38, # cperc constant percolation rate [mm/timestep] (e.g., 0.0-8.0 mm/day);</span></span>
<span id="cb21-16"><a href="physical-process-models.html#cb21-16" tabindex="-1"></a><span class="co">#   10, # bmax maximum base at low flows [timestep] (e.g., 0.0-30.0 days);</span></span>
<span id="cb21-17"><a href="physical-process-models.html#cb21-17" tabindex="-1"></a><span class="co">#   25 # croute free scaling parameter [timestep^2/mm] (e.g., 0.0-50.0 days^2/mm);</span></span>
<span id="cb21-18"><a href="physical-process-models.html#cb21-18" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb21-19"><a href="physical-process-models.html#cb21-19" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-20"><a href="physical-process-models.html#cb21-20" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-21"><a href="physical-process-models.html#cb21-21" tabindex="-1"></a><span class="co"># # set time period</span></span>
<span id="cb21-22"><a href="physical-process-models.html#cb21-22" tabindex="-1"></a><span class="co"># model_in &lt;- indata %&gt;%</span></span>
<span id="cb21-23"><a href="physical-process-models.html#cb21-23" tabindex="-1"></a><span class="co">#   filter(date &gt;= as_date(&quot;2017-10-01&quot;) &amp; date &lt;= as_date(&quot;2022-09-30&quot;))</span></span>
<span id="cb21-24"><a href="physical-process-models.html#cb21-24" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-25"><a href="physical-process-models.html#cb21-25" tabindex="-1"></a><span class="co"># # set up the model</span></span>
<span id="cb21-26"><a href="physical-process-models.html#cb21-26" tabindex="-1"></a><span class="co"># ## THIS IS THE ACTUAL MODEL EXECUTION</span></span>
<span id="cb21-27"><a href="physical-process-models.html#cb21-27" tabindex="-1"></a><span class="co"># modelRun &lt;- TUWmodel(</span></span>
<span id="cb21-28"><a href="physical-process-models.html#cb21-28" tabindex="-1"></a><span class="co">#   prec = model_in$weighted_precip.mm, # precip input</span></span>
<span id="cb21-29"><a href="physical-process-models.html#cb21-29" tabindex="-1"></a><span class="co">#   airt = model_in$Tmean_c, # air temp input</span></span>
<span id="cb21-30"><a href="physical-process-models.html#cb21-30" tabindex="-1"></a><span class="co">#   ep = model_in$PET_mm, # pet input</span></span>
<span id="cb21-31"><a href="physical-process-models.html#cb21-31" tabindex="-1"></a><span class="co">#   area = 1, # one zone for the entire watershed</span></span>
<span id="cb21-32"><a href="physical-process-models.html#cb21-32" tabindex="-1"></a><span class="co">#   param = model_params # input model parameters</span></span>
<span id="cb21-33"><a href="physical-process-models.html#cb21-33" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb21-34"><a href="physical-process-models.html#cb21-34" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-35"><a href="physical-process-models.html#cb21-35" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-36"><a href="physical-process-models.html#cb21-36" tabindex="-1"></a><span class="co"># # get all outputs into a nice df</span></span>
<span id="cb21-37"><a href="physical-process-models.html#cb21-37" tabindex="-1"></a><span class="co"># HBVRun &lt;- tibble(</span></span>
<span id="cb21-38"><a href="physical-process-models.html#cb21-38" tabindex="-1"></a><span class="co">#   Date = model_in$Date, # date</span></span>
<span id="cb21-39"><a href="physical-process-models.html#cb21-39" tabindex="-1"></a><span class="co">#   P_mm = modelRun$prec, # precip</span></span>
<span id="cb21-40"><a href="physical-process-models.html#cb21-40" tabindex="-1"></a><span class="co">#   Tair = modelRun$airt, # air temp</span></span>
<span id="cb21-41"><a href="physical-process-models.html#cb21-41" tabindex="-1"></a><span class="co">#   SWEobs = model_in$weighted_swe.mm, # observed swe</span></span>
<span id="cb21-42"><a href="physical-process-models.html#cb21-42" tabindex="-1"></a><span class="co">#   PET = modelRun$ep,# pet</span></span>
<span id="cb21-43"><a href="physical-process-models.html#cb21-43" tabindex="-1"></a><span class="co">#   Qobs = model_in$Q_mm_day, # observed discharge</span></span>
<span id="cb21-44"><a href="physical-process-models.html#cb21-44" tabindex="-1"></a><span class="co">#   Qsim = modelRun$q[1, ], # simulated discharge</span></span>
<span id="cb21-45"><a href="physical-process-models.html#cb21-45" tabindex="-1"></a><span class="co">#   Qsurf = modelRun$q0[1, ], # surface runoff</span></span>
<span id="cb21-46"><a href="physical-process-models.html#cb21-46" tabindex="-1"></a><span class="co">#   Qsubsurf = modelRun$q1[1, ], # subsurface flow</span></span>
<span id="cb21-47"><a href="physical-process-models.html#cb21-47" tabindex="-1"></a><span class="co">#   Qbase = modelRun$q2[1, ], # groundwater flow</span></span>
<span id="cb21-48"><a href="physical-process-models.html#cb21-48" tabindex="-1"></a><span class="co">#   Rain = modelRun$rain[1, ], # simulated rain</span></span>
<span id="cb21-49"><a href="physical-process-models.html#cb21-49" tabindex="-1"></a><span class="co">#   Snow = modelRun$snow[1, ], # simulated snowfall</span></span>
<span id="cb21-50"><a href="physical-process-models.html#cb21-50" tabindex="-1"></a><span class="co">#   Melt = modelRun$melt[1, ], # simulated melt</span></span>
<span id="cb21-51"><a href="physical-process-models.html#cb21-51" tabindex="-1"></a><span class="co">#   SWEsim = modelRun$swe[1, ], # simulated swe</span></span>
<span id="cb21-52"><a href="physical-process-models.html#cb21-52" tabindex="-1"></a><span class="co">#   Soilmoist = modelRun$moist[1, ], # simulated soil storage</span></span>
<span id="cb21-53"><a href="physical-process-models.html#cb21-53" tabindex="-1"></a><span class="co">#   AET = modelRun$eta[1, ], # simulated evapotranspiration</span></span>
<span id="cb21-54"><a href="physical-process-models.html#cb21-54" tabindex="-1"></a><span class="co">#   StorageUpper = modelRun$suz[1, ], # upper storage value</span></span>
<span id="cb21-55"><a href="physical-process-models.html#cb21-55" tabindex="-1"></a><span class="co">#   StorageLower = modelRun$slz[1, ] # lower storage value</span></span>
<span id="cb21-56"><a href="physical-process-models.html#cb21-56" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div>
</div>
<div id="objective-functions" class="section level4 hasAnchor" number="5.3.3.3">
<h4><span class="header-section-number">5.3.3.3</span> Objective functions<a href="physical-process-models.html#objective-functions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="kge" class="section level5 hasAnchor" number="5.3.3.3.1">
<h5><span class="header-section-number">5.3.3.3.1</span> KGE<a href="physical-process-models.html#kge" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Before we can start trying to tune our model to look more like the
observed discharge record, it would be helpful to have some sort of
quantified metric for how well our modeled data fits the measured data.</p>
<p>There are many different ways to do this, but discussion of the pros and cons of those approaches is beyond this quick introduction to modeling.</p>
<p>Here we will demonstrate the Kling-Gupta efficiency both for runoff as well as for swe.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="physical-process-models.html#cb22-1" tabindex="-1"></a><span class="co"># # select the Qobs and Qsim timeseries</span></span>
<span id="cb22-2"><a href="physical-process-models.html#cb22-2" tabindex="-1"></a><span class="co"># # DON&#39;T FORGET TO EXCLUDE THE FIRST YEAR</span></span>
<span id="cb22-3"><a href="physical-process-models.html#cb22-3" tabindex="-1"></a><span class="co"># Qobs &lt;- HBVRun$Qobs[366:length(HBVRun$Qobs)] # observed runoff WITHOUT WARM-UP PERIOD</span></span>
<span id="cb22-4"><a href="physical-process-models.html#cb22-4" tabindex="-1"></a><span class="co"># Qsim &lt;- HBVRun$Qsim[366:length(HBVRun$Qsim)] # simulated runoff WITHOUT WARM-UP PERIOD</span></span>
<span id="cb22-5"><a href="physical-process-models.html#cb22-5" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb22-6"><a href="physical-process-models.html#cb22-6" tabindex="-1"></a><span class="co"># # KGE</span></span>
<span id="cb22-7"><a href="physical-process-models.html#cb22-7" tabindex="-1"></a><span class="co"># kge_r_q &lt;- cor(Qobs, Qsim)</span></span>
<span id="cb22-8"><a href="physical-process-models.html#cb22-8" tabindex="-1"></a><span class="co"># kge_beta_q &lt;- mean(Qsim) / mean(Qobs)</span></span>
<span id="cb22-9"><a href="physical-process-models.html#cb22-9" tabindex="-1"></a><span class="co"># kge_gamma_q &lt;- (sd(Qsim) / mean(Qsim)) / (sd(Qobs) / mean(Qobs))</span></span>
<span id="cb22-10"><a href="physical-process-models.html#cb22-10" tabindex="-1"></a><span class="co"># kge_q &lt;- 1 - sqrt((kge_r_q - 1)^2 + (kge_beta_q - 1)^2 + (kge_gamma_q - 1)^2)</span></span>
<span id="cb22-11"><a href="physical-process-models.html#cb22-11" tabindex="-1"></a><span class="co"># kge_q</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="physical-process-models.html#cb23-1" tabindex="-1"></a><span class="co"># ## Snow - water equivalent</span></span>
<span id="cb23-2"><a href="physical-process-models.html#cb23-2" tabindex="-1"></a><span class="co"># SWEobs &lt;- HBVRun$SWEobs[366:length(HBVRun$SWEobs)] # observed swe WITHOUT WARM-UP PERIOD</span></span>
<span id="cb23-3"><a href="physical-process-models.html#cb23-3" tabindex="-1"></a><span class="co"># SWEsim &lt;- HBVRun$SWEsim[366:length(HBVRun$SWEobs)] # simulated swe WITHOUT WARM-UP PERIOD</span></span>
<span id="cb23-4"><a href="physical-process-models.html#cb23-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb23-5"><a href="physical-process-models.html#cb23-5" tabindex="-1"></a><span class="co"># # KGE</span></span>
<span id="cb23-6"><a href="physical-process-models.html#cb23-6" tabindex="-1"></a><span class="co"># kge_r_swe &lt;- cor(SWEobs, SWEsim)</span></span>
<span id="cb23-7"><a href="physical-process-models.html#cb23-7" tabindex="-1"></a><span class="co"># kge_beta_swe &lt;- mean(SWEsim) / mean(SWEobs)</span></span>
<span id="cb23-8"><a href="physical-process-models.html#cb23-8" tabindex="-1"></a><span class="co"># kge_gamma_swe &lt;- (sd(SWEsim) / mean(SWEsim)) / (sd(SWEobs) / mean(SWEobs))</span></span>
<span id="cb23-9"><a href="physical-process-models.html#cb23-9" tabindex="-1"></a><span class="co"># kge_swe &lt;- 1 - sqrt((kge_r_swe - 1)^2 + (kge_beta_swe - 1)^2 + (kge_gamma_swe - 1)^2)</span></span>
<span id="cb23-10"><a href="physical-process-models.html#cb23-10" tabindex="-1"></a><span class="co"># kge_swe</span></span></code></pre></div>
</div>
<div id="nash-sutcliffe-efficiency-nse." class="section level5 hasAnchor" number="5.3.3.3.2">
<h5><span class="header-section-number">5.3.3.3.2</span> Nash-Sutcliffe Efficiency (NSE).<a href="physical-process-models.html#nash-sutcliffe-efficiency-nse." class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Basically, the NSE looks at how much better your model run did that if you had just used the mean discharge for the data record as your “modelled results”. It does this by comparing how far off the observed values where from the mean discharge to how far off the modeled values were from the observed discharge. –&gt;
Mathematically, NSE is the sum of the squared differences between the modeled and observed discharge divided by the sum of the squared differences between the observed and mean discharge, subtracted by 1.</p>
<p><span class="math display">\[ NSE = 1 - \frac{\sum_{t = 1}^{T}{(Q_m^t - Q_o^t)^2}}{\sum_{t = 1}^{T}{(Q_o^t - \bar{Q_o})^2}}
\]</span>
Where <span class="math inline">\(Q_m^t\)</span> is modeled discharge at time t, <span class="math inline">\(Q_o^t\)</span> is observed</p>
<p>discharge at time t, and <span class="math inline">\(\bar{Q_o}\)</span> is mean observed discharge.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="physical-process-models.html#cb24-1" tabindex="-1"></a><span class="co"># #Calculate NSE for snow, SWE is modeled, STA2 is measured</span></span>
<span id="cb24-2"><a href="physical-process-models.html#cb24-2" tabindex="-1"></a><span class="co"># NSE_Q &lt;- 1 - ((sum((HBVRun$Qobs - HBVRun$Qsim) ^ 2)) / </span></span>
<span id="cb24-3"><a href="physical-process-models.html#cb24-3" tabindex="-1"></a><span class="co">#                  sum((HBVRun$Qsim - mean(HBVRun$Qsim)) ^ 2))</span></span>
<span id="cb24-4"><a href="physical-process-models.html#cb24-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb24-5"><a href="physical-process-models.html#cb24-5" tabindex="-1"></a><span class="co"># NSE_Q</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="physical-process-models.html#cb25-1" tabindex="-1"></a><span class="co"># #Calculate NSE for snow, SWE is modeled, STA2 is measured</span></span>
<span id="cb25-2"><a href="physical-process-models.html#cb25-2" tabindex="-1"></a><span class="co"># NSEsno &lt;- 1 - ((sum((HBVRun$SWEobs - HBVRun$SWEsim) ^ 2)) / </span></span>
<span id="cb25-3"><a href="physical-process-models.html#cb25-3" tabindex="-1"></a><span class="co">#                  sum((HBVRun$SWEsim - mean(HBVRun$SWEsim)) ^ 2))</span></span>
<span id="cb25-4"><a href="physical-process-models.html#cb25-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb25-5"><a href="physical-process-models.html#cb25-5" tabindex="-1"></a><span class="co"># NSEsno</span></span></code></pre></div>
</div>
</div>
<div id="calibrate-hbv-manually" class="section level4 hasAnchor" number="5.3.3.4">
<h4><span class="header-section-number">5.3.3.4</span> Calibrate HBV manually<a href="physical-process-models.html#calibrate-hbv-manually" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Woohoo! We can now run our model and assess how well it is working!</p>
<p>Now, let’s see how well we can get it to work. The code below runs the model, produces a plot, and calculates the NSE based on discharge.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="physical-process-models.html#cb26-1" tabindex="-1"></a><span class="co"># #when this term = 1, then triangular routing is invoked, or for no routing, routing = 0</span></span>
<span id="cb26-2"><a href="physical-process-models.html#cb26-2" tabindex="-1"></a><span class="co"># #if routing = 0 then MAXBAS doesn&#39;t do anything</span></span>
<span id="cb26-3"><a href="physical-process-models.html#cb26-3" tabindex="-1"></a><span class="co"># routing &lt;- 0      </span></span>
<span id="cb26-4"><a href="physical-process-models.html#cb26-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb26-5"><a href="physical-process-models.html#cb26-5" tabindex="-1"></a><span class="co"># #hard code parameters </span></span>
<span id="cb26-6"><a href="physical-process-models.html#cb26-6" tabindex="-1"></a><span class="co"># params &lt;- c(40,     #FCM ax soil moisture storage, field capacity</span></span>
<span id="cb26-7"><a href="physical-process-models.html#cb26-7" tabindex="-1"></a><span class="co">#             1,      #beta Shape coefficient governing fate of water input to soil moisture storage</span></span>
<span id="cb26-8"><a href="physical-process-models.html#cb26-8" tabindex="-1"></a><span class="co">#             0.3,    #LP Threshold for reduction of evap</span></span>
<span id="cb26-9"><a href="physical-process-models.html#cb26-9" tabindex="-1"></a><span class="co">#             0.4,    #SFCF Snowfall correction factor</span></span>
<span id="cb26-10"><a href="physical-process-models.html#cb26-10" tabindex="-1"></a><span class="co">#             -1.5,   #TT Threshold temperature</span></span>
<span id="cb26-11"><a href="physical-process-models.html#cb26-11" tabindex="-1"></a><span class="co">#             1,      #CFMAX Degree-day factor</span></span>
<span id="cb26-12"><a href="physical-process-models.html#cb26-12" tabindex="-1"></a><span class="co">#             0.05,   #k0 Recession constant (upper storage, near surface)</span></span>
<span id="cb26-13"><a href="physical-process-models.html#cb26-13" tabindex="-1"></a><span class="co">#             0.01,   #k1 Recession constant (upper storage)</span></span>
<span id="cb26-14"><a href="physical-process-models.html#cb26-14" tabindex="-1"></a><span class="co">#             0.001,  #k2 Recession constant (lower storage)</span></span>
<span id="cb26-15"><a href="physical-process-models.html#cb26-15" tabindex="-1"></a><span class="co">#             0,      #UZL Threshold for shallow storage</span></span>
<span id="cb26-16"><a href="physical-process-models.html#cb26-16" tabindex="-1"></a><span class="co">#             0,      #PERC Percolation, max flow from upper to lower storage</span></span>
<span id="cb26-17"><a href="physical-process-models.html#cb26-17" tabindex="-1"></a><span class="co">#             1       #MAXBAS base of the triangular routing function, days</span></span>
<span id="cb26-18"><a href="physical-process-models.html#cb26-18" tabindex="-1"></a><span class="co">#             )</span></span>
<span id="cb26-19"><a href="physical-process-models.html#cb26-19" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb26-20"><a href="physical-process-models.html#cb26-20" tabindex="-1"></a><span class="co"># #Run the model</span></span>
<span id="cb26-21"><a href="physical-process-models.html#cb26-21" tabindex="-1"></a><span class="co"># Out &lt;- HBV(params, P, Temp, PET, routing)</span></span>
<span id="cb26-22"><a href="physical-process-models.html#cb26-22" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb26-23"><a href="physical-process-models.html#cb26-23" tabindex="-1"></a><span class="co"># #Add observed output</span></span>
<span id="cb26-24"><a href="physical-process-models.html#cb26-24" tabindex="-1"></a><span class="co"># Out &lt;- bind_cols(Out, Qobs1)</span></span>
<span id="cb26-25"><a href="physical-process-models.html#cb26-25" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb26-26"><a href="physical-process-models.html#cb26-26" tabindex="-1"></a><span class="co"># #Trim out the warm up period</span></span>
<span id="cb26-27"><a href="physical-process-models.html#cb26-27" tabindex="-1"></a><span class="co"># OutTrim &lt;- filter(Out, DATE &gt;= mdy(&quot;01-01-2011&quot;))</span></span>
<span id="cb26-28"><a href="physical-process-models.html#cb26-28" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb26-29"><a href="physical-process-models.html#cb26-29" tabindex="-1"></a><span class="co"># #Calculate NSE</span></span>
<span id="cb26-30"><a href="physical-process-models.html#cb26-30" tabindex="-1"></a><span class="co"># NSE &lt;- 1 - ((sum((OutTrim$q - OutTrim$WS_3) ^ 2)) / </span></span>
<span id="cb26-31"><a href="physical-process-models.html#cb26-31" tabindex="-1"></a><span class="co">#                  sum((OutTrim$WS_3 - mean(OutTrim$WS_3)) ^ 2))</span></span>
<span id="cb26-32"><a href="physical-process-models.html#cb26-32" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb26-33"><a href="physical-process-models.html#cb26-33" tabindex="-1"></a><span class="co"># #Create plot with NSE in title</span></span>
<span id="cb26-34"><a href="physical-process-models.html#cb26-34" tabindex="-1"></a><span class="co"># OutTrim %&gt;% plot_ly(x = ~DATE) %&gt;% </span></span>
<span id="cb26-35"><a href="physical-process-models.html#cb26-35" tabindex="-1"></a><span class="co">#         add_trace(y = ~q, name = &#39;Modeled&#39;,  type = &#39;scatter&#39;, mode = &#39;lines&#39;) %&gt;% </span></span>
<span id="cb26-36"><a href="physical-process-models.html#cb26-36" tabindex="-1"></a><span class="co">#         add_trace(y = ~WS_3, name = &#39;Measured&#39;, type = &#39;scatter&#39;, mode = &#39;lines&#39;) %&gt;% </span></span>
<span id="cb26-37"><a href="physical-process-models.html#cb26-37" tabindex="-1"></a><span class="co">#         layout(title=paste(&quot;NSE: &quot;, round(NSE,2)))</span></span></code></pre></div>
</div>
<div id="plot-observed-and-model-simulations" class="section level4 hasAnchor" number="5.3.3.5">
<h4><span class="header-section-number">5.3.3.5</span> Plot observed and model simulations<a href="physical-process-models.html#plot-observed-and-model-simulations" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Generate plots that include and compare the different modeled fluxes from your best NSE. Some of those fluxes can be immediately compared to observed data (e.g., runoff or SWE), while others only exist in simulated form (e.g., storages or outflows of the various runoff components) and need to be assessed with the perceptual model in mind.<br />
Make sure that the axes are properly labeled when you create plots. The script below will get you started.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="physical-process-models.html#cb27-1" tabindex="-1"></a><span class="co"># # Add date to the HBVRun result tibble</span></span>
<span id="cb27-2"><a href="physical-process-models.html#cb27-2" tabindex="-1"></a><span class="co"># HBVRun &lt;- as.data.frame(HBVRun)</span></span>
<span id="cb27-3"><a href="physical-process-models.html#cb27-3" tabindex="-1"></a><span class="co"># HBVRun$Date &lt;- model_in$date</span></span>
<span id="cb27-4"><a href="physical-process-models.html#cb27-4" tabindex="-1"></a><span class="co"># str(HBVRun)</span></span>
<span id="cb27-5"><a href="physical-process-models.html#cb27-5" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb27-6"><a href="physical-process-models.html#cb27-6" tabindex="-1"></a><span class="co"># # Overall runoff (Qsim and Qobs)</span></span>
<span id="cb27-7"><a href="physical-process-models.html#cb27-7" tabindex="-1"></a><span class="co"># q_plot &lt;- ggplot(data = HBVRun) +</span></span>
<span id="cb27-8"><a href="physical-process-models.html#cb27-8" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = Qobs, color = &quot;Qobs&quot;)) + # Qobs</span></span>
<span id="cb27-9"><a href="physical-process-models.html#cb27-9" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = Qsim, color = &quot;Qsim&quot;)) + # Qsim</span></span>
<span id="cb27-10"><a href="physical-process-models.html#cb27-10" tabindex="-1"></a><span class="co">#   labs(x = {}, y = &quot;Q (mm/day)&quot;, color = {}, title = &quot;Qobs and Qsim&quot;)</span></span>
<span id="cb27-11"><a href="physical-process-models.html#cb27-11" tabindex="-1"></a><span class="co"># ggplotly(q_plot)</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="physical-process-models.html#cb28-1" tabindex="-1"></a><span class="co"># Swe</span></span>
<span id="cb28-2"><a href="physical-process-models.html#cb28-2" tabindex="-1"></a><span class="co"># swe_plot &lt;- ggplot(data = HBVRun) +</span></span>
<span id="cb28-3"><a href="physical-process-models.html#cb28-3" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = SWEobs, color = &quot;SWEobs&quot;)) + # SWEobs</span></span>
<span id="cb28-4"><a href="physical-process-models.html#cb28-4" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = SWEsim, color = &quot;SWEsim&quot;)) + # SWEsim</span></span>
<span id="cb28-5"><a href="physical-process-models.html#cb28-5" tabindex="-1"></a><span class="co">#   labs(x = {}, y = &quot;SWE (mm)&quot;, color = {})</span></span>
<span id="cb28-6"><a href="physical-process-models.html#cb28-6" tabindex="-1"></a><span class="co"># ggplotly(swe_plot)</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="physical-process-models.html#cb29-1" tabindex="-1"></a><span class="co"># q_bucket_plot &lt;- ggplot(data = HBVRun) +</span></span>
<span id="cb29-2"><a href="physical-process-models.html#cb29-2" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = Qsurf, color = &quot;Qsurf&quot;)) + # Qsurf</span></span>
<span id="cb29-3"><a href="physical-process-models.html#cb29-3" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = Qsubsurf, color = &quot;Qsubsurf&quot;)) + #Qsubsurf</span></span>
<span id="cb29-4"><a href="physical-process-models.html#cb29-4" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = Qbase, color = &quot;Qbase&quot;)) + # Qbase</span></span>
<span id="cb29-5"><a href="physical-process-models.html#cb29-5" tabindex="-1"></a><span class="co">#   labs(x = {}, y = &quot;Q (mm)&quot;, color = {}, title = &quot;Q0, Q1, and Q2&quot;)</span></span>
<span id="cb29-6"><a href="physical-process-models.html#cb29-6" tabindex="-1"></a><span class="co"># ggplotly(q_bucket_plot)</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="physical-process-models.html#cb30-1" tabindex="-1"></a><span class="co"># # PET and AET</span></span>
<span id="cb30-2"><a href="physical-process-models.html#cb30-2" tabindex="-1"></a><span class="co"># pet_plot &lt;- ggplot(data = HBVRun) +</span></span>
<span id="cb30-3"><a href="physical-process-models.html#cb30-3" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = PET, color = &quot;PET&quot;)) + # PET</span></span>
<span id="cb30-4"><a href="physical-process-models.html#cb30-4" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = AET, color = &quot;AET&quot;)) + # AET</span></span>
<span id="cb30-5"><a href="physical-process-models.html#cb30-5" tabindex="-1"></a><span class="co">#   labs(x = {}, y = &quot;Flux (mm)&quot;, color = {}, title = &quot;PET and AET&quot;)</span></span>
<span id="cb30-6"><a href="physical-process-models.html#cb30-6" tabindex="-1"></a><span class="co"># ggplotly(pet_plot)</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="physical-process-models.html#cb31-1" tabindex="-1"></a><span class="co"># # Storages</span></span>
<span id="cb31-2"><a href="physical-process-models.html#cb31-2" tabindex="-1"></a><span class="co"># storage_plot &lt;- ggplot(data = HBVRun) +</span></span>
<span id="cb31-3"><a href="physical-process-models.html#cb31-3" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = Soilmoist, color = &quot;Soil moisture storage&quot;)) + # soil moisture storage</span></span>
<span id="cb31-4"><a href="physical-process-models.html#cb31-4" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = StorageUpper, color = &quot;Upper storage&quot;)) + # upper storage</span></span>
<span id="cb31-5"><a href="physical-process-models.html#cb31-5" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = StorageLower, color = &quot;Lower storage&quot;)) + # lower storage</span></span>
<span id="cb31-6"><a href="physical-process-models.html#cb31-6" tabindex="-1"></a><span class="co">#   labs(x = {}, y = &quot;Storage (mm)&quot;, color = {}, title = &quot;Storages&quot;)</span></span>
<span id="cb31-7"><a href="physical-process-models.html#cb31-7" tabindex="-1"></a><span class="co"># ggplotly(storage_plot)</span></span></code></pre></div>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="model-classification-and-application.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="spatial-models-and-gis-integration.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/tpcovino/lres_546_bookdown/edit/main/08_snowmelt_models.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": "https://github.com/tpcovino/lres_546_bookdown/blob/main/08_snowmelt_models.Rmd",
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
