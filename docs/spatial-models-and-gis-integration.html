<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 Spatial Models and GIS Integration | Quantitative Environmental Methods: LRES 546</title>
  <meta name="description" content="Chapter 7 Spatial Models and GIS Integration | Quantitative Environmental Methods: LRES 546" />
  <meta name="generator" content="bookdown 0.46 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 Spatial Models and GIS Integration | Quantitative Environmental Methods: LRES 546" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 Spatial Models and GIS Integration | Quantitative Environmental Methods: LRES 546" />
  
  
  

<meta name="author" content="Tim Covino &amp; Lauren Kremer" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="physical-process-models.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">lres_546</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Part 1: Foundations of Environmental Modeling</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#course-overview-and-objectives"><i class="fa fa-check"></i><b>1.2</b> Course overview and objectives</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#course-description"><i class="fa fa-check"></i><b>1.3</b> Course Description</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#structure"><i class="fa fa-check"></i><b>1.4</b> Structure</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#philosophical-approach-and-resources"><i class="fa fa-check"></i><b>1.5</b> Philosophical approach and resources</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#tentative-schedule-subject-to-change"><i class="fa fa-check"></i><b>1.6</b> Tentative schedule, subject to change</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="r-tutorial.html"><a href="r-tutorial.html"><i class="fa fa-check"></i><b>2</b> R Tutorial</a></li>
<li class="chapter" data-level="3" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><i class="fa fa-check"></i><b>3</b> Fundamentals of Hydrological Analysis - Physical Hydrology and Empirical Methods</a>
<ul>
<li class="chapter" data-level="3.1" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#hydrograph-separation"><i class="fa fa-check"></i><b>3.1</b> Hydrograph separation</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#learning-module-1"><i class="fa fa-check"></i><b>3.1.1</b> Learning Module 1</a></li>
<li class="chapter" data-level="3.1.2" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#labwork-20-pts"><i class="fa fa-check"></i><b>3.1.2</b> Labwork (20 pts)</a></li>
<li class="chapter" data-level="3.1.3" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#repo-link"><i class="fa fa-check"></i><b>3.1.3</b> Repo link</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#return-intervals"><i class="fa fa-check"></i><b>3.2</b> Return Intervals</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#learning-module-2"><i class="fa fa-check"></i><b>3.2.1</b> Learning Module 2</a></li>
<li class="chapter" data-level="3.2.2" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#repo-link-1"><i class="fa fa-check"></i><b>3.2.2</b> Repo link</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#rational-method-and-nrcs-curve-number-20-pts"><i class="fa fa-check"></i><b>3.3</b> Rational method and NRCS curve number (20 pts)</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#learning-module-3"><i class="fa fa-check"></i><b>3.3.1</b> Learning Module 3</a></li>
<li class="chapter" data-level="3.3.2" data-path="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html"><a href="fundamentals-of-hydrological-analysis---physical-hydrology-and-empirical-methods.html#repo-link-2"><i class="fa fa-check"></i><b>3.3.2</b> Repo link</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="probabilistic-and-process-simulation.html"><a href="probabilistic-and-process-simulation.html"><i class="fa fa-check"></i><b>4</b> Probabilistic and Process Simulation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="probabilistic-and-process-simulation.html"><a href="probabilistic-and-process-simulation.html#transfer-function-rainfall-runoff-models"><i class="fa fa-check"></i><b>4.1</b> Transfer function rainfall-runoff models</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="probabilistic-and-process-simulation.html"><a href="probabilistic-and-process-simulation.html#learning-module-4"><i class="fa fa-check"></i><b>4.1.1</b> Learning Module 4</a></li>
<li class="chapter" data-level="4.1.2" data-path="probabilistic-and-process-simulation.html"><a href="probabilistic-and-process-simulation.html#repo-link-3"><i class="fa fa-check"></i><b>4.1.2</b> Repo link</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="probabilistic-and-process-simulation.html"><a href="probabilistic-and-process-simulation.html#monte-carlo-simulation"><i class="fa fa-check"></i><b>4.2</b> Monte Carlo Simulation</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="probabilistic-and-process-simulation.html"><a href="probabilistic-and-process-simulation.html#learning-module-5"><i class="fa fa-check"></i><b>4.2.1</b> Learning Module 5</a></li>
<li class="chapter" data-level="4.2.2" data-path="probabilistic-and-process-simulation.html"><a href="probabilistic-and-process-simulation.html#repo-link-4"><i class="fa fa-check"></i><b>4.2.2</b> Repo link</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-retrieval-and-application.html"><a href="data-retrieval-and-application.html"><i class="fa fa-check"></i><b>5</b> Data Retrieval and Application</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-retrieval-and-application.html"><a href="data-retrieval-and-application.html#classifying-model-structure"><i class="fa fa-check"></i><b>5.1</b> Classifying model structure</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="data-retrieval-and-application.html"><a href="data-retrieval-and-application.html#learning-module-6"><i class="fa fa-check"></i><b>5.1.1</b> Learning Module 6</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="data-retrieval-and-application.html"><a href="data-retrieval-and-application.html#gridded-and-tabular-data-retrieval"><i class="fa fa-check"></i><b>5.2</b> Gridded and tabular data retrieval</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="data-retrieval-and-application.html"><a href="data-retrieval-and-application.html#learning-module-7"><i class="fa fa-check"></i><b>5.2.1</b> Learning Module 7</a></li>
<li class="chapter" data-level="5.2.2" data-path="data-retrieval-and-application.html"><a href="data-retrieval-and-application.html#repo-link-5"><i class="fa fa-check"></i><b>5.2.2</b> Repo link</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="data-retrieval-and-application.html"><a href="data-retrieval-and-application.html#term-project-assignment-1---10-pnts"><i class="fa fa-check"></i><b>5.3</b> Term Project Assignment 1 - 10 pnts</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="physical-process-models.html"><a href="physical-process-models.html"><i class="fa fa-check"></i><b>6</b> Physical Process Models</a>
<ul>
<li class="chapter" data-level="6.1" data-path="physical-process-models.html"><a href="physical-process-models.html#snowmelt-models"><i class="fa fa-check"></i><b>6.1</b> Snowmelt Models</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="physical-process-models.html"><a href="physical-process-models.html#learning-module-9"><i class="fa fa-check"></i><b>6.1.1</b> Learning Module 9</a></li>
<li class="chapter" data-level="6.1.2" data-path="physical-process-models.html"><a href="physical-process-models.html#labwork-20-pnts"><i class="fa fa-check"></i><b>6.1.2</b> Labwork (20 pnts)</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="physical-process-models.html"><a href="physical-process-models.html#evapotranspiration"><i class="fa fa-check"></i><b>6.2</b> Evapotranspiration</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="physical-process-models.html"><a href="physical-process-models.html#repo-here"><i class="fa fa-check"></i><b>6.2.1</b> Repo here</a></li>
<li class="chapter" data-level="6.2.2" data-path="physical-process-models.html"><a href="physical-process-models.html#learning-module-10"><i class="fa fa-check"></i><b>6.2.2</b> Learning Module 10</a></li>
<li class="chapter" data-level="6.2.3" data-path="physical-process-models.html"><a href="physical-process-models.html#labwork-20-pts-1"><i class="fa fa-check"></i><b>6.2.3</b> Labwork (20 pts):</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html"><i class="fa fa-check"></i><b>7</b> Spatial Models and GIS Integration</a>
<ul>
<li class="chapter" data-level="7.1" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#dem-processing"><i class="fa fa-check"></i><b>7.1</b> DEM processing</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#learning-module-11"><i class="fa fa-check"></i><b>7.1.1</b> Learning Module 11</a></li>
<li class="chapter" data-level="7.1.2" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#the-link-to-the-repo-is-here"><i class="fa fa-check"></i><b>7.1.2</b> THE LINK TO THE REPO IS HERE</a></li>
<li class="chapter" data-level="7.1.3" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#labwork-20-pts-2"><i class="fa fa-check"></i><b>7.1.3</b> Labwork (20 pts)</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#hbv-hydrology-model"><i class="fa fa-check"></i><b>7.2</b> HBV Hydrology Model</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#learning-module-12"><i class="fa fa-check"></i><b>7.2.1</b> Learning Module 12</a></li>
<li class="chapter" data-level="7.2.2" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#repo-link-6"><i class="fa fa-check"></i><b>7.2.2</b> Repo link</a></li>
<li class="chapter" data-level="7.2.3" data-path="spatial-models-and-gis-integration.html"><a href="spatial-models-and-gis-integration.html#labwork-20-pnts-1"><i class="fa fa-check"></i><b>7.2.3</b> Labwork (20 pnts)</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Quantitative Environmental Methods: LRES 546</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatial-models-and-gis-integration" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">Chapter 7</span> Spatial Models and GIS Integration<a href="spatial-models-and-gis-integration.html#spatial-models-and-gis-integration" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="dem-processing" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> DEM processing<a href="spatial-models-and-gis-integration.html#dem-processing" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="learning-module-11" class="section level3 hasAnchor" number="7.1.1">
<h3><span class="header-section-number">7.1.1</span> Learning Module 11<a href="spatial-models-and-gis-integration.html#learning-module-11" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="objective" class="section level4 hasAnchor" number="7.1.1.1">
<h4><span class="header-section-number">7.1.1.1</span> Objective:<a href="spatial-models-and-gis-integration.html#objective" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Users will explore basic hydrological tools through the process of DEM preprocessing and defining stream networks for a watershed in the Fraser Experimental Forest in Colorado using Whitebox Tools for R. This exercise will also demonstrate methods for writing functions and efficiently handling multiple files simultaneously, including importing, processing, and exporting data within the context of Whitebox Tools for R.</p>
<p>Hydrological analysis preprocessing involves the use of digital elevation model (DEM) raster data to establish a watershed model and a simulation of surface hydrological processes. These steps enable us to quantify key parameters such as flow accumulation, stream network characteristics, and hydrological connectivity, which are essential for studying the dynamics of water movement within a landscape. Overall, preprocessing is the set of foundational steps in hydrological modeling and analysis.</p>
<p><strong>Whitebox Tools</strong> is an advanced geospatial data analysis platform that can be used to perform common geographical information systems (GIS) analysis operations. This platform was developed with the Center for Hydrogeomatics in Guelph University so it is focused on hydrological analysis. With just a DEM, it allows us to produce a multitude of outputs that can be used for future analysis (Lindsay, 2016) <a href="doi:10.1016/j.cageo.2016.07.003" class="uri">doi:10.1016/j.cageo.2016.07.003</a>). While we are demonstrating its use in R, these tools are also available in QGIS and Python platforms.</p>
</div>
</div>
<div id="the-link-to-the-repo-is-here" class="section level3 hasAnchor" number="7.1.2">
<h3><span class="header-section-number">7.1.2</span> THE <a href="https://github.com/lekokremer/10_dem_processing" target="_blank">LINK TO THE REPO IS HERE</a><a href="spatial-models-and-gis-integration.html#the-link-to-the-repo-is-here" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
<div id="labwork-20-pts-2" class="section level3 hasAnchor" number="7.1.3">
<h3><span class="header-section-number">7.1.3</span> Labwork (20 pts)<a href="spatial-models-and-gis-integration.html#labwork-20-pts-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="installing-libraries" class="section level4 hasAnchor" number="7.1.3.1">
<h4><span class="header-section-number">7.1.3.1</span> Installing libraries<a href="spatial-models-and-gis-integration.html#installing-libraries" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We are going to try installing the whitebox R package from CRAN as it should be the simplest method.</p>
<p>However, if this does not work for you, you can install the development version from GitHub by putting this inside a code chunk:</p>
<p>if (!require(“remotes”)) install.packages(‘remotes’)
remotes::install_github(“opengeos/whiteboxR”, build = FALSE)</p>
<p>More information on installation can be found at: <a href="https://cran.r-project.org/web/packages/whitebox/readme/README.html" class="uri">https://cran.r-project.org/web/packages/whitebox/readme/README.html</a></p>
<p>Helpful whitebox documentation can be found at <a href="https://jblindsay.github.io/wbt_book/preface.html" class="uri">https://jblindsay.github.io/wbt_book/preface.html</a>.
Essentially, we will be using input rasters via filepath and output filepaths as arguments for various whitebox functions. The script is designed to perform functions on all rasters in a given folder at once.</p>
<p>When writing scripts, developers typically follow a standard workflow:<br>
1. Import required libraries <br>
2. Generate functions useful throughout the script <br>
3. Establish working directories or paths to other directories if needed <br>
4. Import data <br>
5. Data Cleaning and Preprocessing - this may involve handling missing values, removing outliers, converting to preferred units. etc. <br>
6. Exploratory Data Analysis - it is beneficial to explore data visually to help understand the characteristics of the data. <br>
7. Apply functions, or models or other analytical techniques <br>
8. Evaluate results - If modeling, this may involve comparing model predictions with observed data or conducting sensitivity analysis <br>
9. Visualize and report - plots, maps and tables can be effective ways to communicate findings. <br><br></p>
<p>While you might find slight variations among collaborators, following this general workflow ensures that our scripts are structured in a way that facilitates easy sharing and reproducibility of results. <br></p>
<div id="generate-functions" class="section level5 hasAnchor" number="7.1.3.1.1">
<h5><span class="header-section-number">7.1.3.1.1</span> Generate functions<a href="spatial-models-and-gis-integration.html#generate-functions" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Since we have imported the required libraries, let’s generate some functions.</p>
<p><strong>Q1.</strong>(2 pnt) What does date: “19 February, 2026” in the header do?</p>
<p>ANSWER:</p>
<p><strong>Q2.</strong>(3 pnt) What does ‘recursive = TRUE’ do? What would the ‘recursive = FALSE’ return?
ANSWER:</p>
<p><strong>EXTRA</strong> (1 pnt) : Rewrite this function to generate ‘splitbase’ with fewer lines. For example, what happens when you replace ‘basename’ in ‘splitbase &lt;- strsplit(basename,’_‘)[[1]][1]’ with ‘splitpath[[1]][2]’?</p>
<p><strong>Q3.</strong> (3 pnt) What is the point of writing a function? Why do you think it is advantageous to write functions early in your script?
ANSWER:</p>
</div>
<div id="establish-new-directoriesfolders" class="section level5 hasAnchor" number="7.1.3.1.2">
<h5><span class="header-section-number">7.1.3.1.2</span> Establish new directories(folders)<a href="spatial-models-and-gis-integration.html#establish-new-directoriesfolders" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>in our working directory. We will use these to store the outputs of the Whitebox functions.</p>
<p>Check your working directory, you should see the new folders there.</p>
</div>
</div>
<div id="resample-dems" class="section level4 hasAnchor" number="7.1.3.2">
<h4><span class="header-section-number">7.1.3.2</span> Resample DEMs<a href="spatial-models-and-gis-integration.html#resample-dems" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Here we will start with LiDAR data with 0.5m resolution. While this resolution has useful applications, a high resolution DEM can make hydrological models very computationally expensive with little or no improvement to the output. If you have the option of high resolution data in your work, you can test model outputs at different resolutions to determine what is the most efficient and effective resolution for your work. Here, we will resample our LiDAR data to a 10m resolution.</p>
<p><strong>Q4.</strong> (3 pnt) Did we use the function extractsitenames in the above chunk? How? What did it do?</p>
<p>ANSWER:</p>
<p>Let’s quickly check our work by importing a resampled DEM and checking the resolution.</p>
<p>Note: This can also be done without importing the raster to the workspace by installing the library gdalUtils.</p>
<p><strong>Q5.</strong>(2 pnt) What is the resolution of the resampled DEM? Where and how could we change the resolution to 30m if desired?</p>
<p>ANSWER:</p>
</div>
<div id="filling-and-breaching" class="section level4 hasAnchor" number="7.1.3.3">
<h4><span class="header-section-number">7.1.3.3</span> Filling and breaching<a href="spatial-models-and-gis-integration.html#filling-and-breaching" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>When performing hydrological analysis on a DEM, the DEM usually needs to be pre-processed by <a href="https://www.researchgate.net/figure/Main-principles-of-depression-preprocessing-methods-Depressions-are-caused-by_fig2_260064729">‘filling’ or ‘breaching’</a> any depressions or sinks to create a hydraulically connected and filled DEM. There are several depression or pit filling options available in whitebox. Breach depressions can be a better option that just pit filling according to whitebox documentation, however, some users argue that this can smooth too much, resulting in an altered watershed delineation. It is prudent to investigate different DEM pre-processing methods and their resulting DEM. You can fill depressions directly, breach depressions and then fill them, applying breach or fill single cell pit before breach/fill depressions, and use the one that generates the most reasonable watershed delineation results.
Here we are going to make extra sure our flowpaths are uninhibited by first filling in single cell pits, and then breaching any larger depressions.</p>
<p><strong>Q6</strong> (2 pnt) What is breach1? How is lapply using breach1?
ANSWER:</p>
</div>
<div id="flow-direction-and-accumulation-rasters" class="section level4 hasAnchor" number="7.1.3.4">
<h4><span class="header-section-number">7.1.3.4</span> Flow direction and accumulation rasters<a href="spatial-models-and-gis-integration.html#flow-direction-and-accumulation-rasters" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><strong>Q7</strong> (2 pnt) Check out the <a href="https://www.whiteboxgeo.com/manual/wbt_book/available_tools/hydrological_analysis.html#D8Pointer">WhiteboxTools User Manual</a>. What does a d8pointer raster tell us and what might we use it for?
ANSWER:</p>
<p>Let’s visualize some of our work so far:</p>
<p><strong>Q8.</strong> (3 pnt) What are the units for the values that you see in each of these legends? It may be helpful to check out the Manual again.
ANSWER:</p>
</div>
<div id="streams" class="section level4 hasAnchor" number="7.1.3.5">
<h4><span class="header-section-number">7.1.3.5</span> Streams<a href="spatial-models-and-gis-integration.html#streams" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Define streams using the flow accumulation raster. Use of the wbt_extract_streams function will return a raster with stream cells indicated only.</p>
<p>Sometimes we would prefer to see the stream within the watershed boundary. Here we are using the extent of the flow accumulation raster to generate a raster with ‘0’ to indicate watershed cells, along with stream cells indicated by the streams.tif. This is a demonstration for one watershed.</p>
</div>
<div id="final-thoughts-1" class="section level4 hasAnchor" number="7.1.3.6">
<h4><span class="header-section-number">7.1.3.6</span> Final thoughts:<a href="spatial-models-and-gis-integration.html#final-thoughts-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>There are many more hydrological preprocessing and analysis tools available through Whitebox for R. If you are interested in watershed delineation in R, there is a <a href="https://www.whiteboxgeo.com/manual/wbt_book/available_tools/hydrological_analysis.html#Watershed">tutorial here</a> that is fairly easy to follow. However, if you find that you use these tools frequently and do not use R much in other work, you may also consider these options for hydrological analysis:<br><br>
1. <a href="https://saga-gis.sourceforge.io/saga_tool_doc/4.1.0/ta_hydrology.html">SAGA</a>
SAGA tools offer a versatile suite of geospatial processing capabilities accessible through both QGIS and ArcGIS plugins as well their standalone GUI interface. Often I find the GUI easiest for preprocessing, then I will import SAGA’s output rasters to QGIS for formatting or map making, or into model scripts. SAGA has a robust online support community, so it can be a valuable resource for hydrological work.<br><br>
2. Similarly, Whitebox GAT tools can be used as plugin to QGIS and ArcGIS, providing Whitebox functionality directly with in a GIS environment. <br>
When using these tools, the order of operations is similar to our work above: fill the DEM, generate a flow direction and flow accumulation raster, identify channels, delineate watersheds, then you can move forward according to the specificity of your project.
Ultimately, the choice of workflow is yours, but I suggest documenting your process as you proceed, including links or file paths to projects and scripts within a written or diagrammed workflow (or workflow software). It’s also important to carefully consider the organization and storage of your projects and files. For instance, files generated by a GIS project should be readily accessible to any associated scripts. Returning to a preprocessing step can be (sometimes painfully) challenging if there’s no clear way to trace back your workflow and regenerate a crucial layer.</p>
<p><img src="images/Beven_modeling_workflow.png" width="80%" style="display: block; margin: auto;" /></p>
<p>Take another look at the model selection process from Bevin (above), and think about how you can make your workflow easier to recall and repeat. A little planning upfront can save so much time later. (Seriously, so. much. time.)<br />
To document and track iterations efficiently, consider using a tool that fits your workflow: <br>
- Bookdown in R - this is useful if your work involves R scripts or Markdown. This is the tool we used to develop the tutorial ‘book’ for this course and I frequently use it to develop and share my own research scripts, figures and workflows. <br>
- Obsidian or Notion - Better options if R scripts aren’t a major part of your work, allowing for flexible organization and easy cross-referencing.
- You can even make a slide in Power Point with a work flow chart, inserting links, file paths and written steps into the chart as you go. <br></p>
<p>As you work on your term projects over the next couple of weeks, keep these tips in mind. If you haven’t started the thesis course yet (LRES 575), you’ll likely want to revisit the workflow you develop now and continue refining it for your thesis. Set yourself up for success by making it easy to track, recall and build on your work. Think about how you can make this process smoother for your future self. Your future self will thank you.</p>
<p>Good Luck!</p>

</div>
</div>
</div>
<div id="hbv-hydrology-model" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> HBV Hydrology Model<a href="spatial-models-and-gis-integration.html#hbv-hydrology-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="learning-module-12" class="section level3 hasAnchor" number="7.2.1">
<h3><span class="header-section-number">7.2.1</span> Learning Module 12<a href="spatial-models-and-gis-integration.html#learning-module-12" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Adapted from Fabian Nippgen (REWM 4500 5500)</p>
<div id="background-4" class="section level4 hasAnchor" number="7.2.1.1">
<h4><span class="header-section-number">7.2.1.1</span> Background:<a href="spatial-models-and-gis-integration.html#background-4" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>In this exercise, we will pull together many aspects of what we have learned so far to calibrate the HBV model to weighted data from the Fraser Experimental Forest in Colorado using precipitation/runoff and potential evapotranspiration (PET) data derived from the methods explored in the snowmelt and evapotranspiration modules.</p>
<p>HBV is:
In the previous labs, we have worked with single-process models. HBV is more complex process-based model using many parameters to describe the physical processes of the hydrologic cycle
<a href="https://rpubs.com/sdhakal/848236" class="uri">https://rpubs.com/sdhakal/848236</a></p>
<p><img src="images/HBV-schem-Shrestha-Solomantine-2008.png" title="HBV Model" /></p>
<p>Reproduced from: Durga Lal Shrestha &amp; Dimitri P. Solomatine (2008) Data‐driven approaches for estimating uncertainty in rainfall‐runoff modelling, International Journal of River Basin Management, 6:2, 109-122, DOI: 10.1080/15715124.2008.9635341</p>
<p>HBV versions with a GUI exists, but the data manipulation is more convenient in a coding environment, and we want you to be able to see ‘under the hood’. Instead of dealing with the inner workings of the model too much, we will put the focus on importing and organizing the data, getting the model running and manual optimization.</p>
<p>The HBV realization we will be using is contained in the R package TUWmodel. Please search that package in your browser and familiarize yourself with it (that will be the first step). TUW simply means “Technische Universitaet Wien”, or Vienna University of Technology. The model is slightly different from the original HBV but still similar enough to call it HBV. We also need to understand the arguments and parameters required for the model.</p>
<p>Type ‘?TUWmodel’ in your console. Note that the package comes with an example dataset, and you can run examples either by copying and pasting the data(), TUWmodel() and plots into your console, or you can find and click ‘Run examples’ under the <strong>Examples</strong> header and view the script and plot outputs in the Help window. The first example shows how the ‘TUWmodel’ can be run given specifications for a long set of parameters (param). You can provide the model with precip, air temperature, area and ET along with the parameter set and it will simulate SWE, snow melt and discharge. We can obtain measurements for each of these variables, so we will import all of this data and test the fit of the simulated data.</p>
<p><a href="https://cran.r-project.org/web/packages/TUWmodel/TUWmodel.pdf" class="uri">https://cran.r-project.org/web/packages/TUWmodel/TUWmodel.pdf</a></p>
</div>
<div id="import-data-2" class="section level4 hasAnchor" number="7.2.1.2">
<h4><span class="header-section-number">7.2.1.2</span> Import data:<a href="spatial-models-and-gis-integration.html#import-data-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We will generate a conceptual runoff model starting with: <br></p>
<ul>
<li><p>RainMeltWeighted_mm –&gt; liquid input to the ground, combination of rain and melt <br></p></li>
<li><p>PWeighted_mm –&gt; Precipitation measured at the SNOTEL sites, both liquid and frozen. This is NOT water that went into the ground at that point. This is, however, the P input time series for the HBV model. <br></p></li>
<li><p>SweWeighted_mm –&gt; Snow water equivalent at the SNOTEL sites. We can use this to evaluate our snow routine. <br></p></li>
<li><p>TempWeighted –&gt; Either daily mean, min, or max. We will use the mean. <br></p></li>
<li><p>Discharge_mm –&gt; Q observed at the outlet. <br></p></li>
<li><p>ET –&gt; Potential Evapotranspiration calculated using relative humidity and temperature. <br></p></li>
</ul>
</div>
</div>
<div id="repo-link-6" class="section level3 hasAnchor" number="7.2.2">
<h3><span class="header-section-number">7.2.2</span> Repo link<a href="spatial-models-and-gis-integration.html#repo-link-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><a href="https://github.com/lekokremer/lres546_HBV_repo" target="_blank">Download the repo for this lab HERE</a></p>
</div>
<div id="labwork-20-pnts-1" class="section level3 hasAnchor" number="7.2.3">
<h3><span class="header-section-number">7.2.3</span> Labwork (20 pnts)<a href="spatial-models-and-gis-integration.html#labwork-20-pnts-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Our first steps will be to import and format the data. As you might recall from the previous modules, this step can require the most script and ‘work’, but is critical to a valid model output. In this assignment, we have simplified much of the data collection for you, as the steps are ones you have already completed in previous modules.</p>
<p>In the .csv imported below, we started by collecting the same SNOTEL data that you used in the snow melt module, but downloaded for a greater date range (water years 2018-2022) (date, SWE depth in mm, and daily precipitation (mm)) However, you will notice that the column names of the provided table contain ‘weighted_’.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="spatial-models-and-gis-integration.html#cb3-1" tabindex="-1"></a><span class="co"># Import model data </span></span>
<span id="cb3-2"><a href="spatial-models-and-gis-integration.html#cb3-2" tabindex="-1"></a><span class="co"># indata &lt;- read.csv(&quot;weighted_data_fool_HBV.csv&quot;)%&gt;%</span></span>
<span id="cb3-3"><a href="spatial-models-and-gis-integration.html#cb3-3" tabindex="-1"></a><span class="co">#   mutate(date = ymd(date)) %&gt;%</span></span>
<span id="cb3-4"><a href="spatial-models-and-gis-integration.html#cb3-4" tabindex="-1"></a><span class="co">#   rename(Q_m3_s = m3_s, Q_mm_day = mm_day, runoff_input.mm = input.mm )</span></span>
<span id="cb3-5"><a href="spatial-models-and-gis-integration.html#cb3-5" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-6"><a href="spatial-models-and-gis-integration.html#cb3-6" tabindex="-1"></a><span class="co"># str(indata)</span></span></code></pre></div>
<p>As we noted in the Snowmelt module, factors such as elevation and vegetation will affect the of snow-to-runoff rate. Similarly, temperature and precipitation differ with elevation, meaning that SNOTEL data from a single location may not fully represent conditions across the entire watershed.</p>
<p>To account for these variations, the “weighted” values for this exercise have been adjusted using linear scaling relationships that estimate average conditions across the watershed. The adjustments use elevation-precipitation and elevation-temperature relationships derived from inverse distance weighting to better approximate spatially distributed hydrological inputs rather than relying on a single point measurement.</p>
<p><img src="images/precip_spatial_interp.png" title="Spatial interpolation" /></p>
<p>If you are interested, you can start exploring spatial interpolation with: <br>
1. Thiessen polygons
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d9/Voronoi_growth_euclidean.gif/440px-Voronoi_growth_euclidean.gif" alt="Thiessen polygons" />
<br>
2. Inverse distance weighting <br>
3. Kringing methods
to determine if any of these are applicable to your study area.</p>
<p>Other columns in our imported data set include:
<strong>Q_m3_s and Q_mm_day</strong> - Discharge (Q) collected at the Fool Creek outlet by USFS, in units of cubic meters per second and mm per day from April until October.
<strong>Tmax_c, Tmin_c and Tmean_c</strong> - Typically, we could find daily mean, max and minimum temperatures in the SNOTEL datasets, however, this particular station is missing temperature data (due to restrictions on technical access in 2020), so we retrieved temperature data from GridMET through <a href="https://app.climateengine.org/climateEngine">Climate Engine</a>. This highlights the importance of evaluating each variable for completeness. It will save you the headache of running the entire workflow, only to find that model outputs cannot be simulated for the later half of 2020 due to missing input data.
<strong>RHmin, RHmax</strong> - Relative humidity daily min and max, also from GridMET, accessed through Climate Engine
<strong>SWEdiff.mm, Pdiff.mm and runoff_input.mm</strong> - all daily outputs of a temperature based snowmelt model (the same as in the snow melt module). runoff_input is the estimated daily input to the stream from melted snow and liquid precipitation combined.</p>
<p>Keep in mind that you can plot more than two variables in a single plot, but they will be most helpful if you group variables with a similar y-scale. For example, cumulative precipitation or SWE values will have a different range than variables that represent daily measurements like ‘input_mm’. Alternatively, you can add a secondary y-axis to your plot.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="spatial-models-and-gis-integration.html#cb4-1" tabindex="-1"></a><span class="co"># ggplot(data = indata) +</span></span>
<span id="cb4-2"><a href="spatial-models-and-gis-integration.html#cb4-2" tabindex="-1"></a><span class="co">#   geom_point(aes(x = date, y = runoff_input.mm, color = &quot;runoff_input.mm&quot;), size = 0.5) +  # Assign a label for legend</span></span>
<span id="cb4-3"><a href="spatial-models-and-gis-integration.html#cb4-3" tabindex="-1"></a><span class="co">#   geom_point(aes(x = date, y = Q_mm_day, color = &quot;mm/day&quot;), size = 0.5) +  # Assign a different label</span></span>
<span id="cb4-4"><a href="spatial-models-and-gis-integration.html#cb4-4" tabindex="-1"></a><span class="co">#   geom_point(aes(x = date, y = weighted_precip.mm, color = &quot;weighted_precip.mm&quot;), size = 0.5) +  # Assign a different label</span></span>
<span id="cb4-5"><a href="spatial-models-and-gis-integration.html#cb4-5" tabindex="-1"></a><span class="co">#   geom_point(aes(x = date, y = Pdiff.mm, color = &quot;Pdiff.mm&quot;), size = 0.5) +</span></span>
<span id="cb4-6"><a href="spatial-models-and-gis-integration.html#cb4-6" tabindex="-1"></a><span class="co">#   scale_color_manual(values = c(&quot;runoff_input.mm&quot; = &quot;blue&quot;, &quot;mm/day&quot; = &quot;red&quot;, &quot;weighted_precip.mm&quot; = &quot;green&quot;, &quot;Pdiff.mm&quot; = &#39;purple&#39;)) +  # Customize colors</span></span>
<span id="cb4-7"><a href="spatial-models-and-gis-integration.html#cb4-7" tabindex="-1"></a><span class="co">#   labs(color = &quot;Discharge Units&quot;) +  # Legend title</span></span>
<span id="cb4-8"><a href="spatial-models-and-gis-integration.html#cb4-8" tabindex="-1"></a><span class="co">#   theme_minimal()</span></span></code></pre></div>
<p>2,930m.
watershed_area_m2 &lt;- 2640000</p>
<p>Note that while the stream is snow-covered, there are no stage/flow measurements being made at this site. For many of our calculations to work, we will not want NA in our data frames. In this data set, if we view the tabular data, the end discharge reading (Q_mm_day), is very similar to the first in the following calendar year. For this example, we will then fill the NA values with the mean of the final and first readings for each winter (Oct - April) NA string.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="spatial-models-and-gis-integration.html#cb5-1" tabindex="-1"></a><span class="co"># Rather than scrolling through a dataframe, this gives us a sum of &#39;NA&#39; ros in this column</span></span>
<span id="cb5-2"><a href="spatial-models-and-gis-integration.html#cb5-2" tabindex="-1"></a><span class="co"># sum(is.na(indata$Q_mm_day))</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="spatial-models-and-gis-integration.html#cb6-1" tabindex="-1"></a><span class="co"># # Function to fill NA values in Q_mm_day during winter (Oct - Apr)</span></span>
<span id="cb6-2"><a href="spatial-models-and-gis-integration.html#cb6-2" tabindex="-1"></a><span class="co"># fill_na_winter &lt;- function(df) {</span></span>
<span id="cb6-3"><a href="spatial-models-and-gis-integration.html#cb6-3" tabindex="-1"></a><span class="co">#   df &lt;- df %&gt;%</span></span>
<span id="cb6-4"><a href="spatial-models-and-gis-integration.html#cb6-4" tabindex="-1"></a><span class="co">#     arrange(date) %&gt;% # Ensure data is sorted</span></span>
<span id="cb6-5"><a href="spatial-models-and-gis-integration.html#cb6-5" tabindex="-1"></a><span class="co">#     mutate(</span></span>
<span id="cb6-6"><a href="spatial-models-and-gis-integration.html#cb6-6" tabindex="-1"></a><span class="co">#       month = month(date),</span></span>
<span id="cb6-7"><a href="spatial-models-and-gis-integration.html#cb6-7" tabindex="-1"></a><span class="co">#       is_winter = month %in% c(10, 11, 12, 1, 2, 3, 4) # Identify winter months</span></span>
<span id="cb6-8"><a href="spatial-models-and-gis-integration.html#cb6-8" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb6-9"><a href="spatial-models-and-gis-integration.html#cb6-9" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb6-10"><a href="spatial-models-and-gis-integration.html#cb6-10" tabindex="-1"></a><span class="co">#   # Identify NA stretches in winter months</span></span>
<span id="cb6-11"><a href="spatial-models-and-gis-integration.html#cb6-11" tabindex="-1"></a><span class="co">#   na_indices &lt;- which(is.na(df$Q_mm_day) &amp; df$is_winter)</span></span>
<span id="cb6-12"><a href="spatial-models-and-gis-integration.html#cb6-12" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb6-13"><a href="spatial-models-and-gis-integration.html#cb6-13" tabindex="-1"></a><span class="co">#   for (idx in na_indices) {</span></span>
<span id="cb6-14"><a href="spatial-models-and-gis-integration.html#cb6-14" tabindex="-1"></a><span class="co">#     # Find the last non-NA before the current NA</span></span>
<span id="cb6-15"><a href="spatial-models-and-gis-integration.html#cb6-15" tabindex="-1"></a><span class="co">#     prev_value &lt;- df$Q_mm_day[max(which(!is.na(df$Q_mm_day[1:(idx - 1)])))]</span></span>
<span id="cb6-16"><a href="spatial-models-and-gis-integration.html#cb6-16" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb6-17"><a href="spatial-models-and-gis-integration.html#cb6-17" tabindex="-1"></a><span class="co">#     # Find the next non-NA after the current NA</span></span>
<span id="cb6-18"><a href="spatial-models-and-gis-integration.html#cb6-18" tabindex="-1"></a><span class="co">#     next_value &lt;- df$Q_mm_day[min(which(!is.na(df$Q_mm_day[(idx + 1):nrow(df)])) + idx)]</span></span>
<span id="cb6-19"><a href="spatial-models-and-gis-integration.html#cb6-19" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb6-20"><a href="spatial-models-and-gis-integration.html#cb6-20" tabindex="-1"></a><span class="co">#     # Replace the NA with the average of prev_value and next_value</span></span>
<span id="cb6-21"><a href="spatial-models-and-gis-integration.html#cb6-21" tabindex="-1"></a><span class="co">#     if (!is.na(prev_value) &amp; !is.na(next_value)) {</span></span>
<span id="cb6-22"><a href="spatial-models-and-gis-integration.html#cb6-22" tabindex="-1"></a><span class="co">#       df$Q_mm_day[idx] &lt;- (prev_value + next_value) / 2</span></span>
<span id="cb6-23"><a href="spatial-models-and-gis-integration.html#cb6-23" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb6-24"><a href="spatial-models-and-gis-integration.html#cb6-24" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb6-25"><a href="spatial-models-and-gis-integration.html#cb6-25" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb6-26"><a href="spatial-models-and-gis-integration.html#cb6-26" tabindex="-1"></a><span class="co">#   return(df)</span></span>
<span id="cb6-27"><a href="spatial-models-and-gis-integration.html#cb6-27" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb6-28"><a href="spatial-models-and-gis-integration.html#cb6-28" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb6-29"><a href="spatial-models-and-gis-integration.html#cb6-29" tabindex="-1"></a><span class="co"># # Apply the function</span></span>
<span id="cb6-30"><a href="spatial-models-and-gis-integration.html#cb6-30" tabindex="-1"></a><span class="co"># indata &lt;- fill_na_winter(indata)</span></span></code></pre></div>
<p>Let’s try our quick check again:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="spatial-models-and-gis-integration.html#cb7-1" tabindex="-1"></a><span class="co"># Now we should see zero NA in this column</span></span>
<span id="cb7-2"><a href="spatial-models-and-gis-integration.html#cb7-2" tabindex="-1"></a><span class="co"># sum(is.na(indata$Q_mm_day))</span></span></code></pre></div>
<p>Next, we need to add daily potential evapotranspiration (PET) to the dataset. The evapotranspiration module covered some of the numerous pre-built functions available in various R packages designed for ET estimation. For instance, the ‘Evapotranspiration’ package provides ET estimates derived from approximately 20 distinct equations or variations. These functions require precise data formatting to ensure compatibility with the function arguments. To help you structure your function inputs similarly, many packages come with example datasets in their documentation. SPEI is another package that offers ET functions. The github repository for this package has been updated fairly recently, which can be important to verify.</p>
<p>We chose to write our own function here so you could ‘see under the hood’.<br />
Not all packages are equally maintained, as they are often developed by researchers or modelers to improve the repeatably of their work, and contribute to the broader scientific community. Once funding ceases, or if the original developer moves on to new projects, a custom package may no longer receive updates or support. As R, RStudio and other supporting packages are updated, a package may become depreciated. If the package still functions correctly in your current R version and dependencies, there’s no immediate reason to stop using it. However, if you are concerned that future versions of R or dependencies might break the packages you use, you can check the development and maintenance history of custom or specialized packages (or write a package or function for yourself as exemplified below!).</p>
<p>Here is our Hargreaves function, adapted from the ‘Evapotranspiration’ package to minimize re-formatting of our dataframe.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="spatial-models-and-gis-integration.html#cb8-1" tabindex="-1"></a><span class="co"># # Function to calculate ET</span></span>
<span id="cb8-2"><a href="spatial-models-and-gis-integration.html#cb8-2" tabindex="-1"></a><span class="co"># calculate_ET &lt;- function(data, constants, ts = &quot;daily&quot;, message = &quot;yes&quot;, save.csv = &quot;no&quot;, ...) {</span></span>
<span id="cb8-3"><a href="spatial-models-and-gis-integration.html#cb8-3" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb8-4"><a href="spatial-models-and-gis-integration.html#cb8-4" tabindex="-1"></a><span class="co">#   # Check for required data</span></span>
<span id="cb8-5"><a href="spatial-models-and-gis-integration.html#cb8-5" tabindex="-1"></a><span class="co">#   if (is.null(data$Tmax) | is.null(data$Tmin)) {</span></span>
<span id="cb8-6"><a href="spatial-models-and-gis-integration.html#cb8-6" tabindex="-1"></a><span class="co">#     stop(&quot;Required data missing for &#39;Tmax&#39; and &#39;Tmin&#39;, or &#39;Temp&#39;&quot;)</span></span>
<span id="cb8-7"><a href="spatial-models-and-gis-integration.html#cb8-7" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb8-8"><a href="spatial-models-and-gis-integration.html#cb8-8" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb8-9"><a href="spatial-models-and-gis-integration.html#cb8-9" tabindex="-1"></a><span class="co">#   # Hargreaves-Samani ET Calculation</span></span>
<span id="cb8-10"><a href="spatial-models-and-gis-integration.html#cb8-10" tabindex="-1"></a><span class="co">#   Ta &lt;- (data$Tmax + data$Tmin) / 2</span></span>
<span id="cb8-11"><a href="spatial-models-and-gis-integration.html#cb8-11" tabindex="-1"></a><span class="co">#   P &lt;- 101.3 * ((293 - 0.0065 * constants$Elev) / 293) ^ 5.26</span></span>
<span id="cb8-12"><a href="spatial-models-and-gis-integration.html#cb8-12" tabindex="-1"></a><span class="co">#   delta &lt;- 4098 * (0.6108 * exp((17.27 * Ta) / (Ta + 237.3))) / ((Ta + 237.3) ^ 2)</span></span>
<span id="cb8-13"><a href="spatial-models-and-gis-integration.html#cb8-13" tabindex="-1"></a><span class="co">#   gamma &lt;- 0.00163 * P / constants$lambda</span></span>
<span id="cb8-14"><a href="spatial-models-and-gis-integration.html#cb8-14" tabindex="-1"></a><span class="co">#   d_r2 &lt;- 1 + 0.033 * cos(2 * pi / 365 * data$J)</span></span>
<span id="cb8-15"><a href="spatial-models-and-gis-integration.html#cb8-15" tabindex="-1"></a><span class="co">#   delta2 &lt;- 0.409 * sin(2 * pi / 365 * data$J - 1.39)</span></span>
<span id="cb8-16"><a href="spatial-models-and-gis-integration.html#cb8-16" tabindex="-1"></a><span class="co">#   w_s &lt;- acos(-tan(constants$lat_rad) * tan(delta2))</span></span>
<span id="cb8-17"><a href="spatial-models-and-gis-integration.html#cb8-17" tabindex="-1"></a><span class="co">#   N &lt;- 24 / pi * w_s</span></span>
<span id="cb8-18"><a href="spatial-models-and-gis-integration.html#cb8-18" tabindex="-1"></a><span class="co">#   R_a &lt;- (1440 / pi) * d_r2 * constants$Gsc * (w_s * sin(constants$lat_rad) * sin(delta2) + </span></span>
<span id="cb8-19"><a href="spatial-models-and-gis-integration.html#cb8-19" tabindex="-1"></a><span class="co">#                                                cos(constants$lat_rad) * cos(delta2) * sin(w_s))</span></span>
<span id="cb8-20"><a href="spatial-models-and-gis-integration.html#cb8-20" tabindex="-1"></a><span class="co">#   C_HS &lt;- 0.00185 * (data$Tmax - data$Tmin) ^ 2 - 0.0433 * (data$Tmax - data$Tmin) + 0.4023</span></span>
<span id="cb8-21"><a href="spatial-models-and-gis-integration.html#cb8-21" tabindex="-1"></a><span class="co">#   ET_HS.Daily &lt;- 0.0135 * C_HS * R_a / constants$lambda * (data$Tmax - </span></span>
<span id="cb8-22"><a href="spatial-models-and-gis-integration.html#cb8-22" tabindex="-1"></a><span class="co">#                                                               data$Tmin) ^ 0.5 * (Ta + 17.8)</span></span>
<span id="cb8-23"><a href="spatial-models-and-gis-integration.html#cb8-23" tabindex="-1"></a><span class="co">#   ET.Daily &lt;- ET_HS.Daily</span></span>
<span id="cb8-24"><a href="spatial-models-and-gis-integration.html#cb8-24" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb8-25"><a href="spatial-models-and-gis-integration.html#cb8-25" tabindex="-1"></a><span class="co">#   # Create YearMonth Column</span></span>
<span id="cb8-26"><a href="spatial-models-and-gis-integration.html#cb8-26" tabindex="-1"></a><span class="co">#   data$YearMonth &lt;- as.Date(paste(year(data$Date.daily), month(data$Date.daily), &quot;01&quot;, sep = &quot;-&quot;))</span></span>
<span id="cb8-27"><a href="spatial-models-and-gis-integration.html#cb8-27" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb8-28"><a href="spatial-models-and-gis-integration.html#cb8-28" tabindex="-1"></a><span class="co">#   # Annual and Monthly Aggregations</span></span>
<span id="cb8-29"><a href="spatial-models-and-gis-integration.html#cb8-29" tabindex="-1"></a><span class="co">#   ET.Annual &lt;- aggregate(ET.Daily ~ year(YearMonth), data = data, FUN = sum)</span></span>
<span id="cb8-30"><a href="spatial-models-and-gis-integration.html#cb8-30" tabindex="-1"></a><span class="co">#   ET.Monthly &lt;- aggregate(ET.Daily ~ YearMonth, data = data, FUN = sum)</span></span>
<span id="cb8-31"><a href="spatial-models-and-gis-integration.html#cb8-31" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb8-32"><a href="spatial-models-and-gis-integration.html#cb8-32" tabindex="-1"></a><span class="co">#   # ET formulating</span></span>
<span id="cb8-33"><a href="spatial-models-and-gis-integration.html#cb8-33" tabindex="-1"></a><span class="co">#   ET_formulation &lt;- &quot;Hargreaves-Samani&quot;</span></span>
<span id="cb8-34"><a href="spatial-models-and-gis-integration.html#cb8-34" tabindex="-1"></a><span class="co">#   ET_type &lt;- &quot;Reference Crop ET&quot;</span></span>
<span id="cb8-35"><a href="spatial-models-and-gis-integration.html#cb8-35" tabindex="-1"></a><span class="co">#   results &lt;- list(ET.Daily = ET.Daily, ET.Monthly = ET.Monthly, </span></span>
<span id="cb8-36"><a href="spatial-models-and-gis-integration.html#cb8-36" tabindex="-1"></a><span class="co">#                   ET.Annual = ET.Annual, ET_formulation = ET_formulation, </span></span>
<span id="cb8-37"><a href="spatial-models-and-gis-integration.html#cb8-37" tabindex="-1"></a><span class="co">#                   ET_type = ET_type)</span></span>
<span id="cb8-38"><a href="spatial-models-and-gis-integration.html#cb8-38" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb8-39"><a href="spatial-models-and-gis-integration.html#cb8-39" tabindex="-1"></a><span class="co">#   # Save to CSV if required</span></span>
<span id="cb8-40"><a href="spatial-models-and-gis-integration.html#cb8-40" tabindex="-1"></a><span class="co">#   if (save.csv == &quot;yes&quot;) {</span></span>
<span id="cb8-41"><a href="spatial-models-and-gis-integration.html#cb8-41" tabindex="-1"></a><span class="co">#     for (i in 1:length(results)) {</span></span>
<span id="cb8-42"><a href="spatial-models-and-gis-integration.html#cb8-42" tabindex="-1"></a><span class="co">#       namer &lt;- names(results[i])</span></span>
<span id="cb8-43"><a href="spatial-models-and-gis-integration.html#cb8-43" tabindex="-1"></a><span class="co">#       write.table(as.character(namer), file = &quot;ET_HargreavesSamani.csv&quot;, </span></span>
<span id="cb8-44"><a href="spatial-models-and-gis-integration.html#cb8-44" tabindex="-1"></a><span class="co">#                   dec = &quot;.&quot;, quote = FALSE, col.names = FALSE, </span></span>
<span id="cb8-45"><a href="spatial-models-and-gis-integration.html#cb8-45" tabindex="-1"></a><span class="co">#                   row.names = F, append = TRUE, sep = &quot;,&quot;)</span></span>
<span id="cb8-46"><a href="spatial-models-and-gis-integration.html#cb8-46" tabindex="-1"></a><span class="co">#       write.table(data.frame(get(namer, results)), file = &quot;ET_HargreavesSamani.csv&quot;, </span></span>
<span id="cb8-47"><a href="spatial-models-and-gis-integration.html#cb8-47" tabindex="-1"></a><span class="co">#                   col.names = F, append = TRUE, sep = &quot;,&quot;)</span></span>
<span id="cb8-48"><a href="spatial-models-and-gis-integration.html#cb8-48" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb8-49"><a href="spatial-models-and-gis-integration.html#cb8-49" tabindex="-1"></a><span class="co">#     invisible(results)</span></span>
<span id="cb8-50"><a href="spatial-models-and-gis-integration.html#cb8-50" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb8-51"><a href="spatial-models-and-gis-integration.html#cb8-51" tabindex="-1"></a><span class="co">#     return(results)</span></span>
<span id="cb8-52"><a href="spatial-models-and-gis-integration.html#cb8-52" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb8-53"><a href="spatial-models-and-gis-integration.html#cb8-53" tabindex="-1"></a><span class="co"># }</span></span></code></pre></div>
<p>Now we will format the inputs so the data is easily read by the function, and run the function.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="spatial-models-and-gis-integration.html#cb9-1" tabindex="-1"></a><span class="co"># # Format our data to fit the function</span></span>
<span id="cb9-2"><a href="spatial-models-and-gis-integration.html#cb9-2" tabindex="-1"></a><span class="co"># PET_data &lt;- list(</span></span>
<span id="cb9-3"><a href="spatial-models-and-gis-integration.html#cb9-3" tabindex="-1"></a><span class="co">#   Tmax = indata$Tmax,</span></span>
<span id="cb9-4"><a href="spatial-models-and-gis-integration.html#cb9-4" tabindex="-1"></a><span class="co">#   Tmin = indata$Tmin,</span></span>
<span id="cb9-5"><a href="spatial-models-and-gis-integration.html#cb9-5" tabindex="-1"></a><span class="co">#   J = as.numeric(format(indata$date, &quot;%j&quot;)),</span></span>
<span id="cb9-6"><a href="spatial-models-and-gis-integration.html#cb9-6" tabindex="-1"></a><span class="co">#   Date.daily = indata$date</span></span>
<span id="cb9-7"><a href="spatial-models-and-gis-integration.html#cb9-7" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb9-8"><a href="spatial-models-and-gis-integration.html#cb9-8" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-9"><a href="spatial-models-and-gis-integration.html#cb9-9" tabindex="-1"></a><span class="co"># # Define constants</span></span>
<span id="cb9-10"><a href="spatial-models-and-gis-integration.html#cb9-10" tabindex="-1"></a><span class="co"># constants &lt;- list(</span></span>
<span id="cb9-11"><a href="spatial-models-and-gis-integration.html#cb9-11" tabindex="-1"></a><span class="co">#   Elev = 2900,                            # Elevation in meters</span></span>
<span id="cb9-12"><a href="spatial-models-and-gis-integration.html#cb9-12" tabindex="-1"></a><span class="co">#   lambda = 2.45,                          # Latent heat of vaporization in MJ.kg^-1</span></span>
<span id="cb9-13"><a href="spatial-models-and-gis-integration.html#cb9-13" tabindex="-1"></a><span class="co">#   lat_rad = 39.88 * pi / 180,             # Latitude in radians</span></span>
<span id="cb9-14"><a href="spatial-models-and-gis-integration.html#cb9-14" tabindex="-1"></a><span class="co">#   Gsc = 0.0820                            # Solar constant in MJ.m^-2.min^-1</span></span>
<span id="cb9-15"><a href="spatial-models-and-gis-integration.html#cb9-15" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb9-16"><a href="spatial-models-and-gis-integration.html#cb9-16" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb9-17"><a href="spatial-models-and-gis-integration.html#cb9-17" tabindex="-1"></a><span class="co"># PET_Hargreaves &lt;- calculate_ET(</span></span>
<span id="cb9-18"><a href="spatial-models-and-gis-integration.html#cb9-18" tabindex="-1"></a><span class="co">#   data = PET_data,</span></span>
<span id="cb9-19"><a href="spatial-models-and-gis-integration.html#cb9-19" tabindex="-1"></a><span class="co">#   constants = constants,</span></span>
<span id="cb9-20"><a href="spatial-models-and-gis-integration.html#cb9-20" tabindex="-1"></a><span class="co">#   ts = &quot;daily&quot;,        # Optional; defaults to &quot;daily&quot;</span></span>
<span id="cb9-21"><a href="spatial-models-and-gis-integration.html#cb9-21" tabindex="-1"></a><span class="co">#   message = &quot;yes&quot;,     # Optional; prints summary </span></span>
<span id="cb9-22"><a href="spatial-models-and-gis-integration.html#cb9-22" tabindex="-1"></a><span class="co">#   save.csv = &quot;no&quot;      # Optional; do not save results to a CSV</span></span>
<span id="cb9-23"><a href="spatial-models-and-gis-integration.html#cb9-23" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div>
<p>Now we’ll add daily ET into our original dataframe:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="spatial-models-and-gis-integration.html#cb10-1" tabindex="-1"></a><span class="co"># PET_mm &lt;- PET_Hargreaves$ET.Daily</span></span>
<span id="cb10-2"><a href="spatial-models-and-gis-integration.html#cb10-2" tabindex="-1"></a><span class="co"># # put the approximated PET_mm into the larger indata df</span></span>
<span id="cb10-3"><a href="spatial-models-and-gis-integration.html#cb10-3" tabindex="-1"></a><span class="co"># indata &lt;- cbind(indata, PET_mm)  #with cbind</span></span>
<span id="cb10-4"><a href="spatial-models-and-gis-integration.html#cb10-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb10-5"><a href="spatial-models-and-gis-integration.html#cb10-5" tabindex="-1"></a><span class="co"># head(indata)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="spatial-models-and-gis-integration.html#cb11-1" tabindex="-1"></a><span class="co"># # Annual summary stats</span></span>
<span id="cb11-2"><a href="spatial-models-and-gis-integration.html#cb11-2" tabindex="-1"></a><span class="co"># indata_analysis &lt;- indata %&gt;%</span></span>
<span id="cb11-3"><a href="spatial-models-and-gis-integration.html#cb11-3" tabindex="-1"></a><span class="co">#   select(-date) %&gt;%</span></span>
<span id="cb11-4"><a href="spatial-models-and-gis-integration.html#cb11-4" tabindex="-1"></a><span class="co">#   group_by(wtr_yr) %&gt;%</span></span>
<span id="cb11-5"><a href="spatial-models-and-gis-integration.html#cb11-5" tabindex="-1"></a><span class="co">#   summarise(</span></span>
<span id="cb11-6"><a href="spatial-models-and-gis-integration.html#cb11-6" tabindex="-1"></a><span class="co">#     weighted_precip.mm = sum(weighted_precip.mm, na.rm = TRUE),</span></span>
<span id="cb11-7"><a href="spatial-models-and-gis-integration.html#cb11-7" tabindex="-1"></a><span class="co">#     Tmean_c = mean(Tmean_c, na.rm = TRUE),</span></span>
<span id="cb11-8"><a href="spatial-models-and-gis-integration.html#cb11-8" tabindex="-1"></a><span class="co">#     swe.mm_max = max(weighted_swe.mm, na.rm = TRUE),</span></span>
<span id="cb11-9"><a href="spatial-models-and-gis-integration.html#cb11-9" tabindex="-1"></a><span class="co">#     pcumul.mm_max = max(weighted_pcumul.mm, na.rm = TRUE),</span></span>
<span id="cb11-10"><a href="spatial-models-and-gis-integration.html#cb11-10" tabindex="-1"></a><span class="co">#     Tmax = max(Tmax_c, na.rm = TRUE),</span></span>
<span id="cb11-11"><a href="spatial-models-and-gis-integration.html#cb11-11" tabindex="-1"></a><span class="co">#     Tmin = min(Tmin_c, na.rm = TRUE),</span></span>
<span id="cb11-12"><a href="spatial-models-and-gis-integration.html#cb11-12" tabindex="-1"></a><span class="co">#     Q_mm_sum = sum(Q_mm_day, na.rm = TRUE),</span></span>
<span id="cb11-13"><a href="spatial-models-and-gis-integration.html#cb11-13" tabindex="-1"></a><span class="co">#     PET_mm_sum = sum(PET_mm, na.rm = TRUE), </span></span>
<span id="cb11-14"><a href="spatial-models-and-gis-integration.html#cb11-14" tabindex="-1"></a><span class="co">#     runoff_input.mm = sum(runoff_input.mm, na.rm = TRUE),</span></span>
<span id="cb11-15"><a href="spatial-models-and-gis-integration.html#cb11-15" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb11-16"><a href="spatial-models-and-gis-integration.html#cb11-16" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-17"><a href="spatial-models-and-gis-integration.html#cb11-17" tabindex="-1"></a><span class="co"># indata_analysis</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="spatial-models-and-gis-integration.html#cb12-1" tabindex="-1"></a><span class="co"># # Your script below should fit your variables from your summary dataframe above. Here is an example of what a simple water balance might look like if I named my summary dataframe indata_analysis: </span></span>
<span id="cb12-2"><a href="spatial-models-and-gis-integration.html#cb12-2" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb12-3"><a href="spatial-models-and-gis-integration.html#cb12-3" tabindex="-1"></a><span class="co"># # Calculate the residual water after accounting for PET and discharge</span></span>
<span id="cb12-4"><a href="spatial-models-and-gis-integration.html#cb12-4" tabindex="-1"></a><span class="co"># residual_water &lt;- indata_analysis$runoff_input.mm - (indata_analysis$PET_mm_sum + indata_analysis$Q_mm_sum)</span></span>
<span id="cb12-5"><a href="spatial-models-and-gis-integration.html#cb12-5" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb12-6"><a href="spatial-models-and-gis-integration.html#cb12-6" tabindex="-1"></a><span class="co"># # View the residual for each year</span></span>
<span id="cb12-7"><a href="spatial-models-and-gis-integration.html#cb12-7" tabindex="-1"></a><span class="co"># print(residual_water)</span></span></code></pre></div>
<p>By subtracting discharge and PET from runoff_input, we’re essentially examining the residual water. This could represent the amount of water available to the system after accounting for the demand (PET) and the outflow (discharge).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="spatial-models-and-gis-integration.html#cb13-1" tabindex="-1"></a><span class="co"># # make long form with PETsum and Psum as the key-value pairs (exclude wtr_yr from )</span></span>
<span id="cb13-2"><a href="spatial-models-and-gis-integration.html#cb13-2" tabindex="-1"></a><span class="co"># dat_sum_plot &lt;- indata_analysis %&gt;%</span></span>
<span id="cb13-3"><a href="spatial-models-and-gis-integration.html#cb13-3" tabindex="-1"></a><span class="co">#   pivot_longer(names_to =  &quot;key&quot;, values_to =  &quot;value&quot;, -wtr_yr)</span></span>
<span id="cb13-4"><a href="spatial-models-and-gis-integration.html#cb13-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb13-5"><a href="spatial-models-and-gis-integration.html#cb13-5" tabindex="-1"></a><span class="co"># # bar plot pf PET and P for each year</span></span>
<span id="cb13-6"><a href="spatial-models-and-gis-integration.html#cb13-6" tabindex="-1"></a><span class="co"># ggplot(dat_sum_plot, aes(x = wtr_yr, y = value, fill = key)) +</span></span>
<span id="cb13-7"><a href="spatial-models-and-gis-integration.html#cb13-7" tabindex="-1"></a><span class="co">#   geom_bar(stat = &quot;identity&quot;, position = &quot;dodge&quot;) +</span></span>
<span id="cb13-8"><a href="spatial-models-and-gis-integration.html#cb13-8" tabindex="-1"></a><span class="co">#   labs(x = &quot;Water Year&quot;, y = &quot;mm/year&quot;, fill = {})</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="spatial-models-and-gis-integration.html#cb14-1" tabindex="-1"></a><span class="co"># </span><span class="al">###</span><span class="co"> TIMING</span></span>
<span id="cb14-2"><a href="spatial-models-and-gis-integration.html#cb14-2" tabindex="-1"></a><span class="co"># # create weekly means or totals for both time series and plot them together to determine the timing of each </span></span>
<span id="cb14-3"><a href="spatial-models-and-gis-integration.html#cb14-3" tabindex="-1"></a><span class="co"># dat_weekly &lt;- indata %&gt;%</span></span>
<span id="cb14-4"><a href="spatial-models-and-gis-integration.html#cb14-4" tabindex="-1"></a><span class="co">#   group_by(Week = week(date)) %&gt;%</span></span>
<span id="cb14-5"><a href="spatial-models-and-gis-integration.html#cb14-5" tabindex="-1"></a><span class="co">#   summarise(</span></span>
<span id="cb14-6"><a href="spatial-models-and-gis-integration.html#cb14-6" tabindex="-1"></a><span class="co">#     PET = sum(PET_mm), </span></span>
<span id="cb14-7"><a href="spatial-models-and-gis-integration.html#cb14-7" tabindex="-1"></a><span class="co">#     P = sum(runoff_input.mm)</span></span>
<span id="cb14-8"><a href="spatial-models-and-gis-integration.html#cb14-8" tabindex="-1"></a><span class="co">#     ) %&gt;%</span></span>
<span id="cb14-9"><a href="spatial-models-and-gis-integration.html#cb14-9" tabindex="-1"></a><span class="co">#     pivot_longer(names_to = &quot;key&quot;, values_to = &quot;value&quot;, -Week)</span></span>
<span id="cb14-10"><a href="spatial-models-and-gis-integration.html#cb14-10" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb14-11"><a href="spatial-models-and-gis-integration.html#cb14-11" tabindex="-1"></a><span class="co"># # line plot of P and PET on a weekly basis. Use dat_weekly as the data source.</span></span>
<span id="cb14-12"><a href="spatial-models-and-gis-integration.html#cb14-12" tabindex="-1"></a><span class="co"># ggplot(dat_weekly, aes(x = Week, y = value, color = key)) +</span></span>
<span id="cb14-13"><a href="spatial-models-and-gis-integration.html#cb14-13" tabindex="-1"></a><span class="co">#   geom_line() + # create line plot</span></span>
<span id="cb14-14"><a href="spatial-models-and-gis-integration.html#cb14-14" tabindex="-1"></a><span class="co">#   labs(x = &quot;Week of Year&quot;, y = &quot;mm/year&quot;, color = {})</span></span></code></pre></div>
<div id="single-model-run" class="section level4 hasAnchor" number="7.2.3.1">
<h4><span class="header-section-number">7.2.3.1</span> Single model run<a href="spatial-models-and-gis-integration.html#single-model-run" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Look at the parameters to make sure you know what each parameter does. The way the model is set up, is that everything is hidden inside a function. The user (–&gt; you) only formats the input data and passes the parameters to the function. All model output is contained in “modelRun”. If you look at the Environment, you will notice that modelRun is a list. A list is even more flexible in terms of data storage than a dataframe (a dataframe is actually a special type of list…). While lists are super flexible, they can also be more cumbersome to deal with. I included some code that takes the output from the model run and saves all the important bits and pieces in a convenient dataframe called HBVRun. For this part (single model runs), you will really only need the data contained in the HBVRun dataframe.</p>
</div>
<div id="single-model-execution" class="section level4 hasAnchor" number="7.2.3.2">
<h4><span class="header-section-number">7.2.3.2</span> single model execution<a href="spatial-models-and-gis-integration.html#single-model-execution" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="spatial-models-and-gis-integration.html#cb15-1" tabindex="-1"></a><span class="co"># # set up the parameter vector</span></span>
<span id="cb15-2"><a href="spatial-models-and-gis-integration.html#cb15-2" tabindex="-1"></a><span class="co"># model_params &lt;- c(</span></span>
<span id="cb15-3"><a href="spatial-models-and-gis-integration.html#cb15-3" tabindex="-1"></a><span class="co">#   1.05, # SCF snow correction factor [-] (e.g., 0.9-1.5);</span></span>
<span id="cb15-4"><a href="spatial-models-and-gis-integration.html#cb15-4" tabindex="-1"></a><span class="co">#   1.80, # DDF degree day factor [mm/degC/timestep] (e.g., 0.0-5.0 mm/degC/day);</span></span>
<span id="cb15-5"><a href="spatial-models-and-gis-integration.html#cb15-5" tabindex="-1"></a><span class="co">#   2, # Tr threshold temperature above which precipitation is rain [degC] (e.g., 1.0-3.0 degC);</span></span>
<span id="cb15-6"><a href="spatial-models-and-gis-integration.html#cb15-6" tabindex="-1"></a><span class="co">#   0, # Ts threshold temperature below which precipitation is snow [degC] (e.g., -3.0-1.0 degC);</span></span>
<span id="cb15-7"><a href="spatial-models-and-gis-integration.html#cb15-7" tabindex="-1"></a><span class="co">#   -0.336, # Tm threshold temperature above which melt starts [degC] (e.g., -2.0-2.0 degC);</span></span>
<span id="cb15-8"><a href="spatial-models-and-gis-integration.html#cb15-8" tabindex="-1"></a><span class="co">#   0.2, # LPrat parameter related to the limit for potential evaporation [-] (e.g., 0.0-1.0);</span></span>
<span id="cb15-9"><a href="spatial-models-and-gis-integration.html#cb15-9" tabindex="-1"></a><span class="co">#   121, # FC field capacity, i.e., max soil moisture storage [mm] (e.g., 0-600 mm);</span></span>
<span id="cb15-10"><a href="spatial-models-and-gis-integration.html#cb15-10" tabindex="-1"></a><span class="co">#   2.52, # BETA the non linear parameter for runoff production [-] (e.g., 0.0-20.0);</span></span>
<span id="cb15-11"><a href="spatial-models-and-gis-integration.html#cb15-11" tabindex="-1"></a><span class="co">#   0.473, # k0 storage coefficient for very fast response [timestep] (e.g., 0.0-2.0 days);</span></span>
<span id="cb15-12"><a href="spatial-models-and-gis-integration.html#cb15-12" tabindex="-1"></a><span class="co">#   9.06, # k1 storage coefficient for fast response [timestep] (e.g., 2.0-30.0 days);</span></span>
<span id="cb15-13"><a href="spatial-models-and-gis-integration.html#cb15-13" tabindex="-1"></a><span class="co">#   142, # k2 storage coefficient for slow response [timestep] (e.g., 30.0-250.0 days);</span></span>
<span id="cb15-14"><a href="spatial-models-and-gis-integration.html#cb15-14" tabindex="-1"></a><span class="co">#   50.1, # lsuz threshold storage state, i.e., the very fast response start if exceeded [mm] (e.g., 1.0-100.0 mm);</span></span>
<span id="cb15-15"><a href="spatial-models-and-gis-integration.html#cb15-15" tabindex="-1"></a><span class="co">#   2.38, # cperc constant percolation rate [mm/timestep] (e.g., 0.0-8.0 mm/day);</span></span>
<span id="cb15-16"><a href="spatial-models-and-gis-integration.html#cb15-16" tabindex="-1"></a><span class="co">#   10, # bmax maximum base at low flows [timestep] (e.g., 0.0-30.0 days);</span></span>
<span id="cb15-17"><a href="spatial-models-and-gis-integration.html#cb15-17" tabindex="-1"></a><span class="co">#   25 # croute free scaling parameter [timestep^2/mm] (e.g., 0.0-50.0 days^2/mm);</span></span>
<span id="cb15-18"><a href="spatial-models-and-gis-integration.html#cb15-18" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb15-19"><a href="spatial-models-and-gis-integration.html#cb15-19" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb15-20"><a href="spatial-models-and-gis-integration.html#cb15-20" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb15-21"><a href="spatial-models-and-gis-integration.html#cb15-21" tabindex="-1"></a><span class="co"># # set time period</span></span>
<span id="cb15-22"><a href="spatial-models-and-gis-integration.html#cb15-22" tabindex="-1"></a><span class="co"># model_in &lt;- indata %&gt;%</span></span>
<span id="cb15-23"><a href="spatial-models-and-gis-integration.html#cb15-23" tabindex="-1"></a><span class="co">#   filter(date &gt;= as_date(&quot;2017-10-01&quot;) &amp; date &lt;= as_date(&quot;2022-09-30&quot;))</span></span>
<span id="cb15-24"><a href="spatial-models-and-gis-integration.html#cb15-24" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb15-25"><a href="spatial-models-and-gis-integration.html#cb15-25" tabindex="-1"></a><span class="co"># # set up the model</span></span>
<span id="cb15-26"><a href="spatial-models-and-gis-integration.html#cb15-26" tabindex="-1"></a><span class="co"># ## THIS IS THE ACTUAL MODEL EXECUTION</span></span>
<span id="cb15-27"><a href="spatial-models-and-gis-integration.html#cb15-27" tabindex="-1"></a><span class="co"># modelRun &lt;- TUWmodel(</span></span>
<span id="cb15-28"><a href="spatial-models-and-gis-integration.html#cb15-28" tabindex="-1"></a><span class="co">#   prec = model_in$weighted_precip.mm, # precip input</span></span>
<span id="cb15-29"><a href="spatial-models-and-gis-integration.html#cb15-29" tabindex="-1"></a><span class="co">#   airt = model_in$Tmean_c, # air temp input</span></span>
<span id="cb15-30"><a href="spatial-models-and-gis-integration.html#cb15-30" tabindex="-1"></a><span class="co">#   ep = model_in$PET_mm, # pet input</span></span>
<span id="cb15-31"><a href="spatial-models-and-gis-integration.html#cb15-31" tabindex="-1"></a><span class="co">#   area = 1, # one zone for the entire watershed</span></span>
<span id="cb15-32"><a href="spatial-models-and-gis-integration.html#cb15-32" tabindex="-1"></a><span class="co">#   param = model_params # input model parameters</span></span>
<span id="cb15-33"><a href="spatial-models-and-gis-integration.html#cb15-33" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb15-34"><a href="spatial-models-and-gis-integration.html#cb15-34" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb15-35"><a href="spatial-models-and-gis-integration.html#cb15-35" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb15-36"><a href="spatial-models-and-gis-integration.html#cb15-36" tabindex="-1"></a><span class="co"># # get all outputs into a nice df</span></span>
<span id="cb15-37"><a href="spatial-models-and-gis-integration.html#cb15-37" tabindex="-1"></a><span class="co"># HBVRun &lt;- tibble(</span></span>
<span id="cb15-38"><a href="spatial-models-and-gis-integration.html#cb15-38" tabindex="-1"></a><span class="co">#   Date = model_in$Date, # date</span></span>
<span id="cb15-39"><a href="spatial-models-and-gis-integration.html#cb15-39" tabindex="-1"></a><span class="co">#   P_mm = modelRun$prec, # precip</span></span>
<span id="cb15-40"><a href="spatial-models-and-gis-integration.html#cb15-40" tabindex="-1"></a><span class="co">#   Tair = modelRun$airt, # air temp</span></span>
<span id="cb15-41"><a href="spatial-models-and-gis-integration.html#cb15-41" tabindex="-1"></a><span class="co">#   SWEobs = model_in$weighted_swe.mm, # observed swe</span></span>
<span id="cb15-42"><a href="spatial-models-and-gis-integration.html#cb15-42" tabindex="-1"></a><span class="co">#   PET = modelRun$ep,# pet</span></span>
<span id="cb15-43"><a href="spatial-models-and-gis-integration.html#cb15-43" tabindex="-1"></a><span class="co">#   Qobs = model_in$Q_mm_day, # observed discharge</span></span>
<span id="cb15-44"><a href="spatial-models-and-gis-integration.html#cb15-44" tabindex="-1"></a><span class="co">#   Qsim = modelRun$q[1, ], # simulated discharge</span></span>
<span id="cb15-45"><a href="spatial-models-and-gis-integration.html#cb15-45" tabindex="-1"></a><span class="co">#   Qsurf = modelRun$q0[1, ], # surface runoff</span></span>
<span id="cb15-46"><a href="spatial-models-and-gis-integration.html#cb15-46" tabindex="-1"></a><span class="co">#   Qsubsurf = modelRun$q1[1, ], # subsurface flow</span></span>
<span id="cb15-47"><a href="spatial-models-and-gis-integration.html#cb15-47" tabindex="-1"></a><span class="co">#   Qbase = modelRun$q2[1, ], # groundwater flow</span></span>
<span id="cb15-48"><a href="spatial-models-and-gis-integration.html#cb15-48" tabindex="-1"></a><span class="co">#   Rain = modelRun$rain[1, ], # simulated rain</span></span>
<span id="cb15-49"><a href="spatial-models-and-gis-integration.html#cb15-49" tabindex="-1"></a><span class="co">#   Snow = modelRun$snow[1, ], # simulated snowfall</span></span>
<span id="cb15-50"><a href="spatial-models-and-gis-integration.html#cb15-50" tabindex="-1"></a><span class="co">#   Melt = modelRun$melt[1, ], # simulated melt</span></span>
<span id="cb15-51"><a href="spatial-models-and-gis-integration.html#cb15-51" tabindex="-1"></a><span class="co">#   SWEsim = modelRun$swe[1, ], # simulated swe</span></span>
<span id="cb15-52"><a href="spatial-models-and-gis-integration.html#cb15-52" tabindex="-1"></a><span class="co">#   Soilmoist = modelRun$moist[1, ], # simulated soil storage</span></span>
<span id="cb15-53"><a href="spatial-models-and-gis-integration.html#cb15-53" tabindex="-1"></a><span class="co">#   AET = modelRun$eta[1, ], # simulated evapotranspiration</span></span>
<span id="cb15-54"><a href="spatial-models-and-gis-integration.html#cb15-54" tabindex="-1"></a><span class="co">#   StorageUpper = modelRun$suz[1, ], # upper storage value</span></span>
<span id="cb15-55"><a href="spatial-models-and-gis-integration.html#cb15-55" tabindex="-1"></a><span class="co">#   StorageLower = modelRun$slz[1, ] # lower storage value</span></span>
<span id="cb15-56"><a href="spatial-models-and-gis-integration.html#cb15-56" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div>
</div>
<div id="objective-functions" class="section level4 hasAnchor" number="7.2.3.3">
<h4><span class="header-section-number">7.2.3.3</span> Objective functions<a href="spatial-models-and-gis-integration.html#objective-functions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="kge" class="section level5 hasAnchor" number="7.2.3.3.1">
<h5><span class="header-section-number">7.2.3.3.1</span> KGE<a href="spatial-models-and-gis-integration.html#kge" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Before we can start trying to tune our model to look more like the
observed discharge record, it would be helpful to have some sort of
quantified metric for how well our modeled data fits the measured data.</p>
<p>There are many different ways to do this, but discussion of the pros and cons of those approaches is beyond this quick introduction to modeling.</p>
<p>Here we will demonstrate the Kling-Gupta efficiency both for runoff as well as for swe.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="spatial-models-and-gis-integration.html#cb16-1" tabindex="-1"></a><span class="co"># # select the Qobs and Qsim timeseries</span></span>
<span id="cb16-2"><a href="spatial-models-and-gis-integration.html#cb16-2" tabindex="-1"></a><span class="co"># # DON&#39;T FORGET TO EXCLUDE THE FIRST YEAR</span></span>
<span id="cb16-3"><a href="spatial-models-and-gis-integration.html#cb16-3" tabindex="-1"></a><span class="co"># Qobs &lt;- HBVRun$Qobs[366:length(HBVRun$Qobs)] # observed runoff WITHOUT WARM-UP PERIOD</span></span>
<span id="cb16-4"><a href="spatial-models-and-gis-integration.html#cb16-4" tabindex="-1"></a><span class="co"># Qsim &lt;- HBVRun$Qsim[366:length(HBVRun$Qsim)] # simulated runoff WITHOUT WARM-UP PERIOD</span></span>
<span id="cb16-5"><a href="spatial-models-and-gis-integration.html#cb16-5" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb16-6"><a href="spatial-models-and-gis-integration.html#cb16-6" tabindex="-1"></a><span class="co"># # KGE</span></span>
<span id="cb16-7"><a href="spatial-models-and-gis-integration.html#cb16-7" tabindex="-1"></a><span class="co"># kge_r_q &lt;- cor(Qobs, Qsim)</span></span>
<span id="cb16-8"><a href="spatial-models-and-gis-integration.html#cb16-8" tabindex="-1"></a><span class="co"># kge_beta_q &lt;- mean(Qsim) / mean(Qobs)</span></span>
<span id="cb16-9"><a href="spatial-models-and-gis-integration.html#cb16-9" tabindex="-1"></a><span class="co"># kge_gamma_q &lt;- (sd(Qsim) / mean(Qsim)) / (sd(Qobs) / mean(Qobs))</span></span>
<span id="cb16-10"><a href="spatial-models-and-gis-integration.html#cb16-10" tabindex="-1"></a><span class="co"># kge_q &lt;- 1 - sqrt((kge_r_q - 1)^2 + (kge_beta_q - 1)^2 + (kge_gamma_q - 1)^2)</span></span>
<span id="cb16-11"><a href="spatial-models-and-gis-integration.html#cb16-11" tabindex="-1"></a><span class="co"># kge_q</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="spatial-models-and-gis-integration.html#cb17-1" tabindex="-1"></a><span class="co"># ## Snow - water equivalent</span></span>
<span id="cb17-2"><a href="spatial-models-and-gis-integration.html#cb17-2" tabindex="-1"></a><span class="co"># SWEobs &lt;- HBVRun$SWEobs[366:length(HBVRun$SWEobs)] # observed swe WITHOUT WARM-UP PERIOD</span></span>
<span id="cb17-3"><a href="spatial-models-and-gis-integration.html#cb17-3" tabindex="-1"></a><span class="co"># SWEsim &lt;- HBVRun$SWEsim[366:length(HBVRun$SWEobs)] # simulated swe WITHOUT WARM-UP PERIOD</span></span>
<span id="cb17-4"><a href="spatial-models-and-gis-integration.html#cb17-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb17-5"><a href="spatial-models-and-gis-integration.html#cb17-5" tabindex="-1"></a><span class="co"># # KGE</span></span>
<span id="cb17-6"><a href="spatial-models-and-gis-integration.html#cb17-6" tabindex="-1"></a><span class="co"># kge_r_swe &lt;- cor(SWEobs, SWEsim)</span></span>
<span id="cb17-7"><a href="spatial-models-and-gis-integration.html#cb17-7" tabindex="-1"></a><span class="co"># kge_beta_swe &lt;- mean(SWEsim) / mean(SWEobs)</span></span>
<span id="cb17-8"><a href="spatial-models-and-gis-integration.html#cb17-8" tabindex="-1"></a><span class="co"># kge_gamma_swe &lt;- (sd(SWEsim) / mean(SWEsim)) / (sd(SWEobs) / mean(SWEobs))</span></span>
<span id="cb17-9"><a href="spatial-models-and-gis-integration.html#cb17-9" tabindex="-1"></a><span class="co"># kge_swe &lt;- 1 - sqrt((kge_r_swe - 1)^2 + (kge_beta_swe - 1)^2 + (kge_gamma_swe - 1)^2)</span></span>
<span id="cb17-10"><a href="spatial-models-and-gis-integration.html#cb17-10" tabindex="-1"></a><span class="co"># kge_swe</span></span></code></pre></div>
</div>
<div id="nash-sutcliffe-efficiency-nse." class="section level5 hasAnchor" number="7.2.3.3.2">
<h5><span class="header-section-number">7.2.3.3.2</span> Nash-Sutcliffe Efficiency (NSE).<a href="spatial-models-and-gis-integration.html#nash-sutcliffe-efficiency-nse." class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Basically, the NSE looks at how much better your model run did that if you had just used the mean discharge for the data record as your “modelled results”. It does this by comparing how far off the observed values where from the mean discharge to how far off the modeled values were from the observed discharge. –&gt;
Mathematically, NSE is the sum of the squared differences between the modeled and observed discharge divided by the sum of the squared differences between the observed and mean discharge, subtracted by 1.</p>
<p><span class="math display">\[ NSE = 1 - \frac{\sum_{t = 1}^{T}{(Q_m^t - Q_o^t)^2}}{\sum_{t = 1}^{T}{(Q_o^t - \bar{Q_o})^2}}
\]</span>
Where <span class="math inline">\(Q_m^t\)</span> is modeled discharge at time t, <span class="math inline">\(Q_o^t\)</span> is observed</p>
<p>discharge at time t, and <span class="math inline">\(\bar{Q_o}\)</span> is mean observed discharge.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="spatial-models-and-gis-integration.html#cb18-1" tabindex="-1"></a><span class="co"># #Calculate NSE for snow, SWE is modeled, STA2 is measured</span></span>
<span id="cb18-2"><a href="spatial-models-and-gis-integration.html#cb18-2" tabindex="-1"></a><span class="co"># NSE_Q &lt;- 1 - ((sum((HBVRun$Qobs - HBVRun$Qsim) ^ 2)) / </span></span>
<span id="cb18-3"><a href="spatial-models-and-gis-integration.html#cb18-3" tabindex="-1"></a><span class="co">#                  sum((HBVRun$Qsim - mean(HBVRun$Qsim)) ^ 2))</span></span>
<span id="cb18-4"><a href="spatial-models-and-gis-integration.html#cb18-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb18-5"><a href="spatial-models-and-gis-integration.html#cb18-5" tabindex="-1"></a><span class="co"># NSE_Q</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="spatial-models-and-gis-integration.html#cb19-1" tabindex="-1"></a><span class="co"># #Calculate NSE for snow, SWE is modeled, STA2 is measured</span></span>
<span id="cb19-2"><a href="spatial-models-and-gis-integration.html#cb19-2" tabindex="-1"></a><span class="co"># NSEsno &lt;- 1 - ((sum((HBVRun$SWEobs - HBVRun$SWEsim) ^ 2)) / </span></span>
<span id="cb19-3"><a href="spatial-models-and-gis-integration.html#cb19-3" tabindex="-1"></a><span class="co">#                  sum((HBVRun$SWEsim - mean(HBVRun$SWEsim)) ^ 2))</span></span>
<span id="cb19-4"><a href="spatial-models-and-gis-integration.html#cb19-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb19-5"><a href="spatial-models-and-gis-integration.html#cb19-5" tabindex="-1"></a><span class="co"># NSEsno</span></span></code></pre></div>
</div>
</div>
<div id="calibrate-hbv-manually" class="section level4 hasAnchor" number="7.2.3.4">
<h4><span class="header-section-number">7.2.3.4</span> Calibrate HBV manually<a href="spatial-models-and-gis-integration.html#calibrate-hbv-manually" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Woohoo! We can now run our model and assess how well it is working!</p>
<p>Now, let’s see how well we can get it to work. The code below runs the model, produces a plot, and calculates the NSE based on discharge.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="spatial-models-and-gis-integration.html#cb20-1" tabindex="-1"></a><span class="co"># #when this term = 1, then triangular routing is invoked, or for no routing, routing = 0</span></span>
<span id="cb20-2"><a href="spatial-models-and-gis-integration.html#cb20-2" tabindex="-1"></a><span class="co"># #if routing = 0 then MAXBAS doesn&#39;t do anything</span></span>
<span id="cb20-3"><a href="spatial-models-and-gis-integration.html#cb20-3" tabindex="-1"></a><span class="co"># routing &lt;- 0      </span></span>
<span id="cb20-4"><a href="spatial-models-and-gis-integration.html#cb20-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-5"><a href="spatial-models-and-gis-integration.html#cb20-5" tabindex="-1"></a><span class="co"># #hard code parameters </span></span>
<span id="cb20-6"><a href="spatial-models-and-gis-integration.html#cb20-6" tabindex="-1"></a><span class="co"># params &lt;- c(40,     #FCM ax soil moisture storage, field capacity</span></span>
<span id="cb20-7"><a href="spatial-models-and-gis-integration.html#cb20-7" tabindex="-1"></a><span class="co">#             1,      #beta Shape coefficient governing fate of water input to soil moisture storage</span></span>
<span id="cb20-8"><a href="spatial-models-and-gis-integration.html#cb20-8" tabindex="-1"></a><span class="co">#             0.3,    #LP Threshold for reduction of evap</span></span>
<span id="cb20-9"><a href="spatial-models-and-gis-integration.html#cb20-9" tabindex="-1"></a><span class="co">#             0.4,    #SFCF Snowfall correction factor</span></span>
<span id="cb20-10"><a href="spatial-models-and-gis-integration.html#cb20-10" tabindex="-1"></a><span class="co">#             -1.5,   #TT Threshold temperature</span></span>
<span id="cb20-11"><a href="spatial-models-and-gis-integration.html#cb20-11" tabindex="-1"></a><span class="co">#             1,      #CFMAX Degree-day factor</span></span>
<span id="cb20-12"><a href="spatial-models-and-gis-integration.html#cb20-12" tabindex="-1"></a><span class="co">#             0.05,   #k0 Recession constant (upper storage, near surface)</span></span>
<span id="cb20-13"><a href="spatial-models-and-gis-integration.html#cb20-13" tabindex="-1"></a><span class="co">#             0.01,   #k1 Recession constant (upper storage)</span></span>
<span id="cb20-14"><a href="spatial-models-and-gis-integration.html#cb20-14" tabindex="-1"></a><span class="co">#             0.001,  #k2 Recession constant (lower storage)</span></span>
<span id="cb20-15"><a href="spatial-models-and-gis-integration.html#cb20-15" tabindex="-1"></a><span class="co">#             0,      #UZL Threshold for shallow storage</span></span>
<span id="cb20-16"><a href="spatial-models-and-gis-integration.html#cb20-16" tabindex="-1"></a><span class="co">#             0,      #PERC Percolation, max flow from upper to lower storage</span></span>
<span id="cb20-17"><a href="spatial-models-and-gis-integration.html#cb20-17" tabindex="-1"></a><span class="co">#             1       #MAXBAS base of the triangular routing function, days</span></span>
<span id="cb20-18"><a href="spatial-models-and-gis-integration.html#cb20-18" tabindex="-1"></a><span class="co">#             )</span></span>
<span id="cb20-19"><a href="spatial-models-and-gis-integration.html#cb20-19" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-20"><a href="spatial-models-and-gis-integration.html#cb20-20" tabindex="-1"></a><span class="co"># #Run the model</span></span>
<span id="cb20-21"><a href="spatial-models-and-gis-integration.html#cb20-21" tabindex="-1"></a><span class="co"># Out &lt;- HBV(params, P, Temp, PET, routing)</span></span>
<span id="cb20-22"><a href="spatial-models-and-gis-integration.html#cb20-22" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-23"><a href="spatial-models-and-gis-integration.html#cb20-23" tabindex="-1"></a><span class="co"># #Add observed output</span></span>
<span id="cb20-24"><a href="spatial-models-and-gis-integration.html#cb20-24" tabindex="-1"></a><span class="co"># Out &lt;- bind_cols(Out, Qobs1)</span></span>
<span id="cb20-25"><a href="spatial-models-and-gis-integration.html#cb20-25" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-26"><a href="spatial-models-and-gis-integration.html#cb20-26" tabindex="-1"></a><span class="co"># #Trim out the warm up period</span></span>
<span id="cb20-27"><a href="spatial-models-and-gis-integration.html#cb20-27" tabindex="-1"></a><span class="co"># OutTrim &lt;- filter(Out, DATE &gt;= mdy(&quot;01-01-2011&quot;))</span></span>
<span id="cb20-28"><a href="spatial-models-and-gis-integration.html#cb20-28" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-29"><a href="spatial-models-and-gis-integration.html#cb20-29" tabindex="-1"></a><span class="co"># #Calculate NSE</span></span>
<span id="cb20-30"><a href="spatial-models-and-gis-integration.html#cb20-30" tabindex="-1"></a><span class="co"># NSE &lt;- 1 - ((sum((OutTrim$q - OutTrim$WS_3) ^ 2)) / </span></span>
<span id="cb20-31"><a href="spatial-models-and-gis-integration.html#cb20-31" tabindex="-1"></a><span class="co">#                  sum((OutTrim$WS_3 - mean(OutTrim$WS_3)) ^ 2))</span></span>
<span id="cb20-32"><a href="spatial-models-and-gis-integration.html#cb20-32" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-33"><a href="spatial-models-and-gis-integration.html#cb20-33" tabindex="-1"></a><span class="co"># #Create plot with NSE in title</span></span>
<span id="cb20-34"><a href="spatial-models-and-gis-integration.html#cb20-34" tabindex="-1"></a><span class="co"># OutTrim %&gt;% plot_ly(x = ~DATE) %&gt;% </span></span>
<span id="cb20-35"><a href="spatial-models-and-gis-integration.html#cb20-35" tabindex="-1"></a><span class="co">#         add_trace(y = ~q, name = &#39;Modeled&#39;,  type = &#39;scatter&#39;, mode = &#39;lines&#39;) %&gt;% </span></span>
<span id="cb20-36"><a href="spatial-models-and-gis-integration.html#cb20-36" tabindex="-1"></a><span class="co">#         add_trace(y = ~WS_3, name = &#39;Measured&#39;, type = &#39;scatter&#39;, mode = &#39;lines&#39;) %&gt;% </span></span>
<span id="cb20-37"><a href="spatial-models-and-gis-integration.html#cb20-37" tabindex="-1"></a><span class="co">#         layout(title=paste(&quot;NSE: &quot;, round(NSE,2)))</span></span></code></pre></div>
</div>
<div id="plot-observed-and-model-simulations" class="section level4 hasAnchor" number="7.2.3.5">
<h4><span class="header-section-number">7.2.3.5</span> Plot observed and model simulations<a href="spatial-models-and-gis-integration.html#plot-observed-and-model-simulations" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Generate plots that include and compare the different modeled fluxes from your best NSE. Some of those fluxes can be immediately compared to observed data (e.g., runoff or SWE), while others only exist in simulated form (e.g., storages or outflows of the various runoff components) and need to be assessed with the perceptual model in mind.<br />
Make sure that the axes are properly labeled when you create plots. The script below will get you started.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="spatial-models-and-gis-integration.html#cb21-1" tabindex="-1"></a><span class="co"># # Add date to the HBVRun result tibble</span></span>
<span id="cb21-2"><a href="spatial-models-and-gis-integration.html#cb21-2" tabindex="-1"></a><span class="co"># HBVRun &lt;- as.data.frame(HBVRun)</span></span>
<span id="cb21-3"><a href="spatial-models-and-gis-integration.html#cb21-3" tabindex="-1"></a><span class="co"># HBVRun$Date &lt;- model_in$date</span></span>
<span id="cb21-4"><a href="spatial-models-and-gis-integration.html#cb21-4" tabindex="-1"></a><span class="co"># str(HBVRun)</span></span>
<span id="cb21-5"><a href="spatial-models-and-gis-integration.html#cb21-5" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-6"><a href="spatial-models-and-gis-integration.html#cb21-6" tabindex="-1"></a><span class="co"># # Overall runoff (Qsim and Qobs)</span></span>
<span id="cb21-7"><a href="spatial-models-and-gis-integration.html#cb21-7" tabindex="-1"></a><span class="co"># q_plot &lt;- ggplot(data = HBVRun) +</span></span>
<span id="cb21-8"><a href="spatial-models-and-gis-integration.html#cb21-8" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = Qobs, color = &quot;Qobs&quot;)) + # Qobs</span></span>
<span id="cb21-9"><a href="spatial-models-and-gis-integration.html#cb21-9" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = Qsim, color = &quot;Qsim&quot;)) + # Qsim</span></span>
<span id="cb21-10"><a href="spatial-models-and-gis-integration.html#cb21-10" tabindex="-1"></a><span class="co">#   labs(x = {}, y = &quot;Q (mm/day)&quot;, color = {}, title = &quot;Qobs and Qsim&quot;)</span></span>
<span id="cb21-11"><a href="spatial-models-and-gis-integration.html#cb21-11" tabindex="-1"></a><span class="co"># ggplotly(q_plot)</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="spatial-models-and-gis-integration.html#cb22-1" tabindex="-1"></a><span class="co"># Swe</span></span>
<span id="cb22-2"><a href="spatial-models-and-gis-integration.html#cb22-2" tabindex="-1"></a><span class="co"># swe_plot &lt;- ggplot(data = HBVRun) +</span></span>
<span id="cb22-3"><a href="spatial-models-and-gis-integration.html#cb22-3" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = SWEobs, color = &quot;SWEobs&quot;)) + # SWEobs</span></span>
<span id="cb22-4"><a href="spatial-models-and-gis-integration.html#cb22-4" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = SWEsim, color = &quot;SWEsim&quot;)) + # SWEsim</span></span>
<span id="cb22-5"><a href="spatial-models-and-gis-integration.html#cb22-5" tabindex="-1"></a><span class="co">#   labs(x = {}, y = &quot;SWE (mm)&quot;, color = {})</span></span>
<span id="cb22-6"><a href="spatial-models-and-gis-integration.html#cb22-6" tabindex="-1"></a><span class="co"># ggplotly(swe_plot)</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="spatial-models-and-gis-integration.html#cb23-1" tabindex="-1"></a><span class="co"># q_bucket_plot &lt;- ggplot(data = HBVRun) +</span></span>
<span id="cb23-2"><a href="spatial-models-and-gis-integration.html#cb23-2" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = Qsurf, color = &quot;Qsurf&quot;)) + # Qsurf</span></span>
<span id="cb23-3"><a href="spatial-models-and-gis-integration.html#cb23-3" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = Qsubsurf, color = &quot;Qsubsurf&quot;)) + #Qsubsurf</span></span>
<span id="cb23-4"><a href="spatial-models-and-gis-integration.html#cb23-4" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = Qbase, color = &quot;Qbase&quot;)) + # Qbase</span></span>
<span id="cb23-5"><a href="spatial-models-and-gis-integration.html#cb23-5" tabindex="-1"></a><span class="co">#   labs(x = {}, y = &quot;Q (mm)&quot;, color = {}, title = &quot;Q0, Q1, and Q2&quot;)</span></span>
<span id="cb23-6"><a href="spatial-models-and-gis-integration.html#cb23-6" tabindex="-1"></a><span class="co"># ggplotly(q_bucket_plot)</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="spatial-models-and-gis-integration.html#cb24-1" tabindex="-1"></a><span class="co"># # PET and AET</span></span>
<span id="cb24-2"><a href="spatial-models-and-gis-integration.html#cb24-2" tabindex="-1"></a><span class="co"># pet_plot &lt;- ggplot(data = HBVRun) +</span></span>
<span id="cb24-3"><a href="spatial-models-and-gis-integration.html#cb24-3" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = PET, color = &quot;PET&quot;)) + # PET</span></span>
<span id="cb24-4"><a href="spatial-models-and-gis-integration.html#cb24-4" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = AET, color = &quot;AET&quot;)) + # AET</span></span>
<span id="cb24-5"><a href="spatial-models-and-gis-integration.html#cb24-5" tabindex="-1"></a><span class="co">#   labs(x = {}, y = &quot;Flux (mm)&quot;, color = {}, title = &quot;PET and AET&quot;)</span></span>
<span id="cb24-6"><a href="spatial-models-and-gis-integration.html#cb24-6" tabindex="-1"></a><span class="co"># ggplotly(pet_plot)</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="spatial-models-and-gis-integration.html#cb25-1" tabindex="-1"></a><span class="co"># # Storages</span></span>
<span id="cb25-2"><a href="spatial-models-and-gis-integration.html#cb25-2" tabindex="-1"></a><span class="co"># storage_plot &lt;- ggplot(data = HBVRun) +</span></span>
<span id="cb25-3"><a href="spatial-models-and-gis-integration.html#cb25-3" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = Soilmoist, color = &quot;Soil moisture storage&quot;)) + # soil moisture storage</span></span>
<span id="cb25-4"><a href="spatial-models-and-gis-integration.html#cb25-4" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = StorageUpper, color = &quot;Upper storage&quot;)) + # upper storage</span></span>
<span id="cb25-5"><a href="spatial-models-and-gis-integration.html#cb25-5" tabindex="-1"></a><span class="co">#   geom_line(aes(x = Date, y = StorageLower, color = &quot;Lower storage&quot;)) + # lower storage</span></span>
<span id="cb25-6"><a href="spatial-models-and-gis-integration.html#cb25-6" tabindex="-1"></a><span class="co">#   labs(x = {}, y = &quot;Storage (mm)&quot;, color = {}, title = &quot;Storages&quot;)</span></span>
<span id="cb25-7"><a href="spatial-models-and-gis-integration.html#cb25-7" tabindex="-1"></a><span class="co"># ggplotly(storage_plot)</span></span></code></pre></div>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="physical-process-models.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/tpcovino/lres_546_bookdown/edit/main/13_dem_preprocessing.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": "https://github.com/tpcovino/lres_546_bookdown/blob/main/13_dem_preprocessing.Rmd",
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
