# Process-Based Modeling - Probabilistic and Process Simulation
\* Modules 4.1 and 4.2 are adapted from Fabian Nipggen (REWM.4500.500)\

## Transfer function rainfall-runoff models 

### Learning Module 4

#### Summary

In previous modules, we focused on *where* water goes in a watershed and whether it runs off quickly as stormflow or moves slowly through storage and contributes to baseflow. In this module, we shift focus to *when* water arrives at the stream.

Why does timing matter?

 * Water that moves quickly tends to look chemically different than water that moves slowly

 * Longer travel times allow for more uptake by vegetation or interaction with soils, minerals, and microbes 

 * The timing of runoff shapes the hydrograph and affects solute transport

In this module, we will model the temporal aspects of runoff response to input using a transfer function. A transfer function is a tool that describes how rainfall input is translated into runoff output over time. 

##### Overall Learning Objectives
By the end of this module, you should be able to:

 * Explain what a transfer function is in plain language

 * Describe how water transit time influences runoff timing and composition

 * Recognize different ways transit time can be represented in hydrological models

 * Interpret (not derive) the basic equations used in transfer-function rainfall–runoff models
 
##### Key Terms
In modeling a flow system, note that consideration of time may vary depending on the questions being asked. **Transit time** is the average time required for water to travel through the entire flow system, from input (e.g., rainfall on soil surface) to output (e.g., discharge). **Residence time** is a portion of transit time, describing the amount of time water spends within a specific component of the flow system, like storage (e.g., in soil, groundwater, a puddle or a lake). 

First, familiarize yourself with the transfer function we will code (TRANSEP) by reading this paper. If the terminology feels dense, you may use AI tools to help extract the key concepts and focus on the big-picture ideas: <br/>
[TRANSEP - a combined tracer and runoff transfer function hydrograph separation model](docs/Weiler_etal_WRR2003.pdf)
<br/>

Then this text will step through key concepts in the paper to facilitate hands-on exploration of the rainfall-runoff portion of the TRANSEP model in the assessment. 

![Figure 6.3. Conceptual diagram of the lumped parameter transit time modeling approach (McGuire & McDonnell, 2006)](https://ars.els-cdn.com/content/image/1-s2.0-S0022169406002150-gr1.jpg)

<br/><br/>

A **transfer function** (TF) is a mathematical representation of how a system responds to input signals. In a hydrological context, it describes the transformation of inputs (e.g. precipitation) to outputs (e.g. runoff). In other words, it is a mathematical way of answering the question: 
If water enters the watershed at time t, how much of it shows up at the stream later and when?

##### The Linear Time-Invariant TF

We start with a linear, time-invariant (LTI) system. The name sounds extravagant, but the assumptions are simple:

1. Linear: Double the rainfall → double the runoff response

2. Time-invariant: The watershed responds the same way today as it did yesterday

3. Additive: Responses from multiple rainfall pulses add together

Under these assumptions, we can represent the watershed as a **linear reservoir**. Linear reservoirs are simple models designed to simulate the storage and discharge of water in a catchment. These models assume that the catchment can be represented as single storage compartments and that

1. Water is stored temporarily
2. the rate of outflow is porportional to how much water is stored
3. there is no threshold behavior or [hysteresis. external link](https://lewis-thehydrologist.medium.com/understanding-river-hysteresis-3a6bb454add4)

Recall this isn't how all watersheds work, these are useful approximations. 

![](images/linear_storage_04.png)

<br/><br/>

##### The Instantaneous Unit Hydrograph: 

The Instantaneous Unit Hydrograph (IUH) is the transfer function used in the TRANSEP model. It is an approach to hydrograph separation that is useful for analyzing the temporal distribution of runoff in response to a 'unit' pulse of rainfall (e.g. uniform one-mm depth over a unit area represented by a unit hydrograph). In other words, it answers the question: If one unit of effective rainfall fell instantly over the watershed, how would that water be released to the stream over time?
Therefore, the following assumptions are made when the IUH is used as a transfer function: <br/>

1. the watershed response reflects the ensemble of watershed characteristics <br/>
2. the response shape does not change through time <br/>
3. the output response is linearly proportional to the input (i.e. runoff of scales linearly with rainfall) <br/>

The IUH is not a specific storm, rather it is a response kernel that we reuse for all storms.

<br/><br/>

![Chow, V.T., Maidment, D.R. and Mays, L.W. (1988) Applied Hydrology. International Edition, McGraw-Hill Book Company, New York.](images/linear_vs_IUH.png)
<br/><br/>

#### From Concept to Math
Don't worry about deriving or memorizing the following equations; they are included only to help you understand the relationships among variables and reinforce the underlying concepts.

##### IUH
In TRANSEP, the IUH is written as a function \(g(\tau)\). This function describes how runoff is distributed through time after rainfall occurs.

$$
g(\tau) = \frac{\tau^{\alpha-1}}{\mathrm{B}^{\alpha}\Gamma(\alpha)}exp(-\frac{\tau}{\alpha})
$$
<br/><br/>
What matters here is that:

 * The shape of \(g(\tau)\) controls how fast or slow water moves

 * Parameters change whether runoff is flashy or delayed

 * The function integrates to 1 (mass is conserved)
 
##### Convolution: Turning Rainfall into Runoff

Runoff is calculated by combining rainfall with the transfer function:

$$ 
Q(t)= \int_{0}^{t} g(\tau)p_{\text{eff}}(t-\tau)d\tau
$$
<br/><br/>

Runoff at time t is the sum of past rainfall inputs, each delayed and weighted by the transfer function.

OK, I realize your eyes probably glazed over somewhere around 'convolution'... don't worry about the details of the equations. Check out this video to have convolution described using dollars and cookies, then imagine each dollar as a rainfall unit and each cookie as a runoff unit. Review the equations again after the video.

<br/><br/>

```{r}
knitr::include_url("https://www.youtube.com/embed/aEGboJxmq-w")
```

##### The Loss Function: 

Not all rainfall contributes to runoff. Some is lost to infiltration, evaporation, or temporary storage.

The loss function represents the linear rainfall-runoff model used in the TRANSEP model. In other words, it converts total preciptiation \(p(t)\) into effective precipitation \(p_{\text{eff}}(t)\).

$$
s(t) = b_{1} p(t + 1 - b_{2}^{-1}) s(t - \triangle t) 
$$
$$
s(t = 0) = b_{3} 
$$
$$
p_{\text{eff}}(t) = p(t) s(t) 
$$
where \(p_{\text{eff}}(t)\) is the effective precipitation.<br/>
\(s(t)\) is the antecedent precipitation index which is determined by giving more importance to recent precipitation and gradually reducing that importance as we go back in time (i.e. recent rainfall matters more than old rainfall). <br/>
The rate at which this importance decreases is controlled by the parameter \(b_{2}\). <br/>
The parameter \(b_{3}\) sets the initial antecedent precipitation index at the beginning of the simulated time series. 

Again: the goal is behavior, not physical realism.

Transfer-function models are powerful because they:

 * Explicitly represent timing, not just volume

 * Allow separation of rainfall input and watershed response

 * Provide a bridge between hydrology and tracer studies

They are also limited:

 * They assume linearity

 * They hide spatial heterogeneity

 * They trade physical detail for interpretability

Understanding these tradeoffs is more important than memorizing equations.

##### How do we code this?

We will use a skeletal version of TRANSEP, focusing only on the rainfall-runoff piece which includes the loss-function and the gamma transfer function. 

We will use rainfall and runoff data from the Tenderfoot Creek Experimental Forest to model annual streamflow at a daily time step. Then we can use this model as a jump-off point to start talking about model calibration and validation in future modules.

##### Final thoughts:

If during your modeling experience, you find yourself wading through a bog of complex physics and multiple layers of transfer functions to account for every drop of input into a system, it is time to revisit your objectives. Remember that a model is always 'wrong', but it can help us understand complex systems, make predictions, and gain insights even if they are not an exact replica of the real world. Check out this paper for more:

https://agupubs.onlinelibrary.wiley.com/doi/10.1029/93WR00877

### Repo link
[Download the repo for this lab HERE](https://github.com/tpcovino/04_transfer_functions.git){target="_blank"}

